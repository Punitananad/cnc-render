<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AI Delivery Position Manager</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif}
    body{background:linear-gradient(135deg,#0a0e21,#1a2a6c,#2d1a6c);color:#f0f0f0;min-height:100vh;padding:20px}
    .container{max-width:1400px;margin:0 auto}
    header{display:flex;justify-content:space-between;align-items:center;padding:20px;background:rgba(255,255,255,.1);border-radius:10px;box-shadow:0 4px 15px rgba(0,0,0,.3);margin-bottom:20px;backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.1)}
    .stock-info{display:flex;align-items:center}
    .stock-icon{width:50px;height:50px;background:linear-gradient(135deg,#4e54c8,#8f94fb);color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;margin-right:15px;font-size:24px}
    .stock-details h1{color:#fff;font-size:28px}
    .stock-details p{color:#aaa}
    .live-price{text-align:right}
    .price{font-size:32px;font-weight:700;color:#fff}
    .change{font-size:18px;font-weight:700}
    .positive{color:#4cd964}.negative{color:#ff3b30}
    .dashboard{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px}
    .card{background:rgba(255,255,255,.1);border-radius:10px;padding:20px;box-shadow:0 4px 15px rgba(0,0,0,.3);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.1);transition:all 0.3s ease}
    .card.ai-active{grid-column:1 / span 2}
    .card h2{color:#fff;margin-bottom:15px;padding-bottom:10px;border-bottom:2px solid rgba(255,255,255,.2);display:flex;align-items:center;gap:10px}

    .stats{display:grid;gap:15px;text-align:center}
    .stat-item{padding:15px;background:rgba(255,255,255,.1);border-radius:8px}
    .stat-value{font-size:24px;font-weight:700;color:#fff}
    .stat-label{font-size:14px;color:#aaa}

    .actions{display:flex;gap:10px;justify-content:center}
    button{background:linear-gradient(135deg,#4e54c8,#8f94fb);color:#fff;border:none;padding:12px 20px;border-radius:5px;cursor:pointer;font-size:16px;font-weight:600;transition:all 0.3s ease}
    button:hover{background:linear-gradient(135deg,#3a3f99,#6f73d9);transform:translateY(-2px);box-shadow:0 4px 8px rgba(0,0,0,.3)}
    .btn-sell{background:linear-gradient(135deg,#ff416c,#ff4b2b)}.btn-sell:hover{background:linear-gradient(135deg,#e73c64,#e64527)}
    .btn-ai{background:linear-gradient(135deg,#00b09b,#96c93d)}.btn-ai:hover{background:linear-gradient(135deg,#009a7a,#85b536)}
    .btn-back{background:linear-gradient(135deg,#6a11cb,#2575fc)}.btn-back:hover{background:linear-gradient(135deg,#5a0db9,#1f67e6)}

    .hidden{display:none}
    .history-entry{background:rgba(255,255,255,.1);border-left:4px solid #4e54c8;border-radius:8px;padding:12px;margin-bottom:10px}
    .tiny-link{font-size:12px;color:#4e54c8;background:rgba(255,255,255,.2);border:1px solid rgba(255,255,255,.1);padding:4px 8px;border-radius:6px;cursor:pointer;transition:all 0.3s ease}
    .tiny-link:hover{background:rgba(255,255,255,.3);transform:translateY(-1px)}
    #deleteTemplateBtn{background:rgba(255,59,48,.2);color:#ff3b30;border:1px solid rgba(255,59,48,.3)}
    #deleteTemplateBtn:hover{background:rgba(255,59,48,.3)}
    #saveTemplateBtn{background:rgba(76,217,100,.2);color:#4cd964;border:1px solid rgba(76,217,100,.3)}
    #saveTemplateBtn:hover{background:rgba(76,217,100,.3)}

    .form-row{display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:16px}
    .form-group{background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.1);border-radius:8px;padding:12px}
    .form-group label{display:block;font-weight:600;color:#ddd;margin-bottom:6px}
    .form-group input[type="number"],.form-group input[type="text"]{width:100%;padding:12px;border:1px solid rgba(255,255,255,.2);border-radius:8px;background:rgba(0,0,0,.2);color:#fff}

    .trade-badge{font-weight:700;padding:8px 12px;border-radius:999px;display:inline-block}
    .badge-buy{background:rgba(76,217,100,.2);color:#4cd964;border:1px solid rgba(76,217,100,.3)}
    .badge-sell{background:rgba(255,59,48,.2);color:#ff3b30;border:1px solid rgba(255,59,48,.3)}

    .tiles{grid-template-columns:repeat(4,1fr)}
    @media (max-width:900px){ .tiles{grid-template-columns:repeat(2,1fr)} }
    @media (max-width:520px){ .tiles{grid-template-columns:1fr} }

    .select{width:100%;padding:10px 12px;border:1px solid rgba(255,255,255,.2);border-radius:6px;background:rgba(0,0,0,.2);color:#fff}
    .selector-row{display:flex;gap:12px;align-items:center}
    .split-options{display:flex;flex-wrap:wrap;gap:14px;margin-top:14px}
    .split-option{flex:1;min-width:220px;background:rgba(255,255,255,.1);border-radius:10px;padding:16px;border:1px solid rgba(255,255,255,.1);text-align:center;cursor:pointer;transition:all 0.3s ease}
    .split-option:hover{transform:translateY(-5px);box-shadow:0 5px 15px rgba(0,0,0,.3);background:rgba(255,255,255,.15)}
    .split-option h3{color:#fff;margin-bottom:8px;font-size:1rem}
    .split-option p{color:#aaa;font-size:.9rem;margin-bottom:10px}
    .part{background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.1);border-radius:10px;padding:16px;margin-bottom:12px}
    .part-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .input-group{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:10px}
    .input-box{flex:1;min-width:200px}
    .input-box label{display:block;margin-bottom:6px;font-weight:600;color:#ddd}
    .input-box input{width:100%;padding:10px 12px;border:1px solid rgba(255,255,255,.2);border-radius:6px;background:rgba(0,0,0,.2);color:#fff}
    .live-result{background:rgba(0,0,0,.3);border:1px dashed rgba(255,255,255,.2);padding:10px;border-radius:8px;font-family:monospace;color:#fff}
    .adv-row{display:flex;align-items:center;gap:10px;margin:6px 0 12px}
    .status-pill{font-size:12px;border:1px solid rgba(78,84,200,.3);background:rgba(78,84,200,.2);color:#8f94fb;padding:4px 8px;border-radius:999px}

    /* Pivot Toggle */
    .neo-toggle-container { --toggle-width:60px; --toggle-height:28px; --toggle-bg:#181c20; --toggle-off-color:#475057; --toggle-on-color:#4e54c8; --toggle-transition:.4s cubic-bezier(0.25,1,.5,1); position:relative; display:inline-flex; flex-direction:column; user-select:none; }
    .neo-toggle-input{position:absolute;opacity:0;width:0;height:0}
    .neo-toggle{position:relative;width:var(--toggle-width);height:var(--toggle-height);display:block;cursor:pointer}
    .neo-track{position:absolute;inset:0;border-radius:14px;overflow:hidden;box-shadow:0 2px 6px rgba(0,0,0,.3), inset 0 0 0 1px rgba(255,255,255,.1)}
    .neo-background-layer{position:absolute;inset:0;background:var(--toggle-bg)}
    .neo-grid-layer{position:absolute;inset:0;background-image:linear-gradient(to right,rgba(71,80,87,.05) 1px,transparent 1px),linear-gradient(to bottom,rgba(71,80,87,.05) 1px,transparent 1px);background-size:5px 5px;opacity:0;transition:opacity var(--toggle-transition)}
    .neo-track-highlight{position:absolute;inset:1px;border-radius:14px;background:linear-gradient(90deg,transparent,rgba(78,84,200,0));opacity:0;transition:all var(--toggle-transition)}
    .neo-thumb{position:absolute;top:4px;left:4px;width:20px;height:20px;border-radius:50%;transition:transform var(--toggle-transition)}
    .neo-thumb-ring{position:absolute;inset:0;border-radius:50%;background:var(--toggle-off-color);box-shadow:0 2px 6px rgba(0,0,0,.15);transition:all var(--toggle-transition)}
    .neo-thumb-core{position:absolute;inset:4px;border-radius:50%;background:linear-gradient(135deg,rgba(255,255,255,.1),transparent)}
    .neo-status{position:absolute;bottom:-18px;left:0;width:100%;display:flex;justify-content:center}
    .neo-status-dot{width:5px;height:5px;border-radius:50%;background:var(--toggle-off-color);transition:all var(--toggle-transition)}
    .neo-status-text{font-size:8px;font-weight:600;color:var(--toggle-off-color);letter-spacing:.5px;transition:all var(--toggle-transition)}
    .neo-toggle-input:checked + .neo-toggle .neo-thumb{transform:translateX(32px)}
    .neo-toggle-input:checked + .neo-toggle .neo-thumb-ring{background-color:var(--toggle-on-color)}
    .neo-toggle-input:checked + .neo-toggle .neo-grid-layer{opacity:1}
    .neo-toggle-input:checked + .neo-toggle + .neo-status .neo-status-dot{background-color:var(--toggle-on-color)}
    .pivot-toggle-container{display:flex;align-items:center;gap:8px;margin-left:auto}
    .pivot-label{font-size:12px;font-weight:600;color:#8f94fb;white-space:nowrap}

    /* AI Mode */
    .ai-grid{display:grid;grid-template-columns:1.1fr .9fr;gap:12px}
    @media (max-width:900px){.ai-grid{grid-template-columns:1fr}}
    .ai-console{max-height:180px;overflow:auto;background:rgba(15,22,38,.8);color:#e6eeff;border:1px solid rgba(229,231,235,.2);border-radius:10px;padding:10px;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;font-size:12px}
    .ai-bar{display:flex;align-items:center;gap:8px;padding:10px;margin-top:8px;background:rgba(238,242,255,.1);border-radius:10px;border:1px dashed rgba(203,213,255,.3)}
    .dot{width:8px;height:8px;border-radius:50%;background:#4e54c8;animation:pulse 1.6s infinite}
    @keyframes pulse{0%{opacity:.2}50%{opacity:1}100%{opacity:.2}}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,.1);text-align:left}
    th{background:rgba(255,255,255,.1);color:#fff}
    .pill{padding:6px 10px;border-radius:999px;font-size:12px;display:inline-block}
    .pill.good{background:rgba(233,249,241,.2);color:#4cd964;border:1px solid rgba(185,240,212,.3)}
    .pill.warn{background:rgba(255,247,214,.2);color:#ffcc00;border:1px solid rgba(255,232,161,.3)}
    
    /* AI Simulation Controls */
    .simulation-controls {display: flex; gap: 10px; margin-top: 10px;}
    .ai-pulse {position: relative;}
    .ai-pulse::after {content: ''; position: absolute; top: -5px; left: -5px; right: -5px; bottom: -5px; background: rgba(78, 84, 200, 0.3); border-radius: 50%; animation: pulse-ring 1.5s infinite;}
    @keyframes pulse-ring {0% {transform: scale(0.8); opacity: 1;} 100% {transform: scale(2); opacity: 0;}}
    
    /* AI Thinking Animation */
    .fa-brain {
      animation: brain-pulse 1.5s ease-in-out infinite;
    }
    @keyframes brain-pulse {
      0%, 100% { transform: scale(1); opacity: 0.7; }
      50% { transform: scale(1.1); opacity: 1; }
    }
    
    /* Futuristic elements */
    .glow-text {text-shadow: 0 0 10px rgba(143, 148, 251, 0.7);}
    .circuit-bg {position: relative; overflow: hidden;}
    .circuit-bg::before {content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-image: radial-gradient(circle at 10% 20%, rgba(78, 84, 200, 0.1) 0%, transparent 20%), radial-gradient(circle at 90% 80%, rgba(143, 148, 251, 0.1) 0%, transparent 20%); pointer-events: none;}
    
    /* AI Visualization */
    .ai-visualization {height: 100px; background: rgba(0, 0, 0, 0.3); border-radius: 8px; margin-top: 15px; position: relative; overflow: hidden;}
    .price-line {position: absolute; bottom: 0; left: 0; right: 0; height: 2px; background: linear-gradient(90deg, transparent, #4e54c8, transparent);}
    .price-dot {position: absolute; width: 12px; height: 12px; border-radius: 50%; background: #4e54c8; transform: translate(-50%, -50%); box-shadow: 0 0 10px #4e54c8;}
    
    footer {text-align: center; margin-top: 20px; color: #aaa; font-size: 14px;}
    
    /* Advanced Risk Calculator Styles */
    .risk-presets {display: flex; gap: 10px; margin-bottom: 20px; justify-content: center;}
    .preset-btn {padding: 8px 16px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 20px; color: #fff; cursor: pointer; transition: all 0.3s ease; font-size: 14px;}
    .preset-btn:hover {background: rgba(78, 84, 200, 0.3); transform: translateY(-2px);}
    .preset-btn.active {background: rgba(78, 84, 200, 0.5); border-color: #8f94fb;}
    
    .risk-controls {display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;}
    @media (max-width: 768px) {.risk-controls {grid-template-columns: 1fr;}}
    
    .control-group {background: rgba(255,255,255,0.05); padding: 16px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1);}
    .control-group label {display: flex; align-items: center; gap: 8px; margin-bottom: 12px; font-weight: 600; color: #ddd; font-size: 14px;}
    
    .slider-input-combo {display: flex; gap: 12px; align-items: center;}
    .slider-input-combo input[type="range"] {flex: 2; height: 6px; background: rgba(255,255,255,0.2); border-radius: 3px; outline: none; -webkit-appearance: none;}
    .slider-input-combo input[type="range"]::-webkit-slider-thumb {-webkit-appearance: none; width: 18px; height: 18px; background: linear-gradient(135deg, #4e54c8, #8f94fb); border-radius: 50%; cursor: pointer; box-shadow: 0 2px 6px rgba(0,0,0,0.3);}
    .slider-input-combo input[type="range"]::-moz-range-thumb {width: 18px; height: 18px; background: linear-gradient(135deg, #4e54c8, #8f94fb); border-radius: 50%; cursor: pointer; border: none; box-shadow: 0 2px 6px rgba(0,0,0,0.3);}
    .slider-input-combo input[type="number"] {flex: 1; padding: 8px 12px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: #fff; text-align: center; font-weight: 600;}
    
    .risk-badge {padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;}
    .risk-badge.conservative {background: rgba(76, 217, 100, 0.2); color: #4cd964;}
    .risk-badge.balanced {background: rgba(255, 204, 0, 0.2); color: #ffcc00;}
    .risk-badge.aggressive {background: rgba(255, 59, 48, 0.2); color: #ff3b30;}
    
    .risk-heat-meter {margin-top: 8px;}
    .heat-bar {height: 6px; border-radius: 3px; background: linear-gradient(90deg, #4cd964 0%, #ffcc00 50%, #ff3b30 100%); position: relative; overflow: hidden;}
    .heat-bar::after {content: ''; position: absolute; top: -2px; bottom: -2px; width: 4px; background: #fff; border-radius: 2px; box-shadow: 0 0 8px rgba(255,255,255,0.8); transition: left 0.3s ease; left: var(--heat-position, 20%);}
    .heat-labels {display: flex; justify-content: space-between; margin-top: 4px; font-size: 10px; color: #aaa;}
    
    .tooltip {display: inline-block; width: 16px; height: 16px; background: rgba(78, 84, 200, 0.3); border-radius: 50%; text-align: center; line-height: 16px; font-size: 10px; cursor: help; color: #8f94fb;}
    
    .risk-summary-dashboard {background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 20px; margin-top: 20px;}
    .risk-summary-dashboard h3 {color: #fff; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;}
    .summary-grid {display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px;}
    .summary-item {background: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px; text-align: center; border: 1px solid rgba(255,255,255,0.1);}
    .summary-label {font-size: 11px; color: #aaa; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;}
    .summary-value {font-size: 16px; font-weight: 700; color: #fff;}
    .summary-value.risk-amount {color: #ff3b30;}
    .summary-value.profit-amount {color: #4cd964;}
    .summary-value.rr-ratio {color: #8f94fb;}
    
    .form-control {width: 100%; padding: 10px 12px; border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; background: rgba(0,0,0,0.2); color: #fff; transition: border-color 0.3s ease;}
    .form-control:focus {outline: none; border-color: rgba(78, 84, 200, 0.5);}
    .btn-success {background: linear-gradient(135deg, #4cd964, #2fb344); color: #fff;}
    .btn-info {background: linear-gradient(135deg, #17a2b8, #138496); color: #fff;}
    .hidden {display: none !important;}
    
    #unsavedIndicator {animation: pulse 2s infinite;}
    @keyframes pulse {0% {opacity: 0.7;} 50% {opacity: 1;} 100% {opacity: 0.7;}}
    
    /* Split Editor Styles */
    .split-preview-item { cursor: pointer; transition: all 0.2s ease; }
    
    /* Toast Notifications */
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 12px 20px;
      border-radius: 6px;
      color: #fff;
      font-weight: 600;
      z-index: 9999;
      animation: slideIn 0.3s ease;
    }
    .toast-success { background: rgba(76, 217, 100, 0.9); }
    .toast-error { background: rgba(255, 59, 48, 0.9); }
    .toast-info { background: rgba(78, 84, 200, 0.9); }
    
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    /* Split Preview Table */
    .split-preview-table {
      width: 100%;
      border-collapse: collapse;
      background: rgba(255,255,255,0.05);
      border-radius: 8px;
      overflow: hidden;
      margin-top: 10px;
    }
    .split-preview-table th,
    .split-preview-table td {
      padding: 8px 6px;
      text-align: left;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      font-size: 11px;
    }
    .split-preview-table th {
      background-color: rgba(255,255,255,0.1);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #fff;
    }
    .split-preview-table td {
      color: #ddd;
    }
    .split-action-btn {
      padding: 4px 8px;
      font-size: 10px;
      border: 1px solid #4e54c8;
      background: rgba(78,84,200,0.2);
      color: #8f94fb;
      border-radius: 3px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .split-action-btn:hover {
      background: #4e54c8;
      color: white;
    }
    .split-action-btn:focus {
      outline: 2px solid #8f94fb;
      outline-offset: 2px;
    }
    .inline-edit-input {
      width: 50px;
      padding: 2px 4px;
      font-size: 10px;
      border: 1px solid #4e54c8;
      border-radius: 2px;
      background: rgba(0,0,0,0.3);
      color: #fff;
    }
    .error-message {
      color: #ff3b30;
      font-size: 11px;
      margin-top: 5px;
      padding: 4px 8px;
      background: rgba(255,59,48,0.1);
      border-radius: 4px;
      border: 1px solid rgba(255,59,48,0.2);
    }
    
    @media (max-width: 768px) {
      .split-preview-table {
        font-size: 12px;
      }
      .split-preview-table th,
      .split-preview-table td {
        padding: 6px !important;
      }
    }
    .split-preview-item:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
    
    /* Accessibility */
    .split-action-btn:focus {
      outline: 2px solid #8f94fb;
      outline-offset: 2px;
    }
    
    .form-control:focus {
      outline: 2px solid rgba(78, 84, 200, 0.5);
      outline-offset: 1px;
    }
    
    .toggle-btn {
      padding: 6px 12px;
      border: 1px solid #4e54c8;
      background: rgba(78,84,200,0.2);
      color: #8f94fb;
      cursor: pointer;
      border-radius: 4px;
      font-size: 12px;
      transition: all 0.2s ease;
    }
    
    .toggle-btn:hover {
      background: rgba(78,84,200,0.4);
    }
    
    .toggle-btn.active {
      background: #4e54c8;
      color: white;
    }
    .editor-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; display: none; }
    .editor-panel { position: absolute; right: 0; top: 0; width: 400px; height: 100%; background: linear-gradient(135deg, #1a1a2e, #16213e); backdrop-filter: blur(10px); padding: 20px; overflow-y: auto; border-left: 2px solid #4e54c8; box-shadow: -5px 0 20px rgba(0,0,0,0.5); }
    .editor-header { border-bottom: 2px solid #4e54c8; padding-bottom: 15px; margin-bottom: 20px; }
    .field-group { margin-bottom: 20px; }
    .field-group label { display: block; margin-bottom: 8px; font-weight: 700; color: #fff; font-size: 14px; }
    .field-group input { width: 100%; padding: 12px; border: 2px solid #4e54c8; border-radius: 6px; background: rgba(0,0,0,0.4); color: #fff; font-size: 14px; font-weight: 600; }
    .field-group input:read-only { background: rgba(78,84,200,0.2); border-color: #8f94fb; }
    .field-group input:focus { outline: none; border-color: #8f94fb; box-shadow: 0 0 10px rgba(143,148,251,0.3); }
    .toggle-group { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; }
    .toggle-btn { padding: 8px 16px; border: 2px solid #4e54c8; background: rgba(78,84,200,0.2); cursor: pointer; border-radius: 6px; color: #fff; font-weight: 600; transition: all 0.3s ease; }
    .toggle-btn:hover { background: rgba(78,84,200,0.4); transform: translateY(-1px); }
    .toggle-btn.active { background: #4e54c8; border-color: #8f94fb; box-shadow: 0 0 15px rgba(143,148,251,0.5); }
    .calc-display { font-size: 14px; color: #8f94fb; margin-top: 8px; font-weight: 600; }
    .error-msg { color: #ff3b30; font-size: 12px; margin-top: 5px; font-weight: 600; }
    .editor-actions { display: flex; gap: 15px; margin-top: 30px; }
    .editor-actions button { padding: 12px 24px; border: none; border-radius: 6px; font-weight: 700; font-size: 14px; cursor: pointer; transition: all 0.3s ease; }
    .btn-primary { background: linear-gradient(135deg, #4e54c8, #8f94fb); color: #fff; }
    .btn-primary:hover { background: linear-gradient(135deg, #3a3f99, #6f73d9); transform: translateY(-2px); box-shadow: 0 5px 15px rgba(78,84,200,0.4); }
    .btn-secondary { background: linear-gradient(135deg, #6c757d, #495057); color: #fff; }
    .btn-secondary:hover { background: linear-gradient(135deg, #5a6268, #343a40); transform: translateY(-2px); box-shadow: 0 5px 15px rgba(108,117,125,0.4); }
  </style>
</head>
<body>
<div class="container">
  <header class="circuit-bg" style="position: relative;">
    <div class="stock-info">
      <div class="stock-icon"><i class="fas fa-brain"></i></div>
      <div class="stock-details">
        <h1 class="glow-text">{{ symbol }}</h1>
        <p>NSE: {{ symbol }} | Trade ID: {{ trade.id }}</p>
      </div>
    </div>
    <div class="live-price">
      <div class="price" id="livePrice">₹{{ "%.2f"|format(trade.ltp if trade.ltp else trade.avg_price) }}</div>
      <div class="change" id="liveChange">
        {{ "Buy Trade" if trade.trade_type|lower == "buy" else "Sell Trade" }}
      </div>
    </div>
    {% if trade.status == 'closed' %}
    <div style="position: absolute; top: 10px; right: 10px; background: rgba(255, 59, 48, 0.9); color: white; padding: 8px 16px; border-radius: 20px; font-weight: bold; font-size: 14px; z-index: 1000;">
      POSITION CLOSED
    </div>
    {% endif %}
  </header>

  <div class="dashboard">
    <!-- LEFT: Position Management -->
    <div class="card circuit-bg" id="positionManagementCard">
      <h2><i class="fas fa-chart-line"></i> Delivery Position Management</h2>

      <div class="form-row">
        <div class="form-group">
          <label for="inpAvgPrice">Average Price (₹)</label>
          <input id="inpAvgPrice" type="number" step="0.01" value="{{ '%.2f'|format(trade.avg_price) }}">
        </div>
        <div class="form-group">
          <label for="inpQty">Quantity</label>
          <input id="inpQty" type="number" value="{{ trade.quantity }}">
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="inpSL">Stop Loss (₹)</label>
          <input id="inpSL" type="number" step="0.01" value="{{ '%.2f'|format(trade.stop_loss_price) }}">
        </div>
        <div class="form-group">
          <label for="inpTarget">Target (₹)</label>
          <input id="inpTarget" type="number" step="0.01" value="{{ '%.2f'|format(trade.target_price) }}">
        </div>
      </div>

      <div class="actions" style="margin-bottom:16px;">
        <button id="updateBtn">Save Update</button>
        <button id="closeBtn" class="btn-sell">Close Position</button>
        <button id="exportToJournalBtn" class="btn-ai" onclick="exportCurrentTradeToJournal()">
          <i class="fas fa-paper-plane"></i> Export to Journal
        </button>
      </div>

      <div class="stats tiles" id="summaryTiles">
        <div class="stat-item">
          <div class="stat-value" id="ts-capital">₹{{ '%.2f'|format(trade.capital_used) }}</div>
          <div class="stat-label">Capital Used</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="ts-rr">1:{{ '%.1f'|format(trade.rr_ratio) }}</div>
          <div class="stat-label">Risk-Reward Ratio</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="ts-profit">{{ '%.2f'|format(trade.expected_return) }}%</div>
          <div class="stat-label">Expected Return</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="ts-risk">{{ '%.2f'|format(trade.risk_percent) }}%</div>
          <div class="stat-label">Risk Percentage</div>
        </div>
      </div>
    </div>

    <!-- RIGHT: Choose Mode -->
    <div class="card circuit-bg" id="modeCard">
      <h2><i class="fas fa-robot"></i> AI Trading Assistant</h2>
      <div class="selector-row" style="margin-bottom:12px;">
        <select id="modeSelect" class="select">
          <option value="manual">Manual position management</option>
          <option value="ai" selected>AI-powered position management</option>
        </select>
        <button id="backToManual" class="btn-back hidden">Back to Manual</button>
      </div>

      <div id="modeArea">
        <!-- MANUAL -->
        <div id="manualMode" class="hidden">
          <h4 style="color:#fff;margin-top:16px;">Manual Position Management</h4>
          <p style="color:#aaa;margin-bottom:16px;font-size:14px;">Split your position into multiple parts with different stop-loss and target levels for advanced risk management.</p>
          <div class="form-group" style="margin-bottom:12px;">
            <label for="splitMode">Split Mode</label>
            <select id="splitMode" class="select">
              <option value="full">Full Quantity</option>
              <option value="half">Divide in Half</option>
              <option value="custom">Custom Split</option>
            </select>
          </div>
          
          <div id="customSplitContainer" class="form-group hidden" style="margin-bottom:12px;">
            <label for="customSplitInput">Custom Split (comma-separated)</label>
            <input id="customSplitInput" type="text" placeholder="e.g., 10,6,6" class="form-control">
            <small style="color:#aaa;">Enter quantities separated by commas. Total must equal quantity.</small>
          </div>
          
          <!-- Applied Split Table -->
          <div id="appliedSplitTable" class="hidden" style="background:rgba(0,0,0,0.2);padding:16px;border-radius:8px;margin-bottom:16px;">
            <h5 style="color:#fff;margin-bottom:12px;display:flex;align-items:center;justify-content:space-between;">
              Split Preview:
              <div style="display:flex;gap:8px;">
                <button id="saveTemplateBtn" class="tiny-link" style="font-size:12px;" onclick="savePreviewTemplate()">Save Preview Template</button>
                <button id="resetSplitBtn" class="tiny-link" style="font-size:12px;" onclick="resetSplitTable()">Reset</button>
                <button id="deleteTemplateBtn" class="tiny-link" style="font-size:12px;display:none;" onclick="deletePreviewTemplate()">Delete Template</button>
              </div>
            </h5>
            <table class="split-preview-table">
              <thead>
                <tr>
                  <th>PREVIEW</th>
                  <th>SL</th>
                  <th>TARGET</th>
                  <th>QTY</th>
                  <th>ACTION</th>
                </tr>
              </thead>
              <tbody id="splitTableBody">
              </tbody>
            </table>
          </div>
          
          <!-- Unsaved Changes Indicator -->
          <div id="unsavedIndicator" class="hidden" style="background:rgba(255,204,0,0.2);color:#ffcc00;padding:8px;border-radius:6px;margin-bottom:12px;font-size:14px;">
            <i class="fas fa-exclamation-triangle"></i> You have unsaved changes
          </div>

          <div class="actions" style="margin-top:16px;justify-content:flex-start;gap:8px;">
            <button id="applySplitBtn" class="btn-ai" style="font-size:14px;padding:8px 16px;">Apply Split Strategy</button>
            <button id="previewSplitBtn" class="tiny-link" style="font-size:12px;">Preview Only</button>
          </div>
        </div>

        <!-- AI MODE -->
        <div id="aiMode">
          <div class="ai-grid">
            <div>
              <h3 style="color:#fff;margin-top:8px;">AI Exit Planner (Dynamic Rules)</h3>
              <div id="ruleInfo" style="background:rgba(0,0,0,.2);padding:12px;border-radius:8px;margin-bottom:12px;">
                <p style="color:#aaa;margin:0">AI will select rules based on quantity:</p>
                <ul style="color:#aaa;margin:8px 0 0 0;padding-left:20px;font-size:12px;">
                  <li>Small (1–3): SL = -2%, Exit-1 = +5% (100%)</li>
                  <li>Medium (4–10): SL = -2%, Exit-1 = +3% (30%), Exit-2 = +6% (70%)</li>
                  <li>Large (>10): SL = -1.5%, Exit-1 = +2.5% (20%), Exit-2 = +5% (40%), Exit-3 = +7% (40%)</li>
                </ul>
              </div>
              
              <div class="actions" style="justify-content:flex-start;margin-top:6px;gap:8px;">
                <button id="btnPlan" class="btn-ai"><i class="fas fa-brain"></i> Generate AI Plan</button>
                <button id="btnSavePlan" class="btn-ai"><i class="fas fa-save"></i> Save Plan</button>
                <button id="btnViewPlans" class="tiny-link" style="border:none">View Saved Plans</button>
                <button id="btnReset" class="tiny-link" style="border:none">Reset</button>
              </div>

              <div style="margin-top:12px">
                <h4 style="color:#fff;margin-bottom:6px;">AI Console</h4>
                <div id="ailog" class="ai-console" aria-live="polite"></div>
                <div class="ai-bar"><div class="dot"></div><div>AI is analyzing your entry, quantity, and volatility bands</div></div>
              </div>
            </div>

            <div>
              <h3 style="color:#fff;margin-top:8px;">Plan Output</h3>
              <div id="plan"><p style="color:#aaa">Click <b>Generate AI Plan</b>. The exits will appear here based on quantity.</p></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Advanced Interactive Risk Management Calculator -->
  <div class="card circuit-bg">
    <h2><i class="fas fa-calculator"></i> Advanced Risk Management Calculator</h2>
    
    <!-- Preset Risk Buttons -->
    <div class="risk-presets">
      <button class="preset-btn" data-risk="1">Safe (1%)</button>
      <button class="preset-btn" data-risk="2">Normal (2%)</button>
      <button class="preset-btn" data-risk="5">Aggressive (5%)</button>
    </div>
    
    <!-- Interactive Controls -->
    <div class="risk-controls">
      <!-- Account Capital -->
      <div class="control-group">
        <label>Account Capital (₹) <span class="tooltip" title="Total trading capital available">ⓘ</span></label>
        <div class="slider-input-combo">
          <input type="range" id="capital-slider" min="10000" max="1000000" step="10000" value="{{ trade.capital_used or 100000 }}">
          <input type="number" id="capital-input" min="10000" max="1000000" step="10000" value="{{ trade.capital_used or 100000 }}">
        </div>
      </div>
      
      <!-- Risk Percentage -->
      <div class="control-group">
        <label>Risk per Trade (%) <span class="risk-badge" id="risk-badge">Balanced</span></label>
        <div class="slider-input-combo">
          <input type="range" id="risk-slider" min="0.1" max="10" step="0.1" value="2">
          <input type="number" id="risk-input" min="0.1" max="10" step="0.1" value="2">
        </div>
        <!-- Risk Heat Meter -->
        <div class="risk-heat-meter">
          <div class="heat-bar" id="heat-bar"></div>
          <div class="heat-labels">
            <span>Conservative</span>
            <span>Balanced</span>
            <span>Aggressive</span>
          </div>
        </div>
      </div>
      
      <!-- Expected Return -->
      <div class="control-group">
        <label>Expected Return (%) <span class="tooltip" title="Target profit percentage">ⓘ</span></label>
        <div class="slider-input-combo">
          <input type="range" id="return-slider" min="1" max="20" step="0.5" value="5">
          <input type="number" id="return-input" min="1" max="20" step="0.5" value="5">
        </div>
      </div>
      
      <!-- Quantity -->
      <div class="control-group">
        <label>Quantity <span class="tooltip" title="Number of shares to trade">ⓘ</span></label>
        <div class="slider-input-combo">
          <input type="range" id="qty-slider" min="1" max="1000" step="1" value="{{ trade.quantity }}">
          <input type="number" id="qty-input" min="1" max="1000" step="1" value="{{ trade.quantity }}">
        </div>
      </div>
    </div>
    
    <!-- Live Summary Dashboard -->
    <div class="risk-summary-dashboard">
      <h3><i class="fas fa-chart-pie"></i> Live Position Summary</h3>
      <div class="summary-grid">
        <div class="summary-item">
          <div class="summary-label">Position Value</div>
          <div class="summary-value" id="position-value">₹0</div>
        </div>
        <div class="summary-item">
          <div class="summary-label">Capital Used</div>
          <div class="summary-value" id="capital-used">₹0</div>
        </div>
        <div class="summary-item">
          <div class="summary-label">Risk Amount</div>
          <div class="summary-value risk-amount" id="risk-amount">₹0</div>
        </div>
        <div class="summary-item">
          <div class="summary-label">Expected Profit</div>
          <div class="summary-value profit-amount" id="expected-profit">₹0</div>
        </div>
        <div class="summary-item">
          <div class="summary-label">Risk:Reward Ratio</div>
          <div class="summary-value rr-ratio" id="rr-ratio">1:0</div>
        </div>
        <div class="summary-item">
          <div class="summary-label">Target Price</div>
          <div class="summary-value" id="target-price">₹0</div>
        </div>
        <div class="summary-item">
          <div class="summary-label">Stop Loss</div>
          <div class="summary-value" id="stop-loss-price">₹0</div>
        </div>
        <div class="summary-item">
          <div class="summary-label">Breakeven</div>
          <div class="summary-value" id="breakeven-price">₹{{ '%.2f'|format(trade.avg_price) }}</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Confirmation Modal -->
<div id="confirmModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; display: none; align-items: center; justify-content: center;">
  <div style="background: rgba(255,255,255,0.1); border-radius: 12px; padding: 24px; max-width: 400px; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2);">
    <h3 style="color: #fff; margin-bottom: 16px; text-align: center;">Confirm Update</h3>
    <p style="color: #ddd; margin-bottom: 20px; text-align: center;">This will update your position, remove old calculations, and replace them with the new values. Do you want to continue?</p>
    <div style="display: flex; gap: 12px; justify-content: center;">
      <button id="confirmYes" style="background: linear-gradient(135deg, #4e54c8, #8f94fb); color: #fff; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">Yes, Update</button>
      <button id="confirmNo" style="background: linear-gradient(135deg, #ff416c, #ff4b2b); color: #fff; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">Cancel</button>
    </div>
  </div>
</div>

<!-- Split Editor Overlay -->
<div class="editor-overlay" id="splitEditorOverlay">
  <div class="editor-panel">
    <div class="editor-header">
      <h3 style="color: #fff; margin-bottom: 8px;">Edit Split Position</h3>
      <p style="color: #aaa;">Part <span id="editPart"></span> — <span id="editQty"></span> shares</p>
    </div>
    
    <div class="field-group">
      <label>Average Price (₹)</label>
      <input type="number" id="editAvgPrice" readonly>
    </div>
    
    <div class="field-group">
      <label>Quantity</label>
      <input type="number" id="editQuantity" readonly>
    </div>
    
    <div class="field-group">
      <label>Stop-Loss</label>
      <div class="toggle-group">
        <button class="toggle-btn active" id="stopPctBtn">%</button>
        <button class="toggle-btn" id="stopPriceBtn">₹</button>
      </div>
      <input type="number" id="stopInput" placeholder="Enter stop loss %">
      <div class="calc-display" id="stopCalc"></div>
      <div class="error-msg" id="stopError"></div>
    </div>
    
    <div class="field-group">
      <label>Target</label>
      <div class="toggle-group">
        <button class="toggle-btn active" id="targetPctBtn">%</button>
        <button class="toggle-btn" id="targetPriceBtn">₹</button>
      </div>
      <input type="number" id="targetInput" placeholder="Enter target %">
      <div class="calc-display" id="targetCalc"></div>
      <div class="error-msg" id="targetError"></div>
    </div>
    
    <div class="editor-actions">
      <button class="btn btn-primary" id="splitApplyBtn">Apply</button>
      <button class="btn btn-secondary" id="splitCancelBtn">Cancel</button>
    </div>
  </div>
</div>

<footer>
  <p>© 2025 Advanced AI Delivery Position Management | For demonstration purposes only</p>
</footer>

<script>
/* ---------- Trade data from backend ---------- */
const tradeData = {
  id: "{{ trade.id }}",
  tradeType: "{{ trade.trade_type|lower }}",
  avgPrice: parseFloat("{{ '%.2f'|format(trade.avg_price) }}"),
  stopLoss: parseFloat("{{ '%.2f'|format(trade.stop_loss_price) }}"),
  quantity: parseInt("{{ trade.quantity }}"),
  target: parseFloat("{{ '%.2f'|format(trade.target_price) }}"),
  ltp: parseFloat("{{ '%.2f'|format(trade.ltp if trade.ltp else trade.avg_price) }}"),
  capital_used: parseFloat("{{ '%.2f'|format(trade.capital_used) }}"),
  rr_ratio: parseFloat("{{ '%.1f'|format(trade.rr_ratio) }}"),
  expected_return: parseFloat("{{ '%.2f'|format(trade.expected_return) }}"),
  risk_percent: parseFloat("{{ '%.2f'|format(trade.risk_percent) }}"),
  total_reward: parseFloat("{{ '%.2f'|format(trade.total_reward) }}"),
  total_risk: parseFloat("{{ '%.2f'|format(trade.total_risk) }}"),
  symbol: "{{ trade.symbol }}",
  commentSymbol: "{{ trade.comment }}",
  status: "{{ trade.status or 'open' }}",
  timestamp: new Date("{{ trade.timestamp }}")
};

// Delivery specific: No leverage calculation (capital = avg_price * quantity)
const leverageMultiplier = 1; // Delivery uses no leverage

document.getElementById('liveChange').className = 'change ' + 
  (parseFloat("{{ trade.change_percent if trade.change_percent else 0 }}") >= 0 ? 'positive' : 'negative');

let avgPriceValue = tradeData.avgPrice;
let totalQuantity = tradeData.quantity;
let parts = [];
let globalPartId = 1;
let pivotEnabled = false;
let simulationInterval = null;
let aiPlanData = null;

/* ---------- Mode switch ---------- */
const modeSelect = document.getElementById('modeSelect');
const backToManualBtn = document.getElementById('backToManual');
const modeCard = document.getElementById('modeCard');
const positionCard = document.getElementById('positionManagementCard');

modeSelect.addEventListener('change', ()=>{
  const val = modeSelect.value;
  const isAIMode = val === 'ai';
  
  document.getElementById('manualMode').classList.toggle('hidden', isAIMode);
  document.getElementById('aiMode').classList.toggle('hidden', !isAIMode);
  backToManualBtn.classList.toggle('hidden', !isAIMode);
  
  modeCard.classList.toggle('ai-active', isAIMode);
  positionCard.classList.toggle('ai-active', isAIMode);
});

backToManualBtn.addEventListener('click', () => {
  modeSelect.value = 'manual';
  modeSelect.dispatchEvent(new Event('change'));
});

/* ---------- Manual Split Management ---------- */
const splitModeSelect = document.getElementById('splitMode');
const customSplitContainer = document.getElementById('customSplitContainer');
const appliedSplitTable = document.getElementById('appliedSplitTable');
const splitTableBody = document.getElementById('splitTableBody');
const unsavedIndicator = document.getElementById('unsavedIndicator');

splitModeSelect.addEventListener('change', function() {
  const mode = this.value;
  customSplitContainer.classList.toggle('hidden', mode !== 'custom');
  
  if (mode === 'full') {
    generateSplitPreview([totalQuantity]);
  } else if (mode === 'half') {
    const half = Math.floor(totalQuantity / 2);
    const remainder = totalQuantity - half;
    generateSplitPreview([half, remainder]);
  }
});

document.getElementById('customSplitInput').addEventListener('input', function() {
  const input = this.value.trim();
  if (!input) return;
  
  const splits = input.split(',').map(s => parseInt(s.trim())).filter(n => !isNaN(n) && n > 0);
  const total = splits.reduce((sum, qty) => sum + qty, 0);
  
  if (total === totalQuantity) {
    generateSplitPreview(splits);
    this.style.borderColor = '#4cd964';
  } else {
    this.style.borderColor = '#ff3b30';
  }
});

function generateSplitPreview(quantities) {
  parts = [];
  splitTableBody.innerHTML = '';
  
  quantities.forEach((qty, index) => {
    const part = {
      id: globalPartId++,
      qty: qty,
      avgPrice: avgPriceValue,
      stopLoss: tradeData.stopLoss,
      target: tradeData.target,
      stopPct: tradeData.risk_percent,
      targetPct: tradeData.expected_return
    };
    parts.push(part);
    
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>Part ${index + 1}</td>
      <td>₹${part.stopLoss.toFixed(2)} (${part.stopPct.toFixed(1)}%)</td>
      <td>₹${part.target.toFixed(2)} (${part.targetPct.toFixed(1)}%)</td>
      <td>${part.qty}</td>
      <td><button class="split-action-btn" onclick="editSplitPart(${part.id})">Edit</button></td>
    `;
    splitTableBody.appendChild(row);
  });
  
  appliedSplitTable.classList.remove('hidden');
  unsavedIndicator.classList.remove('hidden');
}

function editSplitPart(partId) {
  const part = parts.find(p => p.id === partId);
  if (!part) return;
  
  document.getElementById('editPart').textContent = parts.indexOf(part) + 1;
  document.getElementById('editQty').textContent = part.qty;
  document.getElementById('editAvgPrice').value = part.avgPrice.toFixed(2);
  document.getElementById('editQuantity').value = part.qty;
  document.getElementById('stopInput').value = part.stopPct.toFixed(1);
  document.getElementById('targetInput').value = part.targetPct.toFixed(1);
  
  updateStopCalc();
  updateTargetCalc();
  
  document.getElementById('splitEditorOverlay').style.display = 'block';
  
  document.getElementById('splitApplyBtn').onclick = () => {
    applySplitEdit(partId);
  };
}

function applySplitEdit(partId) {
  const part = parts.find(p => p.id === partId);
  if (!part) return;
  
  const stopValue = parseFloat(document.getElementById('stopInput').value);
  const targetValue = parseFloat(document.getElementById('targetInput').value);
  const isStopPct = document.getElementById('stopPctBtn').classList.contains('active');
  const isTargetPct = document.getElementById('targetPctBtn').classList.contains('active');
  
  if (!isNaN(stopValue)) {
    if (isStopPct) {
      part.stopPct = stopValue;
      part.stopLoss = tradeData.tradeType === 'buy' 
        ? part.avgPrice * (1 - stopValue / 100)
        : part.avgPrice * (1 + stopValue / 100);
    } else {
      part.stopLoss = stopValue;
      part.stopPct = Math.abs((stopValue - part.avgPrice) / part.avgPrice * 100);
    }
  }
  
  if (!isNaN(targetValue)) {
    if (isTargetPct) {
      part.targetPct = targetValue;
      part.target = tradeData.tradeType === 'buy'
        ? part.avgPrice * (1 + targetValue / 100)
        : part.avgPrice * (1 - targetValue / 100);
    } else {
      part.target = targetValue;
      part.targetPct = Math.abs((targetValue - part.avgPrice) / part.avgPrice * 100);
    }
  }
  
  document.getElementById('splitEditorOverlay').style.display = 'none';
  
  // Update the specific row in the table
  const partIndex = parts.findIndex(p => p.id === partId);
  if (partIndex !== -1) {
    const row = splitTableBody.children[partIndex];
    if (row) {
      const cells = row.querySelectorAll('td');
      if (cells.length >= 3) {
        cells[1].textContent = `₹${part.stopLoss.toFixed(2)} (${part.stopPct.toFixed(1)}%)`;
        cells[2].textContent = `₹${part.target.toFixed(2)} (${part.targetPct.toFixed(1)}%)`;
      }
    }
  }
  
  showToast('Split part updated successfully!', 'success');
  unsavedIndicator.classList.remove('hidden');
}

document.getElementById('splitCancelBtn').addEventListener('click', () => {
  document.getElementById('splitEditorOverlay').style.display = 'none';
});

// Close overlay when clicking outside
document.getElementById('splitEditorOverlay').addEventListener('click', (e) => {
  if (e.target.id === 'splitEditorOverlay') {
    document.getElementById('splitEditorOverlay').style.display = 'none';
  }
});

// Toggle buttons for stop loss and target
document.getElementById('stopPctBtn').addEventListener('click', function() {
  document.getElementById('stopPctBtn').classList.add('active');
  document.getElementById('stopPriceBtn').classList.remove('active');
  document.getElementById('stopInput').placeholder = 'Enter stop loss %';
  updateStopCalc();
});

document.getElementById('stopPriceBtn').addEventListener('click', function() {
  document.getElementById('stopPriceBtn').classList.add('active');
  document.getElementById('stopPctBtn').classList.remove('active');
  document.getElementById('stopInput').placeholder = 'Enter stop loss price';
  updateStopCalc();
});

document.getElementById('targetPctBtn').addEventListener('click', function() {
  document.getElementById('targetPctBtn').classList.add('active');
  document.getElementById('targetPriceBtn').classList.remove('active');
  document.getElementById('targetInput').placeholder = 'Enter target %';
  updateTargetCalc();
});

document.getElementById('targetPriceBtn').addEventListener('click', function() {
  document.getElementById('targetPriceBtn').classList.add('active');
  document.getElementById('targetPctBtn').classList.remove('active');
  document.getElementById('targetInput').placeholder = 'Enter target price';
  updateTargetCalc();
});

document.getElementById('stopInput').addEventListener('input', updateStopCalc);
document.getElementById('targetInput').addEventListener('input', updateTargetCalc);

function updateStopCalc() {
  const value = parseFloat(document.getElementById('stopInput').value);
  const avgPrice = parseFloat(document.getElementById('editAvgPrice').value);
  const isStopPct = document.getElementById('stopPctBtn').classList.contains('active');
  
  if (isNaN(value) || isNaN(avgPrice)) {
    document.getElementById('stopCalc').textContent = '';
    return;
  }
  
  if (isStopPct) {
    const price = tradeData.tradeType === 'buy' 
      ? avgPrice * (1 - value / 100)
      : avgPrice * (1 + value / 100);
    document.getElementById('stopCalc').textContent = `= ₹${price.toFixed(2)}`;
  } else {
    const pct = Math.abs((value - avgPrice) / avgPrice * 100);
    document.getElementById('stopCalc').textContent = `= ${pct.toFixed(1)}%`;
  }
}

function updateTargetCalc() {
  const value = parseFloat(document.getElementById('targetInput').value);
  const avgPrice = parseFloat(document.getElementById('editAvgPrice').value);
  const isTargetPct = document.getElementById('targetPctBtn').classList.contains('active');
  
  if (isNaN(value) || isNaN(avgPrice)) {
    document.getElementById('targetCalc').textContent = '';
    return;
  }
  
  if (isTargetPct) {
    const price = tradeData.tradeType === 'buy'
      ? avgPrice * (1 + value / 100)
      : avgPrice * (1 - value / 100);
    document.getElementById('targetCalc').textContent = `= ₹${price.toFixed(2)}`;
  } else {
    const pct = Math.abs((value - avgPrice) / avgPrice * 100);
    document.getElementById('targetCalc').textContent = `= ${pct.toFixed(1)}%`;
  }
}

// Save preview template function - make it global
window.savePreviewTemplate = async function() {
  const splitTableBody = document.getElementById('splitTableBody');
  if (!splitTableBody || splitTableBody.children.length === 0) {
    showToast('No split preview data to save', 'error');
    return;
  }
  
  const instrument = tradeData.commentSymbol || tradeData.symbol || 'UNKNOWN';
  const strike = null; // For equity trades, no strike needed
  
  console.log('Saving template for instrument:', instrument, 'strike:', strike);
  
  const payload = {
    split_mode: splitModeSelect.value,
    split_parts: parts,
    table_data: Array.from(splitTableBody.children).map(row => {
      const cells = row.querySelectorAll('td');
      return {
        preview: cells[0]?.textContent || '',
        sl: cells[1]?.textContent || '',
        target: cells[2]?.textContent || '',
        qty: cells[3]?.textContent || ''
      };
    })
  };
  
  try {
    const requestData = { instrument, strike, payload };
    console.log('Sending save request:', requestData);
    
    const response = await fetch('/api/templates', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(requestData)
    });
    
    const result = await response.json();
    console.log('Save response:', response.status, result);
    
    if (response.ok && result.template_id) {
      window.currentTemplateId = result.template_id;
      showToast('Preview template saved successfully!', 'success');
      toggleButtons(true);
    } else {
      console.error('Save failed', response.status, result);
      showToast('Failed to save template: ' + (result.error || 'Unknown error'), 'error');
    }
  } catch (error) {
    console.error('Network error:', error);
    showToast('Network error: ' + error.message, 'error');
  }
};

// Delete preview template function - make it global
window.deletePreviewTemplate = async function() {
  const templateId = window.currentTemplateId;
  if (!templateId) {
    showToast('No template to delete', 'error');
    return;
  }
  
  try {
    const response = await fetch(`/api/templates/${templateId}`, {
      method: 'DELETE'
    });
    
    const result = await response.json();
    if (response.ok) {
      window.currentTemplateId = null;
      showToast('Template deleted successfully!', 'success');
      toggleButtons(false);
    } else {
      console.error('Delete failed', result);
      showToast('Failed to delete template: ' + (result.error || 'Unknown error'), 'error');
    }
  } catch (error) {
    console.error('Network error:', error);
    showToast('Network error: ' + error.message, 'error');
  }
};

// Reset split table function - make it global
window.resetSplitTable = function() {
  parts = [];
  splitTableBody.innerHTML = '';
  appliedSplitTable.classList.add('hidden');
  unsavedIndicator.classList.add('hidden');
  splitModeSelect.value = 'full';
  document.getElementById('customSplitInput').value = '';
  document.getElementById('customSplitInput').style.borderColor = '';
  
  showToast('Split table reset successfully!', 'info');
};

// Toggle button visibility
function toggleButtons(saved) {
  document.getElementById('resetSplitBtn').style.display = saved ? 'none' : 'inline-block';
  document.getElementById('deleteTemplateBtn').style.display = saved ? 'inline-block' : 'none';
}

// Load templates on page load
async function loadSavedTemplate() {
  const instrument = tradeData.commentSymbol || tradeData.symbol || 'UNKNOWN';
  const strike = null;
  
  console.log('Loading templates for instrument:', instrument, 'strike:', strike);
  
  try {
    const url = `/api/templates?instrument=${encodeURIComponent(instrument)}&t=${Date.now()}`;
    console.log('Loading from URL:', url);
    
    const response = await fetch(url);
    if (!response.ok) {
      console.error('Load failed', response.status);
      toggleButtons(false);
      return;
    }
    
    const templates = await response.json();
    console.log('Loaded templates:', templates);
    
    if (templates.length > 0) {
      const template = templates[0]; // Get latest
      window.currentTemplateId = template.id;
      
      // Restore the template data
      const payload = template.payload;
      if (payload.split_mode) {
        splitModeSelect.value = payload.split_mode;
      }
      if (payload.split_parts) {
        parts = payload.split_parts;
      }
      
      // Update the split preview
      generateSplitPreview(parts.map(p => p.qty));
      
      // Restore table data if available
      if (payload.table_data && payload.table_data.length > 0) {
        if (splitTableBody) {
          splitTableBody.innerHTML = payload.table_data.map((row, index) => `
            <tr>
              <td>${row.preview}</td>
              <td>${row.sl}</td>
              <td>${row.target}</td>
              <td>${row.qty}</td>
              <td><button class="split-action-btn" onclick="editSplitPart(${parts[index]?.id || index + 1})">Edit</button></td>
            </tr>
          `).join('');
          
          appliedSplitTable.classList.remove('hidden');
        }
      }
      
      toggleButtons(true);
      console.log('Template loaded:', template.id);
    } else {
      toggleButtons(false);
    }
  } catch (error) {
    console.error('Error loading templates:', error);
    toggleButtons(false);
  }
}

/* ---------- Update/Close buttons ---------- */
document.getElementById('updateBtn').addEventListener('click', showConfirmModal);
document.getElementById('closeBtn').addEventListener('click', ()=>{
  if (confirm('Are you sure you want to close this position?')) {
    closePosition();
  }
});

function showConfirmModal() {
  document.getElementById('confirmModal').style.display = 'flex';
}

document.getElementById('confirmYes').addEventListener('click', () => {
  document.getElementById('confirmModal').style.display = 'none';
  savePositionUpdate();
});
document.getElementById('confirmNo').addEventListener('click', () => {
  document.getElementById('confirmModal').style.display = 'none';
});

function showToast(message, type = 'info') {
  const toast = document.createElement('div');
  toast.className = `toast toast-${type}`;
  toast.textContent = message;
  document.body.appendChild(toast);
  
  setTimeout(() => {
    if (toast.parentNode) {
      toast.parentNode.removeChild(toast);
    }
  }, 3000);
}

async function savePositionUpdate() {
  const avgPrice = parseFloat(document.getElementById('inpAvgPrice').value);
  const quantity = parseInt(document.getElementById('inpQty').value);
  const stopLoss = parseFloat(document.getElementById('inpSL').value);
  const target = parseFloat(document.getElementById('inpTarget').value);
  
  const updateData = {
    trade_id: tradeData.id,
    avg_price: avgPrice,
    quantity: quantity,
    stop_loss_price: stopLoss,
    target_price: target
  };
  
  try {
    const response = await fetch('/save_delivery_update', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(updateData)
    });
    
    const result = await response.json();
    
    if (result.success) {
      updatePositionUI(result.trade);
      showToast('Position updated successfully!', 'success');
    } else {
      showToast('Error: ' + result.error, 'error');
    }
  } catch (error) {
    showToast('Network error: ' + error.message, 'error');
  }
}

async function closePosition() {
  try {
    const response = await fetch('/close_delivery_position', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ trade_id: tradeData.id })
    });
    
    const result = await response.json();
    
    if (result.success) {
      showToast('POSITION CLOSED', 'success');
      tradeData.status = 'closed';
      
      const inputs = document.querySelectorAll('input, button, select');
      inputs.forEach(input => {
        if (input.id !== 'backToManual' && input.id !== 'closeBtn') {
          input.disabled = true;
          input.style.opacity = '0.5';
        }
      });
      
      const closeBtn = document.getElementById('closeBtn');
      closeBtn.textContent = 'Reopen Position';
      closeBtn.className = 'btn-ai';
      closeBtn.onclick = () => {
        if (confirm('Are you sure you want to reopen this position?')) {
          reopenPosition();
        }
      };
    } else {
      showToast('Error: ' + result.error, 'error');
    }
  } catch (error) {
    showToast('Network error: ' + error.message, 'error');
  }
}

async function reopenPosition() {
  try {
    const response = await fetch('/reopen_delivery_position', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ trade_id: tradeData.id })
    });
    
    const result = await response.json();
    
    if (result.success) {
      showToast('POSITION REOPENED', 'success');
      tradeData.status = 'open';
      
      const inputs = document.querySelectorAll('input, button, select');
      inputs.forEach(input => {
        input.disabled = false;
        input.style.opacity = '1';
      });
      
      const closeBtn = document.getElementById('closeBtn');
      closeBtn.textContent = 'Close Position';
      closeBtn.className = 'btn-sell';
      closeBtn.onclick = () => {
        if (confirm('Are you sure you want to close this position?')) {
          closePosition();
        }
      };
    } else {
      showToast('Error: ' + result.error, 'error');
    }
  } catch (error) {
    showToast('Network error: ' + error.message, 'error');
  }
}

function updatePositionUI(trade) {
  document.getElementById('ts-capital').textContent = `₹${trade.capital_used.toLocaleString()}`;
  document.getElementById('ts-rr').textContent = `1:${trade.rr_ratio}`;
  document.getElementById('ts-profit').textContent = `${trade.expected_return}%`;
  document.getElementById('ts-risk').textContent = `${trade.risk_percent}%`;
  
  document.getElementById('inpAvgPrice').value = trade.avg_price;
  document.getElementById('inpQty').value = trade.quantity;
  document.getElementById('inpSL').value = trade.stop_loss_price;
  document.getElementById('inpTarget').value = trade.target_price;
  
  Object.assign(tradeData, trade);
}

/* ================== AI EXIT PLANNER ENGINE ================== */
const $ = (id)=>document.getElementById(id);
const log = (msg)=>{ const t = new Date().toLocaleTimeString(); $('ailog').insertAdjacentHTML('beforeend', `<div><span style="color:#6ea9ff">[${t}]</span> ${msg}</div>`); $('ailog').scrollTop = $('ailog').scrollHeight; }
const format = (n, d=2)=> Number(n).toFixed(d);

function leveragedMove(entry, pct){ return (entry/leverageMultiplier) * (pct/100); }
function priceFromPct(entry, pct, side){
  return side === 'buy' ? entry + leveragedMove(entry, pct)
                        : entry - leveragedMove(entry, pct);
}

function getRuleSet(qty) {
  if (qty <= 3) {
    return {
      name: 'Small',
      slPercent: 2.0,
      exits: [{ percent: 5.0, allocation: 100 }]
    };
  } else if (qty <= 10) {
    return {
      name: 'Medium',
      slPercent: 2.0,
      exits: [{ percent: 3.0, allocation: 30 }, { percent: 6.0, allocation: 70 }]
    };
  } else {
    return {
      name: 'Large',
      slPercent: 1.5,
      exits: [{ percent: 2.5, allocation: 20 }, { percent: 5.0, allocation: 40 }, { percent: 7.0, allocation: 40 }]
    };
  }
}

function getEntryAndQty(){
  const e = parseFloat(document.getElementById('inpAvgPrice').value);
  const q = parseInt(document.getElementById('inpQty').value,10);
  return {entry:e, qty:q};
}

async function makePlan(){
  const {entry, qty} = getEntryAndQty();
  
  if(!(entry>0 && qty>0)){
    alert('Please enter a valid Average Price and Quantity in the Position Management section.');
    return;
  }

  $('ailog').innerHTML = '';
  $('plan').innerHTML = '<div style="text-align:center;padding:20px;color:#8f94fb;"><i class="fas fa-brain" style="animation:brain-pulse 1.5s infinite;"></i><br>AI is analyzing your entry, quantity, and volatility bands...</div>';
  
  log('AI is analyzing your entry, quantity, and volatility bands...');
  await new Promise(resolve => setTimeout(resolve, 1200));
  
  $('plan').innerHTML = '<div style="text-align:center;padding:20px;color:#8f94fb;"><i class="fas fa-brain" style="animation:brain-pulse 1.5s infinite;"></i><br>AI is preparing your personalized exit strategy...</div>';
  log('AI is preparing your personalized exit strategy...');
  await new Promise(resolve => setTimeout(resolve, 1300));
  
  log('Parsing inputs…');
  setTimeout(()=>log(`Entry ₹${format(entry)} | Quantity ${qty}`), 200);
  
  const ruleSet = getRuleSet(qty);
  setTimeout(()=>log(`Applied ${ruleSet.name} rule set`), 400);

  const side = (tradeData.tradeType==='buy') ? 'buy' : 'sell';
  const trigSign = side==='buy' ? '+' : '-';
  const slSign   = side==='buy' ? '-' : '+';
  
  const slPrice = side==='buy'
    ? entry - leveragedMove(entry, ruleSet.slPercent)
    : entry + leveragedMove(entry, ruleSet.slPercent);
  
  let remainingQty = qty;
  const exits = [];
  
  for (let i = 0; i < ruleSet.exits.length; i++) {
    const exit = ruleSet.exits[i];
    const exitQty = Math.floor(qty * (exit.allocation / 100));
    const exitPrice = priceFromPct(entry, exit.percent, side);
    
    exits.push({
      index: i+1,
      percent: exit.percent,
      qty: exitQty,
      price: exitPrice,
      allocation: exit.allocation
    });
    
    remainingQty -= exitQty;
  }
  
  if (remainingQty > 0 && exits.length > 0) {
    exits[exits.length-1].qty += remainingQty;
  }
  
  aiPlanData = {ruleSet, entry, qty, slPrice, slPercent: ruleSet.slPercent, exits, side, trigSign, slSign};

  let planHTML = `
    <table aria-label="Exit Plan">
      <thead>
        <tr>
          <th>Leg</th>
          <th>Trigger</th>
          <th>Qty</th>
          <th>Exit Price</th>
          <th>Value</th>
          <th>Intent</th>
        </tr>
      </thead>
      <tbody>
  `;
  
  exits.forEach((exit, index) => {
    planHTML += `
        <tr>
          <td>Exit-${exit.index}</td>
          <td>${trigSign}${format(exit.percent,1)}%</td>
          <td>${exit.qty} (${exit.allocation}%)</td>
          <td>₹${format(exit.price)}</td>
          <td>₹${format(exit.price * exit.qty)}</td>
          <td><span class="pill ${index === 0 ? 'warn' : 'good'}">${index === 0 ? 'Recover Cost' : 'Lock Profit'}</span></td>
        </tr>
    `;
  });
  
  planHTML += `
        <tr>
          <td>Stop Loss</td>
          <td>${slSign}${format(ruleSet.slPercent,1)}%</td>
          <td>${qty}</td>
          <td>₹${format(slPrice)}</td>
          <td>₹${format(slPrice * qty)}</td>
          <td><span class="pill" style="background:rgba(255,59,48,.2);color:#ff3b30;border:1px solid rgba(255,59,48,.3)">Risk Management</span></td>
        </tr>
      </tbody>
    </table>
    <div class="actions" style="margin-top:8px;gap:8px;justify-content:flex-start">
      <button class="tiny-link" id="copyPlan">Copy Plan</button>
      <button class="tiny-link" id="copyLevels">Copy Levels Only</button>
    </div>
  `;

  setTimeout(() => {
    $('plan').innerHTML = planHTML;
    log('AI exit strategy generated successfully!');
  }, 300);

  setTimeout(()=>log(`Stop Loss set @ ₹${format(slPrice)} (${slSign}${ruleSet.slPercent}%)`), 600);
  
  exits.forEach((exit, index) => {
    setTimeout(()=>log(`Exit-${exit.index} set @ ₹${format(exit.price)} (${trigSign}${exit.percent}%) for ${exit.qty} qty (${exit.allocation}%)`), 800 + index * 200);
  });
}

$('btnPlan')?.addEventListener('click', makePlan);
$('btnReset')?.addEventListener('click', ()=>{
  $('ailog').innerHTML='';
  $('plan').innerHTML = '<p style="color:#aaa">Click <b>Generate AI Plan</b>. The exits will appear here based on quantity.</p>';
  aiPlanData = null;
});

/* ---------- Advanced Risk Management Calculator ---------- */
const capitalSlider = document.getElementById('capital-slider');
const capitalInput = document.getElementById('capital-input');
const riskSlider = document.getElementById('risk-slider');
const riskInput = document.getElementById('risk-input');
const returnSlider = document.getElementById('return-slider');
const returnInput = document.getElementById('return-input');
const qtySlider = document.getElementById('qty-slider');
const qtyInput = document.getElementById('qty-input');

// Sync sliders with inputs
function syncSliderInput(slider, input) {
  slider.addEventListener('input', () => {
    input.value = slider.value;
    updateRiskCalculations();
  });
  
  input.addEventListener('input', () => {
    slider.value = input.value;
    updateRiskCalculations();
  });
}

syncSliderInput(capitalSlider, capitalInput);
syncSliderInput(riskSlider, riskInput);
syncSliderInput(returnSlider, returnInput);
syncSliderInput(qtySlider, qtyInput);

// Risk preset buttons
document.querySelectorAll('.preset-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    const risk = parseFloat(btn.dataset.risk);
    riskSlider.value = risk;
    riskInput.value = risk;
    
    document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    
    updateRiskCalculations();
  });
});

function updateRiskCalculations() {
  const capital = parseFloat(capitalInput.value);
  const riskPct = parseFloat(riskInput.value);
  const returnPct = parseFloat(returnInput.value);
  const qty = parseInt(qtyInput.value);
  const avgPrice = parseFloat(document.getElementById('inpAvgPrice').value) || tradeData.avgPrice;
  
  // Position calculations
  const positionValue = avgPrice * qty;
  const capitalUsed = positionValue; // Delivery uses no leverage
  const riskAmount = capital * (riskPct / 100);
  const expectedProfit = positionValue * (returnPct / 100);
  const rrRatio = returnPct / riskPct;
  
  // Price calculations
  const riskPerShare = riskAmount / qty;
  const profitPerShare = expectedProfit / qty;
  
  let targetPrice, stopLossPrice;
  if (tradeData.tradeType === 'buy') {
    targetPrice = avgPrice + profitPerShare;
    stopLossPrice = avgPrice - riskPerShare;
  } else {
    targetPrice = avgPrice - profitPerShare;
    stopLossPrice = avgPrice + riskPerShare;
  }
  
  // Update UI
  document.getElementById('position-value').textContent = `₹${positionValue.toLocaleString()}`;
  document.getElementById('capital-used').textContent = `₹${capitalUsed.toLocaleString()}`;
  document.getElementById('risk-amount').textContent = `₹${riskAmount.toLocaleString()}`;
  document.getElementById('expected-profit').textContent = `₹${expectedProfit.toLocaleString()}`;
  document.getElementById('rr-ratio').textContent = `1:${rrRatio.toFixed(1)}`;
  document.getElementById('target-price').textContent = `₹${targetPrice.toFixed(2)}`;
  document.getElementById('stop-loss-price').textContent = `₹${stopLossPrice.toFixed(2)}`;
  
  // Update risk badge and heat meter
  const riskBadge = document.getElementById('risk-badge');
  const heatBar = document.getElementById('heat-bar');
  
  if (riskPct <= 1.5) {
    riskBadge.textContent = 'Conservative';
    riskBadge.className = 'risk-badge conservative';
  } else if (riskPct <= 3) {
    riskBadge.textContent = 'Balanced';
    riskBadge.className = 'risk-badge balanced';
  } else {
    riskBadge.textContent = 'Aggressive';
    riskBadge.className = 'risk-badge aggressive';
  }
  
  // Heat meter position (0-100%)
  const heatPosition = Math.min((riskPct / 10) * 100, 100);
  if (heatBar) {
    heatBar.style.setProperty('--heat-position', `${heatPosition}%`);
  }
}

/* ---------- Init ---------- */
(async function init(){
  modeSelect.value = 'ai';
  modeSelect.dispatchEvent(new Event('change'));
  
  // Initialize risk calculator
  updateRiskCalculations();
  
  // Load existing templates
  await loadSavedTemplate();
  
  if (tradeData.status === 'closed') {
    const inputs = document.querySelectorAll('input, button, select');
    inputs.forEach(input => {
      if (input.id !== 'backToManual' && input.id !== 'closeBtn') {
        input.disabled = true;
        input.style.opacity = '0.5';
      }
    });
    
    const closeBtn = document.getElementById('closeBtn');
    closeBtn.textContent = 'Reopen Position';
    closeBtn.className = 'btn-ai';
    closeBtn.onclick = () => {
      if (confirm('Are you sure you want to reopen this position?')) {
        reopenPosition();
      }
    };
  }
})();
</script>

<!-- Include Journal Integration Component -->
{% include 'calculator_journal_integration.html' %}

<script>
// Export current trade to journal function
function exportCurrentTradeToJournal() {
  const tradeData = {
    symbol: tradeData.symbol,
    avg_price: parseFloat(document.getElementById('inpAvgPrice').value),
    target_price: parseFloat(document.getElementById('inpTarget').value),
    stop_loss_price: parseFloat(document.getElementById('inpSL').value),
    quantity: parseInt(document.getElementById('inpQty').value),
    trade_type: tradeData.tradeType,
    calculator_type: 'delivery',
    total_risk: tradeData.total_risk,
    total_reward: tradeData.total_reward,
    capital_used: tradeData.capital_used,
    rr_ratio: tradeData.rr_ratio,
    expected_return: tradeData.expected_return,
    risk_percent: tradeData.risk_percent
  };
  
  showJournalIntegration(tradeData);
}
</script>

</body>
</html>