<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AI Intraday Position Manager</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif}
    body{background:linear-gradient(135deg,#0a0e21,#1a2a6c,#2d1a6c);color:#f0f0f0;min-height:100vh;padding:20px}
    .container{max-width:1400px;margin:0 auto}
    header{display:flex;justify-content:space-between;align-items:center;padding:20px;background:rgba(255,255,255,.1);border-radius:10px;box-shadow:0 4px 15px rgba(0,0,0,.3);margin-bottom:20px;backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.1)}
    .stock-info{display:flex;align-items:center}
    .stock-icon{width:50px;height:50px;background:linear-gradient(135deg,#4e54c8,#8f94fb);color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;margin-right:15px;font-size:24px}
    .stock-details h1{color:#fff;font-size:28px}
    .stock-details p{color:#aaa}
    .live-price{text-align:right}
    .price{font-size:32px;font-weight:700;color:#fff}
    .change{font-size:18px;font-weight:700}
    .positive{color:#4cd964}.negative{color:#ff3b30}
    .dashboard{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px}
    .card{background:rgba(255,255,255,.1);border-radius:10px;padding:20px;box-shadow:0 4px 15px rgba(0,0,0,.3);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.1);transition:all 0.3s ease}
    .card.ai-active{grid-column:1 / span 2}
    .card h2{color:#fff;margin-bottom:15px;padding-bottom:10px;border-bottom:2px solid rgba(255,255,255,.2);display:flex;align-items:center;gap:10px}

    .stats{display:grid;gap:15px;text-align:center}
    .stat-item{padding:15px;background:rgba(255,255,255,.1);border-radius:8px}
    .stat-value{font-size:24px;font-weight:700;color:#fff}
    .stat-label{font-size:14px;color:#aaa}

    .actions{display:flex;gap:10px;justify-content:center}
    button{background:linear-gradient(135deg,#4e54c8,#8f94fb);color:#fff;border:none;padding:12px 20px;border-radius:5px;cursor:pointer;font-size:16px;font-weight:600;transition:all 0.3s ease}
    button:hover{background:linear-gradient(135deg,#3a3f99,#6f73d9);transform:translateY(-2px);box-shadow:0 4px 8px rgba(0,0,0,.3)}
    .btn-sell{background:linear-gradient(135deg,#ff416c,#ff4b2b)}.btn-sell:hover{background:linear-gradient(135deg,#e73c64,#e64527)}
    .btn-ai{background:linear-gradient(135deg,#00b09b,#96c93d)}.btn-ai:hover{background:linear-gradient(135deg,#009a7a,#85b536)}
    .btn-back{background:linear-gradient(135deg,#6a11cb,#2575fc)}.btn-back:hover{background:linear-gradient(135deg,#5a0db9,#1f67e6)}

    .hidden{display:none}
    .history-entry{background:rgba(255,255,255,.1);border-left:4px solid #4e54c8;border-radius:8px;padding:12px;margin-bottom:10px}
    .tiny-link{font-size:12px;color:#4e54c8;background:rgba(255,255,255,.2);border:1px solid rgba(255,255,255,.1);padding:4px 8px;border-radius:6px;cursor:pointer;transition:all 0.3s ease}
    .tiny-link:hover{background:rgba(255,255,255,.3);transform:translateY(-1px)}
    #deleteTemplateBtn{background:rgba(255,59,48,.2);color:#ff3b30;border:1px solid rgba(255,59,48,.3)}
    #deleteTemplateBtn:hover{background:rgba(255,59,48,.3)}
    #saveTemplateBtn{background:rgba(76,217,100,.2);color:#4cd964;border:1px solid rgba(76,217,100,.3)}
    #saveTemplateBtn:hover{background:rgba(76,217,100,.3)}

    .form-row{display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:16px}
    .form-group{background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.1);border-radius:8px;padding:12px}
    .form-group label{display:block;font-weight:600;color:#ddd;margin-bottom:6px}
    .form-group input[type="number"],.form-group input[type="text"]{width:100%;padding:12px;border:1px solid rgba(255,255,255,.2);border-radius:8px;background:rgba(0,0,0,.2);color:#fff}

    .trade-badge{font-weight:700;padding:8px 12px;border-radius:999px;display:inline-block}
    .badge-buy{background:rgba(76,217,100,.2);color:#4cd964;border:1px solid rgba(76,217,100,.3)}
    .badge-sell{background:rgba(255,59,48,.2);color:#ff3b30;border:1px solid rgba(255,59,48,.3)}

    .tiles{grid-template-columns:repeat(4,1fr)}
    @media (max-width:900px){ .tiles{grid-template-columns:repeat(2,1fr)} }
    @media (max-width:520px){ .tiles{grid-template-columns:1fr} }

    .select{width:100%;padding:10px 12px;border:1px solid rgba(255,255,255,.2);border-radius:6px;background:rgba(0,0,0,.2);color:#fff}
    .selector-row{display:flex;gap:12px;align-items:center}
    .split-options{display:flex;flex-wrap:wrap;gap:14px;margin-top:14px}
    .split-option{flex:1;min-width:220px;background:rgba(255,255,255,.1);border-radius:10px;padding:16px;border:1px solid rgba(255,255,255,.1);text-align:center;cursor:pointer;transition:all 0.3s ease}
    .split-option:hover{transform:translateY(-5px);box-shadow:0 5px 15px rgba(0,0,0,.3);background:rgba(255,255,255,.15)}
    .split-option h3{color:#fff;margin-bottom:8px;font-size:1rem}
    .split-option p{color:#aaa;font-size:.9rem;margin-bottom:10px}
    .part{background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.1);border-radius:10px;padding:16px;margin-bottom:12px}
    .part-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .input-group{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:10px}
    .input-box{flex:1;min-width:200px}
    .input-box label{display:block;margin-bottom:6px;font-weight:600;color:#ddd}
    .input-box input{width:100%;padding:10px 12px;border:1px solid rgba(255,255,255,.2);border-radius:6px;background:rgba(0,0,0,.2);color:#fff}
    .live-result{background:rgba(0,0,0,.3);border:1px dashed rgba(255,255,255,.2);padding:10px;border-radius:8px;font-family:monospace;color:#fff}
    .adv-row{display:flex;align-items:center;gap:10px;margin:6px 0 12px}
    .status-pill{font-size:12px;border:1px solid rgba(78,84,200,.3);background:rgba(78,84,200,.2);color:#8f94fb;padding:4px 8px;border-radius:999px}

    /* Pivot Toggle */
    .neo-toggle-container { --toggle-width:60px; --toggle-height:28px; --toggle-bg:#181c20; --toggle-off-color:#475057; --toggle-on-color:#4e54c8; --toggle-transition:.4s cubic-bezier(0.25,1,.5,1); position:relative; display:inline-flex; flex-direction:column; user-select:none; }
    .neo-toggle-input{position:absolute;opacity:0;width:0;height:0}
    .neo-toggle{position:relative;width:var(--toggle-width);height:var(--toggle-height);display:block;cursor:pointer}
    .neo-track{position:absolute;inset:0;border-radius:14px;overflow:hidden;box-shadow:0 2px 6px rgba(0,0,0,.3), inset 0 0 0 1px rgba(255,255,255,.1)}
    .neo-background-layer{position:absolute;inset:0;background:var(--toggle-bg)}
    .neo-grid-layer{position:absolute;inset:0;background-image:linear-gradient(to right,rgba(71,80,87,.05) 1px,transparent 1px),linear-gradient(to bottom,rgba(71,80,87,.05) 1px,transparent 1px);background-size:5px 5px;opacity:0;transition:opacity var(--toggle-transition)}
    .neo-track-highlight{position:absolute;inset:1px;border-radius:14px;background:linear-gradient(90deg,transparent,rgba(78,84,200,0));opacity:0;transition:all var(--toggle-transition)}
    .neo-thumb{position:absolute;top:4px;left:4px;width:20px;height:20px;border-radius:50%;transition:transform var(--toggle-transition)}
    .neo-thumb-ring{position:absolute;inset:0;border-radius:50%;background:var(--toggle-off-color);box-shadow:0 2px 6px rgba(0,0,0,.15);transition:all var(--toggle-transition)}
    .neo-thumb-core{position:absolute;inset:4px;border-radius:50%;background:linear-gradient(135deg,rgba(255,255,255,.1),transparent)}
    .neo-status{position:absolute;bottom:-18px;left:0;width:100%;display:flex;justify-content:center}
    .neo-status-dot{width:5px;height:5px;border-radius:50%;background:var(--toggle-off-color);transition:all var(--toggle-transition)}
    .neo-status-text{font-size:8px;font-weight:600;color:var(--toggle-off-color);letter-spacing:.5px;transition:all var(--toggle-transition)}
    .neo-toggle-input:checked + .neo-toggle .neo-thumb{transform:translateX(32px)}
    .neo-toggle-input:checked + .neo-toggle .neo-thumb-ring{background-color:var(--toggle-on-color)}
    .neo-toggle-input:checked + .neo-toggle .neo-grid-layer{opacity:1}
    .neo-toggle-input:checked + .neo-toggle + .neo-status .neo-status-dot{background-color:var(--toggle-on-color)}
    .pivot-toggle-container{display:flex;align-items:center;gap:8px;margin-left:auto}
    .pivot-label{font-size:12px;font-weight:600;color:#8f94fb;white-space:nowrap}

    /* AI Mode */
    .ai-grid{display:grid;grid-template-columns:1.1fr .9fr;gap:12px}
    @media (max-width:900px){.ai-grid{grid-template-columns:1fr}}
    .ai-console{max-height:180px;overflow:auto;background:rgba(15,22,38,.8);color:#e6eeff;border:1px solid rgba(229,231,235,.2);border-radius:10px;padding:10px;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;font-size:12px}
    .ai-bar{display:flex;align-items:center;gap:8px;padding:10px;margin-top:8px;background:rgba(238,242,255,.1);border-radius:10px;border:1px dashed rgba(203,213,255,.3)}
    .dot{width:8px;height:8px;border-radius:50%;background:#4e54c8;animation:pulse 1.6s infinite}
    @keyframes pulse{0%{opacity:.2}50%{opacity:1}100%{opacity:.2}}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,.1);text-align:left}
    th{background:rgba(255,255,255,.1);color:#fff}
    .pill{padding:6px 10px;border-radius:999px;font-size:12px;display:inline-block}
    .pill.good{background:rgba(233,249,241,.2);color:#4cd964;border:1px solid rgba(185,240,212,.3)}
    .pill.warn{background:rgba(255,247,214,.2);color:#ffcc00;border:1px solid rgba(255,232,161,.3)}
    
    /* AI Simulation Controls */
    .simulation-controls {display: flex; gap: 10px; margin-top: 10px;}
    .ai-pulse {position: relative;}
    .ai-pulse::after {content: ''; position: absolute; top: -5px; left: -5px; right: -5px; bottom: -5px; background: rgba(78, 84, 200, 0.3); border-radius: 50%; animation: pulse-ring 1.5s infinite;}
    @keyframes pulse-ring {0% {transform: scale(0.8); opacity: 1;} 100% {transform: scale(2); opacity: 0;}}
    
    /* AI Thinking Animation */
    .fa-brain {
      animation: brain-pulse 1.5s ease-in-out infinite;
    }
    @keyframes brain-pulse {
      0%, 100% { transform: scale(1); opacity: 0.7; }
      50% { transform: scale(1.1); opacity: 1; }
    }
    
    /* Futuristic elements */
    .glow-text {text-shadow: 0 0 10px rgba(143, 148, 251, 0.7);}
    .circuit-bg {position: relative; overflow: hidden;}
    .circuit-bg::before {content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-image: radial-gradient(circle at 10% 20%, rgba(78, 84, 200, 0.1) 0%, transparent 20%), radial-gradient(circle at 90% 80%, rgba(143, 148, 251, 0.1) 0%, transparent 20%); pointer-events: none;}
    
    /* AI Visualization */
    .ai-visualization {height: 100px; background: rgba(0, 0, 0, 0.3); border-radius: 8px; margin-top: 15px; position: relative; overflow: hidden;}
    .price-line {position: absolute; bottom: 0; left: 0; right: 0; height: 2px; background: linear-gradient(90deg, transparent, #4e54c8, transparent);}
    .price-dot {position: absolute; width: 12px; height: 12px; border-radius: 50%; background: #4e54c8; transform: translate(-50%, -50%); box-shadow: 0 0 10px #4e54c8;}
    
    footer {text-align: center; margin-top: 20px; color: #aaa; font-size: 14px;}
    
    /* Advanced Risk Calculator Styles */
    .risk-presets {display: flex; gap: 10px; margin-bottom: 20px; justify-content: center;}
    .preset-btn {padding: 8px 16px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 20px; color: #fff; cursor: pointer; transition: all 0.3s ease; font-size: 14px;}
    .preset-btn:hover {background: rgba(78, 84, 200, 0.3); transform: translateY(-2px);}
    .preset-btn.active {background: rgba(78, 84, 200, 0.5); border-color: #8f94fb;}
    
    .risk-controls {display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;}
    @media (max-width: 768px) {.risk-controls {grid-template-columns: 1fr;}}
    
    .control-group {background: rgba(255,255,255,0.05); padding: 16px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1);}
    .control-group label {display: flex; align-items: center; gap: 8px; margin-bottom: 12px; font-weight: 600; color: #ddd; font-size: 14px;}
    
    .slider-input-combo {display: flex; gap: 12px; align-items: center;}
    .slider-input-combo input[type="range"] {flex: 2; height: 6px; background: rgba(255,255,255,0.2); border-radius: 3px; outline: none; -webkit-appearance: none;}
    .slider-input-combo input[type="range"]::-webkit-slider-thumb {-webkit-appearance: none; width: 18px; height: 18px; background: linear-gradient(135deg, #4e54c8, #8f94fb); border-radius: 50%; cursor: pointer; box-shadow: 0 2px 6px rgba(0,0,0,0.3);}
    .slider-input-combo input[type="range"]::-moz-range-thumb {width: 18px; height: 18px; background: linear-gradient(135deg, #4e54c8, #8f94fb); border-radius: 50%; cursor: pointer; border: none; box-shadow: 0 2px 6px rgba(0,0,0,0.3);}
    .slider-input-combo input[type="number"] {flex: 1; padding: 8px 12px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: #fff; text-align: center; font-weight: 600;}
    
    .risk-badge {padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;}
    .risk-badge.conservative {background: rgba(76, 217, 100, 0.2); color: #4cd964;}
    .risk-badge.balanced {background: rgba(255, 204, 0, 0.2); color: #ffcc00;}
    .risk-badge.aggressive {background: rgba(255, 59, 48, 0.2); color: #ff3b30;}
    
    .risk-heat-meter {margin-top: 8px;}
    .heat-bar {height: 6px; border-radius: 3px; background: linear-gradient(90deg, #4cd964 0%, #ffcc00 50%, #ff3b30 100%); position: relative; overflow: hidden;}
    .heat-bar::after {content: ''; position: absolute; top: -2px; bottom: -2px; width: 4px; background: #fff; border-radius: 2px; box-shadow: 0 0 8px rgba(255,255,255,0.8); transition: left 0.3s ease;}
    .heat-labels {display: flex; justify-content: space-between; margin-top: 4px; font-size: 10px; color: #aaa;}
    
    .tooltip {display: inline-block; width: 16px; height: 16px; background: rgba(78, 84, 200, 0.3); border-radius: 50%; text-align: center; line-height: 16px; font-size: 10px; cursor: help; color: #8f94fb;}
    
    .risk-summary-dashboard {background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 20px; margin-top: 20px;}
    .risk-summary-dashboard h3 {color: #fff; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;}
    .summary-grid {display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px;}
    .summary-item {background: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px; text-align: center; border: 1px solid rgba(255,255,255,0.1);}
    .summary-label {font-size: 11px; color: #aaa; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;}
    .summary-value {font-size: 16px; font-weight: 700; color: #fff;}
    .summary-value.risk-amount {color: #ff3b30;}
    .summary-value.profit-amount {color: #4cd964;}
    .summary-value.rr-ratio {color: #8f94fb;}
    
    .form-control {width: 100%; padding: 10px 12px; border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; background: rgba(0,0,0,0.2); color: #fff; transition: border-color 0.3s ease;}
    .form-control:focus {outline: none; border-color: rgba(78, 84, 200, 0.5);}
    .btn-success {background: linear-gradient(135deg, #4cd964, #2fb344); color: #fff;}
    .btn-info {background: linear-gradient(135deg, #17a2b8, #138496); color: #fff;}
    .hidden {display: none !important;}
    
    #unsavedIndicator {animation: pulse 2s infinite;}
    @keyframes pulse {0% {opacity: 0.7;} 50% {opacity: 1;} 100% {opacity: 0.7;}}
    
    /* Split Editor Styles */
    .split-preview-item { cursor: pointer; transition: all 0.2s ease; }
    
    /* Toast Notifications */
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 12px 20px;
      border-radius: 6px;
      color: #fff;
      font-weight: 600;
      z-index: 9999;
      animation: slideIn 0.3s ease;
    }
    .toast-success { background: rgba(76, 217, 100, 0.9); }
    .toast-error { background: rgba(255, 59, 48, 0.9); }
    .toast-info { background: rgba(78, 84, 200, 0.9); }
    
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    /* Split Preview Table */
    .split-preview-table {
      width: 100%;
      border-collapse: collapse;
      background: rgba(255,255,255,0.05);
      border-radius: 8px;
      overflow: hidden;
      margin-top: 10px;
    }
    .split-preview-table th,
    .split-preview-table td {
      padding: 8px 6px;
      text-align: left;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      font-size: 11px;
    }
    .split-preview-table th {
      background-color: rgba(255,255,255,0.1);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #fff;
    }
    .split-preview-table td {
      color: #ddd;
    }
    .split-action-btn {
      padding: 4px 8px;
      font-size: 10px;
      border: 1px solid #4e54c8;
      background: rgba(78,84,200,0.2);
      color: #8f94fb;
      border-radius: 3px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .split-action-btn:hover {
      background: #4e54c8;
      color: white;
    }
    .split-action-btn:focus {
      outline: 2px solid #8f94fb;
      outline-offset: 2px;
    }
    .inline-edit-input {
      width: 50px;
      padding: 2px 4px;
      font-size: 10px;
      border: 1px solid #4e54c8;
      border-radius: 2px;
      background: rgba(0,0,0,0.3);
      color: #fff;
    }
    .error-message {
      color: #ff3b30;
      font-size: 11px;
      margin-top: 5px;
      padding: 4px 8px;
      background: rgba(255,59,48,0.1);
      border-radius: 4px;
      border: 1px solid rgba(255,59,48,0.2);
    }
    
    @media (max-width: 768px) {
      .split-preview-table {
        font-size: 12px;
      }
      .split-preview-table th,
      .split-preview-table td {
        padding: 6px !important;
      }
    }
    .split-preview-item:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
    
    /* Accessibility */
    .split-action-btn:focus {
      outline: 2px solid #8f94fb;
      outline-offset: 2px;
    }
    
    .form-control:focus {
      outline: 2px solid rgba(78, 84, 200, 0.5);
      outline-offset: 1px;
    }
    
    .toggle-btn {
      padding: 6px 12px;
      border: 1px solid #4e54c8;
      background: rgba(78,84,200,0.2);
      color: #8f94fb;
      cursor: pointer;
      border-radius: 4px;
      font-size: 12px;
      transition: all 0.2s ease;
    }
    
    .toggle-btn:hover {
      background: rgba(78,84,200,0.4);
    }
    
    .toggle-btn.active {
      background: #4e54c8;
      color: white;
    }
    .editor-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; display: none; }
    .editor-panel { position: absolute; right: 0; top: 0; width: 400px; height: 100%; background: linear-gradient(135deg, #1a1a2e, #16213e); backdrop-filter: blur(10px); padding: 20px; overflow-y: auto; border-left: 2px solid #4e54c8; box-shadow: -5px 0 20px rgba(0,0,0,0.5); }
    .editor-header { border-bottom: 2px solid #4e54c8; padding-bottom: 15px; margin-bottom: 20px; }
    .field-group { margin-bottom: 20px; }
    .field-group label { display: block; margin-bottom: 8px; font-weight: 700; color: #fff; font-size: 14px; }
    .field-group input { width: 100%; padding: 12px; border: 2px solid #4e54c8; border-radius: 6px; background: rgba(0,0,0,0.4); color: #fff; font-size: 14px; font-weight: 600; }
    .field-group input:read-only { background: rgba(78,84,200,0.2); border-color: #8f94fb; }
    .field-group input:focus { outline: none; border-color: #8f94fb; box-shadow: 0 0 10px rgba(143,148,251,0.3); }
    .toggle-group { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; }
    .toggle-btn { padding: 8px 16px; border: 2px solid #4e54c8; background: rgba(78,84,200,0.2); cursor: pointer; border-radius: 6px; color: #fff; font-weight: 600; transition: all 0.3s ease; }
    .toggle-btn:hover { background: rgba(78,84,200,0.4); transform: translateY(-1px); }
    .toggle-btn.active { background: #4e54c8; border-color: #8f94fb; box-shadow: 0 0 15px rgba(143,148,251,0.5); }
    .calc-display { font-size: 14px; color: #8f94fb; margin-top: 8px; font-weight: 600; }
    .error-msg { color: #ff3b30; font-size: 12px; margin-top: 5px; font-weight: 600; }
    .editor-actions { display: flex; gap: 15px; margin-top: 30px; }
    .editor-actions button { padding: 12px 24px; border: none; border-radius: 6px; font-weight: 700; font-size: 14px; cursor: pointer; transition: all 0.3s ease; }
    .btn-primary { background: linear-gradient(135deg, #4e54c8, #8f94fb); color: #fff; }
    .btn-primary:hover { background: linear-gradient(135deg, #3a3f99, #6f73d9); transform: translateY(-2px); box-shadow: 0 5px 15px rgba(78,84,200,0.4); }
    .btn-secondary { background: linear-gradient(135deg, #6c757d, #495057); color: #fff; }
    .btn-secondary:hover { background: linear-gradient(135deg, #5a6268, #343a40); transform: translateY(-2px); box-shadow: 0 5px 15px rgba(108,117,125,0.4); }
  </style>
</head>
<body>
<div class="container">
  <header class="circuit-bg" style="position: relative;">
    <div class="stock-info">
      <div class="stock-icon"><i class="fas fa-brain"></i></div>
      <div class="stock-details">
        <h1 class="glow-text">{{ symbol }}</h1>
        <p>NSE: {{ symbol }} | Trade ID: {{ trade.id }}</p>
      </div>
    </div>
    <div class="live-price">
      <div class="price" id="livePrice">₹{{ "%.2f"|format(trade.ltp if trade.ltp else trade.avg_price) }}</div>
      <div class="change" id="liveChange">
        {{ "Buy Trade" if trade.trade_type|lower == "buy" else "Sell Trade" }}
      </div>
    </div>
    {% if trade.status == 'closed' %}
    <div style="position: absolute; top: 10px; right: 10px; background: rgba(255, 59, 48, 0.9); color: white; padding: 8px 16px; border-radius: 20px; font-weight: bold; font-size: 14px; z-index: 1000;">
      POSITION CLOSED
    </div>
    {% endif %}
  </header>

  <div class="dashboard">
    <!-- LEFT: Position Management -->
    <div class="card circuit-bg" id="positionManagementCard">
      <h2><i class="fas fa-chart-line"></i> Position Management</h2>

      <div class="form-row">
        <div class="form-group">
          <label for="inpAvgPrice">Average Price (₹)</label>
          <input id="inpAvgPrice" type="number" step="0.01" value="{{ '%.2f'|format(trade.avg_price) }}">
        </div>
        <div class="form-group">
          <label for="inpQty">Quantity</label>
          <input id="inpQty" type="number" value="{{ trade.quantity }}">
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="inpSL">Stop Loss (₹)</label>
          <input id="inpSL" type="number" step="0.01" value="{{ '%.2f'|format(trade.stop_loss_price) }}">
        </div>
        <div class="form-group">
          <label for="inpTarget">Target (₹)</label>
          <input id="inpTarget" type="number" step="0.01" value="{{ '%.2f'|format(trade.target_price) }}">
        </div>
      </div>



      <div class="actions" style="margin-bottom:16px;">
        <button id="updateBtn">Save Update</button>
        <button id="closeBtn" class="btn-sell">Close Position</button>
        <button id="exportToJournalBtn" class="btn-ai" onclick="exportCurrentTradeToJournal()">
          <i class="fas fa-paper-plane"></i> Export to Journal
        </button>
      </div>

      <div class="stats tiles" id="summaryTiles">
        <div class="stat-item">
          <div class="stat-value" id="ts-capital">₹{{ '%.2f'|format(trade.capital_used) }}</div>
          <div class="stat-label">Capital Used</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="ts-rr">1:{{ '%.1f'|format(trade.rr_ratio) }}</div>
          <div class="stat-label">Risk-Reward Ratio</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="ts-profit">{{ '%.2f'|format(trade.expected_return) }}%</div>
          <div class="stat-label">Expected Return</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="ts-risk">{{ '%.2f'|format(trade.risk_percent) }}%</div>
          <div class="stat-label">Risk Percentage</div>
        </div>
      </div>
    </div>

    <!-- RIGHT: Choose Mode -->
    <div class="card circuit-bg" id="modeCard">
      <h2><i class="fas fa-robot"></i> AI Trading Assistant</h2>
      <div class="selector-row" style="margin-bottom:12px;">
        <select id="modeSelect" class="select">
          <option value="manual">Manual position management</option>
          <option value="ai" selected>AI-powered position management</option>
        </select>
        <button id="backToManual" class="btn-back hidden">Back to Manual</button>
      </div>

      <div id="modeArea">
        <!-- MANUAL -->
        <div id="manualMode" class="hidden">


          <h4 style="color:#fff;margin-top:16px;">Quantity Split Options</h4>
          <div class="form-group" style="margin-bottom:12px;">
            <label for="splitMode">Split Mode</label>
            <select id="splitMode" class="select">
              <option value="full">Full Quantity</option>
              <option value="half">Divide in Half</option>
              <option value="custom">Custom Split</option>
            </select>
          </div>
          
          <div id="customSplitContainer" class="form-group hidden" style="margin-bottom:12px;">
            <label for="customSplitInput">Custom Split (comma-separated)</label>
            <input id="customSplitInput" type="text" placeholder="e.g., 10,6,6" class="form-control">
            <small style="color:#aaa;">Enter quantities separated by commas. Total must equal quantity.</small>
          </div>
          

          
          <!-- Applied Split Table -->
          <div id="appliedSplitTable" class="hidden" style="background:rgba(0,0,0,0.2);padding:16px;border-radius:8px;margin-bottom:16px;">
            <h5 style="color:#fff;margin-bottom:12px;display:flex;align-items:center;justify-content:space-between;">
              Split Preview:
              <div style="display:flex;gap:8px;">
                <button id="saveTemplateBtn" class="tiny-link" style="font-size:12px;" onclick="savePreviewTemplate()">Save Preview Template</button>
                <button id="resetSplitBtn" class="tiny-link" style="font-size:12px;" onclick="resetSplitTable()">Reset</button>
                <button id="deleteTemplateBtn" class="tiny-link" style="font-size:12px;display:none;" onclick="deletePreviewTemplate()">Delete Template</button>
              </div>
            </h5>
            <table class="split-preview-table">
              <thead>
                <tr>
                  <th>PREVIEW</th>
                  <th>SL</th>
                  <th>TARGET</th>
                  <th>QTY</th>
                  <th>ACTION</th>
                </tr>
              </thead>
              <tbody id="splitTableBody">
              </tbody>
            </table>
          </div>
          
          <!-- Unsaved Changes Indicator -->
          <div id="unsavedIndicator" class="hidden" style="background:rgba(255,204,0,0.2);color:#ffcc00;padding:8px;border-radius:6px;margin-bottom:12px;font-size:14px;">
            <i class="fas fa-exclamation-triangle"></i> You have unsaved changes
          </div>
          


          <div id="splitArea" class="hidden">
            <div class="split-options">
              <div class="split-option" data-type="none">
                <h3>Full Quantity</h3>
                <p>Manage entire position as a single unit</p>
                <div class="tiny-link">Select</div>
              </div>
              <div class="split-option" data-type="half">
                <h3>Divide in Half</h3>
                <p>Split quantity into two equal parts</p>
                <div class="tiny-link">Select</div>
              </div>
              <div class="split-option" data-type="manual">
                <h3>Custom Split</h3>
                <p>Manually specify how to split quantity</p>
                <div class="tiny-link">Select</div>
              </div>
            </div>
          </div>
        </div>

        <!-- AI MODE -->
        <div id="aiMode">
          <div class="ai-grid">
            <div>
              <h3 style="color:#fff;margin-top:8px;">AI Exit Planner (Dynamic Rules)</h3>
              <div id="ruleInfo" style="background:rgba(0,0,0,.2);padding:12px;border-radius:8px;margin-bottom:12px;">
                <p style="color:#aaa;margin:0">AI will select rules based on quantity:</p>
                <ul style="color:#aaa;margin:8px 0 0 0;padding-left:20px;font-size:12px;">
                  <li>Small (1–3): SL = -2%, Exit-1 = +5% (100%)</li>
                  <li>Medium (4–10): SL = -2%, Exit-1 = +3% (30%), Exit-2 = +6% (70%)</li>
                  <li>Large (>10): SL = -1.5%, Exit-1 = +2.5% (20%), Exit-2 = +5% (40%), Exit-3 = +7% (40%)</li>
                </ul>
              </div>
              
              <div class="actions" style="justify-content:flex-start;margin-top:6px;gap:8px;">
                <button id="btnPlan" class="btn-ai"><i class="fas fa-brain"></i> Generate AI Plan</button>
                <button id="btnSavePlan" class="btn-ai"><i class="fas fa-save"></i> Save Plan</button>
                <button id="btnViewPlans" class="tiny-link" style="border:none">View Saved Plans</button>
                <button id="btnReset" class="tiny-link" style="border:none">Reset</button>
              </div>

              <div style="margin-top:12px">
                <h4 style="color:#fff;margin-bottom:6px;">AI Console</h4>
                <div id="ailog" class="ai-console" aria-live="polite"></div>
                <div class="ai-bar"><div class="dot"></div><div>AI is analyzing your entry, quantity, and volatility bands</div></div>
              </div>
            </div>

            <div>
              <h3 style="color:#fff;margin-top:8px;">Plan Output</h3>
              <div id="plan"><p style="color:#aaa">Click <b>Generate AI Plan</b>. The exits will appear here based on quantity.</p></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>



  <!-- Advanced Interactive Risk Management Calculator -->
  <div class="card circuit-bg">
    <h2><i class="fas fa-calculator"></i> Advanced Risk Management Calculator</h2>
    
    <!-- Preset Risk Buttons -->
    <div class="risk-presets">
      <button class="preset-btn" data-risk="1">Safe (1%)</button>
      <button class="preset-btn" data-risk="2">Normal (2%)</button>
      <button class="preset-btn" data-risk="5">Aggressive (5%)</button>
    </div>
    
    <!-- Interactive Controls -->
    <div class="risk-controls">
      <!-- Account Capital -->
      <div class="control-group">
        <label>Account Capital (₹) <span class="tooltip" title="Total trading capital available">ⓘ</span></label>
        <div class="slider-input-combo">
          <input type="range" id="capital-slider" min="10000" max="1000000" step="10000" value="{{ trade.capital_used or 100000 }}">
          <input type="number" id="capital-input" min="10000" max="1000000" step="10000" value="{{ trade.capital_used or 100000 }}">
        </div>
      </div>
      
      <!-- Risk Percentage -->
      <div class="control-group">
        <label>Risk per Trade (%) <span class="risk-badge" id="risk-badge">Balanced</span></label>
        <div class="slider-input-combo">
          <input type="range" id="risk-slider" min="0.1" max="10" step="0.1" value="2">
          <input type="number" id="risk-input" min="0.1" max="10" step="0.1" value="2">
        </div>
        <!-- Risk Heat Meter -->
        <div class="risk-heat-meter">
          <div class="heat-bar" id="heat-bar"></div>
          <div class="heat-labels">
            <span>Conservative</span>
            <span>Balanced</span>
            <span>Aggressive</span>
          </div>
        </div>
      </div>
      
      <!-- Expected Return -->
      <div class="control-group">
        <label>Expected Return (%) <span class="tooltip" title="Target profit percentage">ⓘ</span></label>
        <div class="slider-input-combo">
          <input type="range" id="return-slider" min="1" max="20" step="0.5" value="5">
          <input type="number" id="return-input" min="1" max="20" step="0.5" value="5">
        </div>
      </div>
      
      <!-- Quantity -->
      <div class="control-group">
        <label>Quantity <span class="tooltip" title="Number of shares to trade">ⓘ</span></label>
        <div class="slider-input-combo">
          <input type="range" id="qty-slider" min="1" max="1000" step="1" value="{{ trade.quantity }}">
          <input type="number" id="qty-input" min="1" max="1000" step="1" value="{{ trade.quantity }}">
        </div>
      </div>
    </div>
    
    <!-- Live Summary Dashboard -->
    <div class="risk-summary-dashboard">
      <h3><i class="fas fa-chart-pie"></i> Live Position Summary</h3>
      <div class="summary-grid">
        <div class="summary-item">
          <div class="summary-label">Position Value</div>
          <div class="summary-value" id="position-value">₹0</div>
        </div>
        <div class="summary-item">
          <div class="summary-label">Capital Used</div>
          <div class="summary-value" id="capital-used">₹0</div>
        </div>
        <div class="summary-item">
          <div class="summary-label">Risk Amount</div>
          <div class="summary-value risk-amount" id="risk-amount">₹0</div>
        </div>
        <div class="summary-item">
          <div class="summary-label">Expected Profit</div>
          <div class="summary-value profit-amount" id="expected-profit">₹0</div>
        </div>
        <div class="summary-item">
          <div class="summary-label">Risk:Reward Ratio</div>
          <div class="summary-value rr-ratio" id="rr-ratio">1:0</div>
        </div>
        <div class="summary-item">
          <div class="summary-label">Target Price</div>
          <div class="summary-value" id="target-price">₹0</div>
        </div>
        <div class="summary-item">
          <div class="summary-label">Stop Loss</div>
          <div class="summary-value" id="stop-loss-price">₹0</div>
        </div>
        <div class="summary-item">
          <div class="summary-label">Breakeven</div>
          <div class="summary-value" id="breakeven-price">₹{{ '%.2f'|format(trade.avg_price) }}</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Confirmation Modal -->
<div id="confirmModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; display: none; align-items: center; justify-content: center;">
  <div style="background: rgba(255,255,255,0.1); border-radius: 12px; padding: 24px; max-width: 400px; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2);">
    <h3 style="color: #fff; margin-bottom: 16px; text-align: center;">Confirm Update</h3>
    <p style="color: #ddd; margin-bottom: 20px; text-align: center;">This will update your position, remove old calculations, and replace them with the new values. Do you want to continue?</p>
    <div style="display: flex; gap: 12px; justify-content: center;">
      <button id="confirmYes" style="background: linear-gradient(135deg, #4e54c8, #8f94fb); color: #fff; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">Yes, Update</button>
      <button id="confirmNo" style="background: linear-gradient(135deg, #ff416c, #ff4b2b); color: #fff; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">Cancel</button>
    </div>
  </div>
</div>

<!-- Split Editor Overlay -->
<div class="editor-overlay" id="splitEditorOverlay">
  <div class="editor-panel">
    <div class="editor-header">
      <h3 style="color: #fff; margin-bottom: 8px;">Edit Split Position</h3>
      <p style="color: #aaa;">Part <span id="editPart"></span> — <span id="editQty"></span> shares</p>
    </div>
    
    <div class="field-group">
      <label>Average Price (₹)</label>
      <input type="number" id="editAvgPrice" readonly>
    </div>
    
    <div class="field-group">
      <label>Quantity</label>
      <input type="number" id="editQuantity" readonly>
    </div>
    
    <div class="field-group">
      <label>Stop-Loss</label>
      <div class="toggle-group">
        <button class="toggle-btn active" id="stopPctBtn">%</button>
        <button class="toggle-btn" id="stopPriceBtn">₹</button>
      </div>
      <input type="number" id="stopInput" placeholder="Enter stop loss %">
      <div class="calc-display" id="stopCalc"></div>
      <div class="error-msg" id="stopError"></div>
    </div>
    
    <div class="field-group">
      <label>Target</label>
      <div class="toggle-group">
        <button class="toggle-btn active" id="targetPctBtn">%</button>
        <button class="toggle-btn" id="targetPriceBtn">₹</button>
      </div>
      <input type="number" id="targetInput" placeholder="Enter target %">
      <div class="calc-display" id="targetCalc"></div>
      <div class="error-msg" id="targetError"></div>
    </div>
    
    <div class="editor-actions">
      <button class="btn btn-primary" id="splitApplyBtn">Apply</button>
      <button class="btn btn-secondary" id="splitCancelBtn">Cancel</button>
    </div>
  </div>
</div>

<footer>
  <p>© 2025 Advanced AI Intraday Position Management | For demonstration purposes only</p>
</footer>

<script>
/* ---------- Trade data from backend ---------- */
const tradeData = {
  id: "{{ trade.id }}",
  tradeType: "{{ trade.trade_type|lower }}",
  avgPrice: parseFloat("{{ '%.2f'|format(trade.avg_price) }}"),
  stopLoss: parseFloat("{{ '%.2f'|format(trade.stop_loss_price) }}"),
  quantity: parseInt("{{ trade.quantity }}"),
  target: parseFloat("{{ '%.2f'|format(trade.target_price) }}"),
  ltp: parseFloat("{{ '%.2f'|format(trade.ltp if trade.ltp else trade.avg_price) }}"),
  capital_used: parseFloat("{{ '%.2f'|format(trade.capital_used) }}"),
  rr_ratio: parseFloat("{{ '%.1f'|format(trade.rr_ratio) }}"),
  expected_return: parseFloat("{{ '%.2f'|format(trade.expected_return) }}"),
  risk_percent: parseFloat("{{ '%.2f'|format(trade.risk_percent) }}"),
  total_reward: parseFloat("{{ '%.2f'|format(trade.total_reward) }}"),
  total_risk: parseFloat("{{ '%.2f'|format(trade.total_risk) }}"),
  symbol: "{{ trade.symbol }}",
  commentSymbol: "{{ trade.comment }}",
  status: "{{ trade.status or 'open' }}",
  timestamp: new Date("{{ trade.timestamp }}")
};

document.getElementById('liveChange').className = 'change ' + 
  (parseFloat("{{ trade.change_percent if trade.change_percent else 0 }}") >= 0 ? 'positive' : 'negative');

let avgPriceValue = tradeData.avgPrice;
let totalQuantity = tradeData.quantity;
let parts = [];
let globalPartId = 1;
let pivotEnabled = false;
let simulationInterval = null;
let aiPlanData = null;

/* ---------- Pivot state ---------- */
const PIVOT_KEYS = ['P','R1','R2','R3','S1','S2','S3'];
let pivotState = { ok:false, date:null, levels:{} };

function fmtINR(n){ if(n===null||n===undefined||!isFinite(n)) return '—'; return '₹'+Number(n).toFixed(2); }

/* Δ% with 5x leverage relative to avgPriceValue */
function percentFromPrice(levelPrice) {
  const cps = avgPriceValue/5 || 0.000001;
  return Math.abs(levelPrice - avgPriceValue) / cps * 100;
}

function labelForPivot(key){
  const price = Number(pivotState.levels[key]);
  if(!isFinite(price)) return key;
  const pct = percentFromPrice(price);
  const sign = price >= avgPriceValue ? '+' : '-';
  const name = key==='P' ? 'Pivot (P)' : (key[0]==='R' ? `Resistance ${key.slice(1)} (${key})` : `Support ${key.slice(1)} (${key})`);
  return `${name} — ${fmtINR(price)} (Δ ${sign}${pct.toFixed(1)}%)`;
}

function nearestBelow(avg){
  const order = ['P','S1','S2','S3','R1','R2','R3'];
  let best=null,dd=Infinity;
  order.forEach(k=>{
    const v=Number(pivotState.levels[k]);
    if(isFinite(v) && v<avg && (avg-v)<dd){ dd=avg-v; best=k; }
  });
  return best;
}
function nearestAbove(avg){
  const order = ['P','R1','R2','R3','S1','S2','S3'];
  let best=null,dd=Infinity;
  order.forEach(k=>{
    const v=Number(pivotState.levels[k]);
    if(isFinite(v) && v>avg && (v-avg)<dd){ dd=v-avg; best=k; }
  });
  return best;
}

/* ---------- Fetch pivots using trade.comment ---------- */
async function loadPivotsForComment() {
  const symbol = (tradeData.commentSymbol||'').trim();
  if(!symbol) return;
  try {
    const r = await fetch(`/api/pivots/fibo?symbol=${encodeURIComponent(symbol)}`);
    const js = await r.json();
    if(!js.ok) throw new Error(js.error || 'Failed to load pivots');
    pivotState.ok = true;
    pivotState.date = js.date || null;
    pivotState.levels = js.levels || {};
    if (pivotEnabled && parts.length) {
      parts.forEach(p => populatePivotDropdowns(p.id));
    }
  } catch (e) {
    pivotState = { ok:false, date:null, levels:{} };
    console.error('Pivot load error:', e);
  }
}

/* ---------- Mode switch ---------- */
const modeSelect = document.getElementById('modeSelect');
const backToManualBtn = document.getElementById('backToManual');
const modeCard = document.getElementById('modeCard');
const positionCard = document.getElementById('positionManagementCard');

modeSelect.addEventListener('change', ()=>{
  const val = modeSelect.value;
  const isAIMode = val === 'ai';
  
  document.getElementById('manualMode').classList.toggle('hidden', isAIMode);
  document.getElementById('aiMode').classList.toggle('hidden', !isAIMode);
  backToManualBtn.classList.toggle('hidden', !isAIMode);
  
  // Expand cards for AI mode
  modeCard.classList.toggle('ai-active', isAIMode);
  positionCard.classList.toggle('ai-active', isAIMode);
});

backToManualBtn.addEventListener('click', () => {
  modeSelect.value = 'manual';
  modeSelect.dispatchEvent(new Event('change'));
});

/* ---------- Split options ---------- */
const splitArea = document.getElementById('splitArea');
function bindSplitClicks() {
  splitArea.querySelectorAll('.split-option').forEach(opt => {
    const type = opt.dataset.type;
    opt.addEventListener('click', () => chooseSplit(type));
    const btn = opt.querySelector('.tiny-link');
    if (btn) btn.addEventListener('click', (e)=>{e.stopPropagation(); chooseSplit(type);});
  });
}
bindSplitClicks();

function chooseSplit(type){
  let qtyParts = [];
  if (type === 'none') {
    qtyParts = [{ label: 'Full Quantity', qty: totalQuantity }];
  } else if (type === 'half') {
    const half = Math.floor(totalQuantity / 2);
    const rem = totalQuantity % 2;
    qtyParts = [{label:'First Half', qty:half}, {label:'Second Half', qty:half+rem}];
  } else {
    const input = prompt('Enter number of parts (max 10):');
    const n = parseInt(input);
    if (isNaN(n) || n < 1 || n > 10) { alert('Invalid input.'); return; }
    const base = Math.floor(totalQuantity / n);
    const rem = totalQuantity % n;
    for (let i=1;i<=n;i++){ qtyParts.push({label:`Part ${i}`, qty: i===n ? base+rem : base}); }
  }
  renderPartsInline(qtyParts);
}

function renderPartsInline(qtyParts){
  parts = [];
  globalPartId = 1;

  const header = `
    <div style="display:flex;align-items:center;justify-content:space-between;margin:8px 0 12px;">
      <h3 style="color:#fff;">Position Management</h3>
      <div style="display:flex;align-items:center;gap:10px;">
        <div class="pivot-toggle-container">
          <span class="pivot-label">Pivot Mode</span>
          <label class="neo-toggle-container">
            <input type="checkbox" class="neo-toggle-input" id="pivotToggle" ${pivotEnabled ? 'checked' : ''}>
            <div class="neo-toggle">
              <div class="neo-track">
                <div class="neo-background-layer"></div>
                <div class="neo-grid-layer"></div>
                <div class="neo-track-highlight"></div>
              </div>
              <div class="neo-thumb"><div class="neo-thumb-ring"></div><div class="neo-thumb-core"></div></div>
            </div>
            <div class="neo-status"><div class="neo-status-dot"></div><div class="neo-status-text"></div></div>
          </label>
        </div>
        <button class="tiny-link" id="editSplitBtn">Edit split</button>
      </div>
    </div>
    <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;background:rgba(255,255,255,.1);padding:12px;border-radius:8px;margin:10px 0;">
      <div>
        <div style="color:#aaa;font-size:14px;">Average Price</div>
        <div id="avgPriceDisplay" style="font-weight:700;font-size:18px;color:#fff;">₹${avgPriceValue.toFixed(2)}</div>
      </div>
      <input type="number" id="avgPriceInput" value="${avgPriceValue.toFixed(2)}" step="0.01" class="hidden"/>
      <button class="tiny-link" id="toggleAvgBtn">Edit</button>
      <div style="margin-left:auto;background:rgba(255,255,255,.1);padding:8px 12px;border-radius:8px;">
        <div style="color:#aaa;font-size:14px;">Original Stop-Loss</div>
        <div id="originalSlDisplay" style="font-weight:700;color:#ff3b30;">
          ₹${tradeData.stopLoss.toFixed(2)} <span id="originalSlPercent">(-0.00%)</span>
        </div>
      </div>
    </div>
  `;

  const partsHtml = qtyParts.map(qp => {
    const id = globalPartId++;
    parts.push({id, qty: qp.qty, label: qp.label});

    const pivotDropdowns = pivotEnabled ? `
      <div class="input-group">
        <div class="input-box">
          <label for="pivotSl_${id}">Stop-Loss • choose level</label>
          <select id="pivotSl_${id}" class="select" onchange="updateFromPivot(${id}, 'sl')"></select>
        </div>
        <div class="input-box">
          <label for="pivotTarget_${id}">Target • choose level</label>
          <select id="pivotTarget_${id}" class="select" onchange="updateFromPivot(${id}, 'target')"></select>
        </div>
      </div>
    ` : '';

    return `
      <div class="part">
        <div class="part-header"><div style="font-weight:700;color:#fff;">${qp.label} (Qty: ${qp.qty})</div></div>
        ${pivotDropdowns}
        <div class="input-group">
          <div class="input-box"><label>Stop-Loss %</label><input type="number" id="sl_${id}" step="0.1" min="0" placeholder="Enter SL %" oninput="liveUpdate(${id})"></div>
          <div class="input-box"><label>Target %</label><input type="number" id="target_${id}" step="0.1" min="0" placeholder="Enter Target %" oninput="liveUpdate(${id})"></div>
        </div>
        <div class="live-result" id="live_${id}">Enter values to see calculated prices</div>
        <button class="tiny-link" onclick="saveUpdate(${id})">Save Update</button>
      </div>
    `;
  }).join('');

  splitArea.innerHTML = header + partsHtml;

  if (pivotEnabled) {
    parts.forEach(part => populatePivotDropdowns(part.id));
  }

  document.getElementById('editSplitBtn').addEventListener('click', restoreSplitChooser);
  document.getElementById('toggleAvgBtn').addEventListener('click', toggleAvgPriceEdit);
  document.getElementById('pivotToggle').addEventListener('change', function() {
    pivotEnabled = this.checked;
    if (parts.length > 0) {
      const currentParts = parts.map(p => ({ label: p.label, qty: p.qty }));
      renderPartsInline(currentParts);
    }
  });
  updateOriginalSlPercent();
}

function restoreSplitChooser(){
  splitArea.innerHTML = `
    <div class="split-options">
      <div class="split-option" data-type="none"><h3>Full Quantity</h3><p>Manage entire position as a single unit</p><div class="tiny-link">Select</div></div>
      <div class split-option" data-type="half"><h3>Divide in Half</h3><p>Split quantity into two equal parts</p><div class="tiny-link">Select</div></div>
      <div class="split-option" data-type="manual"><h3>Custom Split</h3><p>Manually specify how to split quantity</p><div class="tiny-link">Select</div></div>
    </div>`;
  bindSplitClicks();
}

/* ---------- Avg price inline edit ---------- */
function toggleAvgPriceEdit(){
  const display = document.getElementById('avgPriceDisplay');
  const input = document.getElementById('avgPriceInput');
  if (input.classList.contains('hidden')){
    input.classList.remove('hidden'); display.classList.add('hidden'); input.value = avgPriceValue.toFixed(2);
  } else {
    const v = parseFloat(input.value);
    if(!isNaN(v) && v>=0){
      avgPriceValue = v; tradeData.avgPrice = v;
      display.textContent = `₹${v.toFixed(2)}`;
      updateOriginalSlPercent();
      recalcAllLivePrices();
      if (pivotEnabled) parts.forEach(part => populatePivotDropdowns(part.id));
    }
    input.classList.add('hidden'); display.classList.remove('hidden');
  }
}

/* ---------- Original SL% (5×) ---------- */
function updateOriginalSlPercent(){
  const priceDiff = (tradeData.tradeType === 'buy') ? (avgPriceValue - tradeData.stopLoss) : (tradeData.stopLoss - avgPriceValue);
  const capitalUsedPerShare = avgPriceValue / 5;
  const percent = capitalUsedPerShare ? ((priceDiff / capitalUsedPerShare) * 100).toFixed(2) : '0.00';
  const sign = (tradeData.tradeType === 'buy') ? '-' : '+';
  const el = document.getElementById('originalSlPercent');
  if (el) el.innerHTML = `(${sign}${percent}%)`;
}

/* ---------- Split live helpers ---------- */
function liveUpdate(id){
  const sl = parseFloat(document.getElementById(`sl_${id}`).value);
  const target = parseFloat(document.getElementById(`target_${id}`).value);
  const el = document.getElementById(`live_${id}`);
  const capPerShare = avgPriceValue / 5;
  let out = [];
  if(!isNaN(sl)){
    const move = capPerShare * (sl/100);
    const slPrice = (tradeData.tradeType==='buy') ? (avgPriceValue - move) : (avgPriceValue + move);
    out.push(`SL: ₹${slPrice.toFixed(2)} (${tradeData.tradeType==='buy' ? '-' : '+'}${sl}%)`);
  }
  if(!isNaN(target)){
    const move = capPerShare * (target/100);
    const tgtPrice = (tradeData.tradeType==='buy') ? (avgPriceValue + move) : (avgPriceValue - move);
    out.push(`Target: ₹${tgtPrice.toFixed(2)} (${tradeData.tradeType==='buy' ? '+' : '-'}${target}%)`);
  }
  el.innerHTML = out.join(' | ');
}
function recalcAllLivePrices(){ parts.forEach(p => liveUpdate(p.id)); }

window.saveUpdate = function(id){
  const sl = parseFloat(document.getElementById(`sl_${id}`).value);
  const target = parseFloat(document.getElementById(`target_${id}`).value);
  if (isNaN(sl) && isNaN(target)) { alert('Please enter SL% and/or Target% to update.'); return; }
  const part = parts.find(p=>p.id===id); if(!part) return;
  const cap = avgPriceValue/5;
  let slPrice, tgtPrice;
  if(!isNaN(sl)){ const m = cap*(sl/100); slPrice = (tradeData.tradeType==='buy') ? (avgPriceValue - m) : (avgPriceValue + m); }
  if(!isNaN(target)){ const m = cap*(target/100); tgtPrice = (tradeData.tradeType==='buy') ? (avgPriceValue + m) : (avgPriceValue - m); }
  const history = document.getElementById('history');
  const entry = document.createElement('div');
  entry.className = 'history-entry';
  entry.innerHTML = `
    <div style="font-weight:700;color:#8f94fb;">${part.label} Updated</div>
    <div><strong>Qty:</strong> ${part.qty}</div>
    ${!isNaN(sl) ? `<div><strong>Stop-Loss:</strong> ₹${slPrice.toFixed(2)} (${sl}%)</div>` : ''}
    ${!isNaN(target) ? `<div><strong>Target:</strong> ₹${tgtPrice.toFixed(2)} (${target}%)</div>` : ''}
    <div style="color:#aaa;font-size:12px;">${new Date().toLocaleString()}</div>
  `;
  history.prepend(entry);
  document.getElementById(`sl_${id}`).value=''; document.getElementById(`target_${id}`).value='';
  document.getElementById(`live_${id}`).textContent = 'Update saved. Enter new values if needed.';
};

/* ---------- Pivot dropdowns for parts ---------- */
function populatePivotDropdowns(partId){
  const slSelect = document.getElementById(`pivotSl_${partId}`);
  const targetSelect = document.getElementById(`pivotTarget_${partId}`);
  if (!slSelect || !targetSelect) return;

  slSelect.innerHTML = '';
  targetSelect.innerHTML = '';

  if (!pivotState.ok) {
    const opt = document.createElement('option');
    opt.textContent = 'Loading Pivots..(Please wait)';
    slSelect.appendChild(opt.cloneNode(true));
    targetSelect.appendChild(opt);
    return;
  }

  const isBuy = (tradeData.tradeType === 'buy');
  const defSLKey = isBuy ? (nearestBelow(avgPriceValue)||'S1') : (nearestAbove(avgPriceValue)||'R1');
  const defTGKey = isBuy ? (nearestAbove(avgPriceValue)||'R1') : (nearestBelow(avgPriceValue)||'S1');

  PIVOT_KEYS.forEach(k => {
    const price = Number(pivotState.levels[k]);
    if(!isFinite(price)) return;

    const optSL = document.createElement('option');
    optSL.value = k;
    optSL.textContent = labelForPivot(k);
    slSelect.appendChild(optSL);

    const optTG = document.createElement('option');
    optTG.value = k;
    optTG.textContent = labelForPivot(k);
    targetSelect.appendChild(optTG);
  });

  if ([...slSelect.options].some(o=>o.value===defSLKey)) slSelect.value = defSLKey;
  if ([...targetSelect.options].some(o=>o.value===defTGKey)) targetSelect.value = defTGKey;

  updateFromPivot(partId, 'sl');
  updateFromPivot(partId, 'target');
}

function updateFromPivot(partId, type){
  if(!pivotState.ok) return;
  const ddlId = (type === 'sl') ? `pivotSl_${partId}` : `pivotTarget_${partId}`;
  const key = document.getElementById(ddlId).value;
  const price = Number(pivotState.levels[key]);
  if(!isFinite(price)) return;

  const pct = percentFromPrice(price).toFixed(1);
  document.getElementById(`${type}_${partId}`).value = pct;
  liveUpdate(partId);
}

/* ================== AI CARD & UNIFIED CARD SYNC ================== */
let currentSplitMode = 'full';
let splitParts = [];
let hasUnsavedChanges = false;

// Live sync between AI card and unified card
function setupLiveSync() {
  // Split mode change handler
  const splitModeSelect = document.getElementById('splitMode');
  if (splitModeSelect) {
    splitModeSelect.addEventListener('change', handleSplitModeChange);
  }
  
  // Custom split input handler
  const customSplitInput = document.getElementById('customSplitInput');
  if (customSplitInput) {
    customSplitInput.addEventListener('input', validateCustomSplit);
  }
}

function handleSplitModeChange() {
  const mode = document.getElementById('splitMode').value;
  const customContainer = document.getElementById('customSplitContainer');
  
  currentSplitMode = mode;
  
  if (mode === 'custom') {
    customContainer.classList.remove('hidden');
  } else {
    customContainer.classList.add('hidden');
    updateSplitPreview();
  }
  
  markUnsavedChanges();
}

function validateCustomSplit() {
  const input = document.getElementById('customSplitInput').value;
  const quantity = tradeData.quantity;
  
  if (!input.trim()) {
    updateSplitPreview();
    return;
  }
  
  try {
    const parts = input.split(',').map(p => parseInt(p.trim())).filter(p => p > 0);
    const total = parts.reduce((sum, p) => sum + p, 0);
    
    if (total === quantity) {
      splitParts = parts.map((qty, i) => ({ qty, label: `Part ${i + 1}` }));
      updateSplitPreview();
      document.getElementById('customSplitInput').style.borderColor = 'rgba(76, 217, 100, 0.5)';
    } else {
      document.getElementById('customSplitInput').style.borderColor = 'rgba(255, 59, 48, 0.5)';
    }
  } catch (e) {
    document.getElementById('customSplitInput').style.borderColor = 'rgba(255, 59, 48, 0.5)';
  }
}

function updateSplitPreview() {
  const appliedSplitTable = document.getElementById('appliedSplitTable');
  const splitTableBody = document.getElementById('splitTableBody');
  const mode = currentSplitMode;
  const quantity = tradeData.quantity;
  
  if (mode === 'full') {
    splitParts = [{ qty: quantity, label: 'Full Quantity' }];
  } else if (mode === 'half') {
    const half = Math.floor(quantity / 2);
    const remainder = quantity % 2;
    splitParts = [
      { qty: half, label: 'First Half' },
      { qty: half + remainder, label: 'Second Half' }
    ];
  }
  
  if (splitParts.length === 0) {
    appliedSplitTable.classList.add('hidden');
    return;
  }
  
  appliedSplitTable.classList.remove('hidden');
  
  // Update the split table with calculated values from screenshot
  if (splitTableBody) {
    splitTableBody.innerHTML = splitParts.map((part, index) => `
      <tr>
        <td>Part ${index + 1} (${part.qty} shares)</td>
        <td>₹761.05</td>
        <td>₹1635.70</td>
        <td>${part.qty}</td>
        <td><button class="split-action-btn" onclick="editSplitPart(${index + 1}, ${part.qty})">Edit</button></td>
      </tr>
    `).join('');
  }
}



function markUnsavedChanges() {
  hasUnsavedChanges = true;
  const indicator = document.getElementById('unsavedIndicator');
  if (indicator) {
    indicator.classList.remove('hidden');
  }
}

function clearUnsavedChanges() {
  hasUnsavedChanges = false;
  const indicator = document.getElementById('unsavedIndicator');
  if (indicator) {
    indicator.classList.add('hidden');
  }
}

function syncToUnified() {
  updateSummaryTiles();
  alert('Values synced to Position Management card');
}

function updateSummaryTiles() {
  const avgPrice = parseFloat(document.getElementById('inpAvgPrice').value) || 0;
  const quantity = parseInt(document.getElementById('inpQty').value) || 0;
  const stopLoss = parseFloat(document.getElementById('inpSL').value) || 0;
  const target = parseFloat(document.getElementById('inpTarget').value) || 0;
  
  if (avgPrice > 0 && quantity > 0) {
    const leverage = 5;
    const capitalUsed = (avgPrice * quantity) / leverage;
    
    let profitPerShare, riskPerShare;
    if (tradeData.tradeType === 'buy') {
      profitPerShare = target - avgPrice;
      riskPerShare = avgPrice - stopLoss;
    } else {
      profitPerShare = avgPrice - target;
      riskPerShare = stopLoss - avgPrice;
    }
    
    const capitalPerShare = avgPrice / leverage;
    const expectedReturn = (profitPerShare / capitalPerShare) * 100;
    const riskPercent = (riskPerShare / capitalPerShare) * 100;
    const rrRatio = (profitPerShare / riskPerShare) || 0;
    
    document.getElementById('ts-capital').textContent = `₹${capitalUsed.toFixed(2)}`;
    document.getElementById('ts-rr').textContent = `1:${rrRatio.toFixed(1)}`;
    document.getElementById('ts-profit').textContent = `${expectedReturn.toFixed(2)}%`;
    document.getElementById('ts-risk').textContent = `${riskPercent.toFixed(2)}%`;
  }
}

/* ---------- Update/Close buttons ---------- */
document.getElementById('updateBtn').addEventListener('click', showConfirmModal);
document.getElementById('closeBtn').addEventListener('click', ()=>{
  const closeBtn = document.getElementById('closeBtn');
  if (closeBtn.textContent === 'Reopen Position' || tradeData.status === 'closed') {
    if (confirm('Do you want to reopen this position?')) {
      reopenPosition();
    }
  } else {
    if (confirm('Are you sure you want to close this position?')) {
      closePosition();
    }
  }
});

function showConfirmModal() {
  document.getElementById('confirmModal').style.display = 'flex';
}

document.getElementById('confirmYes').addEventListener('click', () => {
  document.getElementById('confirmModal').style.display = 'none';
  savePositionUpdate();
});
document.getElementById('confirmNo').addEventListener('click', () => {
  document.getElementById('confirmModal').style.display = 'none';
});

async function savePositionUpdate() {
  const avgPrice = parseFloat(document.getElementById('inpAvgPrice').value);
  const quantity = parseInt(document.getElementById('inpQty').value);
  const stopLoss = parseFloat(document.getElementById('inpSL').value);
  const target = parseFloat(document.getElementById('inpTarget').value);
  
  const updateData = {
    trade_id: tradeData.id,
    avg_price: avgPrice,
    quantity: quantity,
    stop_loss_price: stopLoss,
    target_price: target
  };
  
  try {
    const response = await fetch('/save_update', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(updateData)
    });
    
    const result = await response.json();
    
    if (result.success) {
      updatePositionUI(result.trade);
      clearUnsavedChanges();
      showToast('Position updated successfully!', 'success');
    } else {
      showToast('Error: ' + result.error, 'error');
    }
  } catch (error) {
    showToast('Network error: ' + error.message, 'error');
  }
}

async function closePosition() {
  try {
    const response = await fetch('/close_position', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ trade_id: tradeData.id })
    });
    
    const result = await response.json();
    
    if (result.success) {
      // Show position closed flash message
      showToast('POSITION CLOSED', 'success');
      
      // Update UI to show closed status
      const header = document.querySelector('header');
      if (header) {
        const closedBadge = document.createElement('div');
        closedBadge.style.cssText = `
          position: absolute;
          top: 10px;
          right: 10px;
          background: rgba(255, 59, 48, 0.9);
          color: white;
          padding: 8px 16px;
          border-radius: 20px;
          font-weight: bold;
          font-size: 14px;
          z-index: 1000;
        `;
        closedBadge.textContent = 'POSITION CLOSED';
        header.style.position = 'relative';
        header.appendChild(closedBadge);
      }
      
      // Disable all input fields and buttons except close button
      const inputs = document.querySelectorAll('input, button, select');
      inputs.forEach(input => {
        if (input.id !== 'backToManual' && input.id !== 'closeBtn') {
          input.disabled = true;
          input.style.opacity = '0.5';
        }
      });
      
      // Update trade status
      tradeData.status = 'closed';
      
      // Update close button
      const closeBtn = document.getElementById('closeBtn');
      closeBtn.textContent = 'Reopen Position';
      closeBtn.className = 'btn-ai';
      
      updateParentTableStatus('closed');
      
    } else {
      showToast('Error: ' + result.error, 'error');
    }
  } catch (error) {
    showToast('Network error: ' + error.message, 'error');
  }
}

async function reopenPosition() {
  try {
    const response = await fetch('/reopen_position', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ trade_id: tradeData.id })
    });
    
    const result = await response.json();
    
    if (result.success) {
      showToast('Position reopened successfully!', 'success');
      
      // Remove closed badge
      const closedBadge = document.querySelector('header div[style*="POSITION CLOSED"]');
      if (closedBadge) closedBadge.remove();
      
      // Enable all inputs
      const inputs = document.querySelectorAll('input, button, select');
      inputs.forEach(input => {
        input.disabled = false;
        input.style.opacity = '1';
      });
      
      // Update trade status
      tradeData.status = 'open';
      
      // Update close button text
      const closeBtn = document.getElementById('closeBtn');
      closeBtn.textContent = 'Close Position';
      closeBtn.className = 'btn-sell';
      
      updateParentTableStatus('open');
    } else {
      showToast('Error: ' + result.error, 'error');
    }
  } catch (error) {
    showToast('Network error: ' + error.message, 'error');
  }
}

function updateParentTableStatus(status) {
  const parentWindow = window.opener || window.parent;
  if (parentWindow && parentWindow !== window) {
    try {
      const row = parentWindow.document.querySelector(`tr[data-trade-id="${tradeData.id}"]`);
      if (row) {
        const statusCell = row.querySelector('td:first-child');
        if (statusCell) {
          if (status === 'closed') {
            statusCell.innerHTML += ' <span style="background:#ff3b30;color:white;padding:2px 6px;border-radius:10px;font-size:10px;margin-left:5px;">CLOSED</span>';
            row.style.opacity = '0.7';
          } else if (status === 'open') {
            // Remove closed badge
            const badge = statusCell.querySelector('span[style*="CLOSED"]');
            if (badge) badge.remove();
            row.style.opacity = '1';
          }
        }
      }
    } catch (e) {
      console.log('Could not update parent table:', e);
    }
  }
}

async function saveFromAI() {
  const avgPrice = tradeData.avgPrice;
  const quantity = tradeData.quantity;
  const stopLoss = tradeData.stopLoss;
  const target = tradeData.target;
  
  if (currentSplitMode === 'custom') {
    const customSplit = document.getElementById('customSplit').value;
    if (!customSplit.trim()) {
      alert('Please enter custom split values');
      return;
    }
    
    try {
      const parts = customSplit.split(',').map(p => parseInt(p.trim())).filter(p => p > 0);
      const total = parts.reduce((sum, p) => sum + p, 0);
      if (total !== quantity) {
        alert(`Split sum (${total}) must equal quantity (${quantity})`);
        return;
      }
    } catch (e) {
      alert('Invalid custom split format');
      return;
    }
  }
  
  document.getElementById('confirmModal').style.display = 'flex';
}

function updatePositionUI(trade) {
  // Update summary tiles
  document.getElementById('ts-capital').textContent = `₹${trade.capital_used.toLocaleString()}`;
  document.getElementById('ts-rr').textContent = `1:${trade.rr_ratio}`;
  document.getElementById('ts-profit').textContent = `${trade.expected_return}%`;
  document.getElementById('ts-risk').textContent = `${trade.risk_percent}%`;
  
  // Update input fields
  document.getElementById('inpAvgPrice').value = trade.avg_price;
  document.getElementById('inpQty').value = trade.quantity;
  document.getElementById('inpSL').value = trade.stop_loss_price;
  document.getElementById('inpTarget').value = trade.target_price;
  
  // Update trade data object
  Object.assign(tradeData, trade);
  
  // Update risk calculator if visible
  if (typeof updateRiskCalculations === 'function') {
    updateRiskCalculations();
  }
  
  // Update saved trades table if parent window exists
  updateSavedTradesTable(trade);
}

function updateSavedTradesTable(trade) {
  // Try to update the saved trades table in parent window or opener
  const parentWindow = window.opener || window.parent;
  if (parentWindow && parentWindow !== window) {
    try {
      const row = parentWindow.document.querySelector(`tr[data-trade-id="${trade.id}"]`);
      if (row) {
        const cells = row.querySelectorAll('td');
        if (cells.length >= 12) {
          cells[2].textContent = trade.avg_price.toFixed(2); // Avg Price
          cells[3].textContent = trade.quantity; // Qty
          cells[4].textContent = trade.expected_return.toFixed(2); // Return %
          cells[5].textContent = trade.risk_percent.toFixed(2); // Risk %
          cells[6].textContent = trade.capital_used.toFixed(2); // Capital
          cells[7].textContent = trade.target_price.toFixed(2); // Target
          cells[8].textContent = trade.stop_loss_price.toFixed(2); // Stop-Loss
          cells[9].textContent = trade.total_reward.toFixed(2); // Profit
          cells[10].textContent = trade.total_risk.toFixed(2); // Risk
          cells[11].textContent = trade.rr_ratio.toFixed(2); // RR Ratio
        }
      }
    } catch (e) {
      console.log('Could not update parent table:', e);
    }
  }
}

/* ================== AI EXIT PLANNER ENGINE ================== */
const $ = (id)=>document.getElementById(id);
const log = (msg)=>{ const t = new Date().toLocaleTimeString(); $('ailog').insertAdjacentHTML('beforeend', `<div><span style="color:#6ea9ff">[${t}]</span> ${msg}</div>`); $('ailog').scrollTop = $('ailog').scrollHeight; }
const format = (n, d=2)=> Number(n).toFixed(d);

// --- leverage helpers for AI plan ---
function leveragedMove(entry, pct){ return (entry/5) * (pct/100); }
function priceFromPct(entry, pct, side){
  // side: 'buy' => profit up, 'sell' => profit down
  return side === 'buy' ? entry + leveragedMove(entry, pct)
                        : entry - leveragedMove(entry, pct);
}

function getRuleSet(qty) {
  if (qty <= 3) {
    return {
      name: 'Small',
      slPercent: 2.0,
      exits: [{ percent: 5.0, allocation: 100 }]
    };
  } else if (qty <= 10) {
    return {
      name: 'Medium',
      slPercent: 2.0,
      exits: [{ percent: 3.0, allocation: 30 }, { percent: 6.0, allocation: 70 }]
    };
  } else {
    return {
      name: 'Large',
      slPercent: 1.5,
      exits: [{ percent: 2.5, allocation: 20 }, { percent: 5.0, allocation: 40 }, { percent: 7.0, allocation: 40 }]
    };
  }
}

function getEntryAndQty(){
  // Auto-fetch from page inputs
  const e = parseFloat(document.getElementById('inpAvgPrice').value);
  const q = parseInt(document.getElementById('inpQty').value,10);
  return {entry:e, qty:q};
}

async function makePlan(){
  const {entry, qty} = getEntryAndQty();
  
  if(!(entry>0 && qty>0)){
    alert('Please enter a valid Average Price and Quantity in the Position Management section.');
    return;
  }

  // Show AI thinking animation
  $('ailog').innerHTML = '';
  $('plan').innerHTML = '<div style="text-align:center;padding:20px;color:#8f94fb;"><i class="fas fa-brain" style="animation:brain-pulse 1.5s infinite;"></i><br>AI is analyzing your entry, quantity, and volatility bands...</div>';
  
  log('AI is analyzing your entry, quantity, and volatility bands...');
  await new Promise(resolve => setTimeout(resolve, 1200));
  
  $('plan').innerHTML = '<div style="text-align:center;padding:20px;color:#8f94fb;"><i class="fas fa-brain" style="animation:brain-pulse 1.5s infinite;"></i><br>AI is preparing your personalized exit strategy...</div>';
  log('AI is preparing your personalized exit strategy...');
  await new Promise(resolve => setTimeout(resolve, 1300));
  
  log('Parsing inputs…');
  setTimeout(()=>log(`Entry ₹${format(entry)} | Quantity ${qty}`), 200);
  
  // Determine rule set based on quantity
  const ruleSet = getRuleSet(qty);
  setTimeout(()=>log(`Applied ${ruleSet.name} rule set`), 400);

  // --- NEW: sign helpers and side ---
  const side = (tradeData.tradeType==='buy') ? 'buy' : 'sell';
  const trigSign = side==='buy' ? '+' : '-';
  const slSign   = side==='buy' ? '-' : '+';
  
  // Calculate SL price (leveraged adverse move)
  const slPrice = side==='buy'
    ? entry - leveragedMove(entry, ruleSet.slPercent)
    : entry + leveragedMove(entry, ruleSet.slPercent);
  
  // Calculate exit quantities and prices using leveraged PROFIT move
  let remainingQty = qty;
  const exits = [];
  
  for (let i = 0; i < ruleSet.exits.length; i++) {
    const exit = ruleSet.exits[i];
    const exitQty = Math.floor(qty * (exit.allocation / 100));
    const exitPrice = priceFromPct(entry, exit.percent, side);
    
    exits.push({
      index: i+1,
      percent: exit.percent,
      qty: exitQty,
      price: exitPrice,
      allocation: exit.allocation
    });
    
    remainingQty -= exitQty;
  }
  
  // Handle any remaining quantity from rounding
  if (remainingQty > 0 && exits.length > 0) {
    exits[exits.length-1].qty += remainingQty;
  }
  
  aiPlanData = {ruleSet, entry, qty, slPrice, slPercent: ruleSet.slPercent, exits, side, trigSign, slSign};

  // Generate plan HTML (with correct signs)
  let planHTML = `
    <table aria-label="Exit Plan">
      <thead>
        <tr>
          <th>Leg</th>
          <th>Trigger</th>
          <th>Qty</th>
          <th>Exit Price</th>
          <th>Value</th>
          <th>Intent</th>
        </tr>
      </thead>
      <tbody>
  `;
  
  exits.forEach((exit, index) => {
    planHTML += `
        <tr>
          <td>Exit-${exit.index}</td>
          <td>${trigSign}${format(exit.percent,1)}%</td>
          <td>${exit.qty} (${exit.allocation}%)</td>
          <td>₹${format(exit.price)}</td>
          <td>₹${format(exit.price * exit.qty)}</td>
          <td><span class="pill ${index === 0 ? 'warn' : 'good'}">${index === 0 ? 'Recover Cost' : 'Lock Profit'}</span></td>
        </tr>
    `;
  });
  
  planHTML += `
        <tr>
          <td>Stop Loss</td>
          <td>${slSign}${format(ruleSet.slPercent,1)}%</td>
          <td>${qty}</td>
          <td>₹${format(slPrice)}</td>
          <td>₹${format(slPrice * qty)}</td>
          <td><span class="pill" style="background:rgba(255,59,48,.2);color:#ff3b30;border:1px solid rgba(255,59,48,.3)">Risk Management</span></td>
        </tr>
      </tbody>
    </table>
    <div class="actions" style="margin-top:8px;gap:8px;justify-content:flex-start">
      <button class="tiny-link" id="copyPlan">Copy Plan</button>
      <button class="tiny-link" id="copyLevels">Copy Levels Only</button>
    </div>
  `;

  // Show plan after delay
  setTimeout(() => {
    $('plan').innerHTML = planHTML;
    attachCopyHandlers(aiPlanData);
    log('AI exit strategy generated successfully!');
  }, 300);

  // Log details
  setTimeout(()=>log(`Stop Loss set @ ₹${format(slPrice)} (${slSign}${ruleSet.slPercent}%)`), 600);
  
  exits.forEach((exit, index) => {
    setTimeout(()=>log(`Exit-${exit.index} set @ ₹${format(exit.price)} (${trigSign}${exit.percent}%) for ${exit.qty} qty (${exit.allocation}%)`), 800 + index * 200);
  });
}

function attachCopyHandlers(planData){
  const { trigSign, slSign } = planData;

  let planStr = `AI Exit Plan (${planData.ruleSet.name} Rule Set)\n` +
                `Entry: ₹${format(planData.entry)}\n` +
                `Stop Loss: ${slSign}${planData.slPercent}% → ₹${format(planData.slPrice)}\n\n`;
  
  planData.exits.forEach(exit => {
    planStr += `Exit-${exit.index}: ${trigSign}${exit.percent}% → ₹${format(exit.price)} (Qty ${exit.qty}, ${exit.allocation}%)\n`;
  });
  
  let levelsStr = `SL: ₹${format(planData.slPrice)} | `;
  planData.exits.forEach(exit => {
    levelsStr += `Exit-${exit.index}: ₹${format(exit.price)} | `;
  });
  levelsStr = levelsStr.slice(0, -3); // Remove last " | "
  
  const cp = (txt)=>navigator.clipboard?.writeText(txt);
  const btn1 = document.getElementById('copyPlan');
  const btn2 = document.getElementById('copyLevels');
  btn1?.addEventListener('click', ()=>{cp(planStr);log('Plan copied to clipboard.');});
  btn2?.addEventListener('click', ()=>{cp(levelsStr);log('Levels copied to clipboard.');});
}

// Save AI plan as template
$('btnSavePlan').addEventListener('click', async function() {
  if (!aiPlanData) {
    alert('Please generate an AI plan first.');
    return;
  }
  
  const instrument = tradeData.commentSymbol || tradeData.symbol || 'UNKNOWN';
  const strike = null;
  
  const planPayload = {
    ruleSet: aiPlanData.ruleSet,
    entry: aiPlanData.entry,
    qty: aiPlanData.qty,
    slPrice: aiPlanData.slPrice,
    slPercent: aiPlanData.slPercent,
    exits: aiPlanData.exits,
    side: aiPlanData.side,
    trigSign: aiPlanData.trigSign,
    slSign: aiPlanData.slSign,
    timestamp: new Date().toISOString()
  };
  
  try {
    const response = await fetch('/api/ai_plans', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ instrument, strike, payload: planPayload })
    });
    
    const result = await response.json();
    if (response.ok && result.template_id) {
      window.currentAIPlanId = result.template_id;
      showToast('AI Plan saved as template!', 'success');
      log('AI plan saved as template.');
    } else {
      showToast('Failed to save AI plan: ' + (result.error || 'Unknown error'), 'error');
    }
  } catch (error) {
    showToast('Network error: ' + error.message, 'error');
  }
});

$('btnPlan')?.addEventListener('click', makePlan);

// View saved plans
$('btnViewPlans')?.addEventListener('click', async function() {
  const instrument = tradeData.commentSymbol || tradeData.symbol || 'UNKNOWN';
  const strike = null;
  
  try {
    const response = await fetch(`/api/ai_plans?instrument=${encodeURIComponent(instrument)}&t=${Date.now()}`);
    if (!response.ok) {
      showToast('Failed to load saved plans', 'error');
      return;
    }
    
    const plans = await response.json();
    if (plans.length === 0) {
      showToast('No saved plans found for this instrument', 'info');
      return;
    }
    
    // Show the latest saved plan
    const latestPlan = plans[0];
    aiPlanData = latestPlan.payload;
    
    // Recreate the plan HTML
    let planHTML = `
      <div style="margin-bottom:10px;color:#8f94fb;font-size:12px;">Loaded saved plan from ${new Date(latestPlan.created_at).toLocaleString()}</div>
      <table aria-label="Exit Plan">
        <thead>
          <tr>
            <th>Leg</th>
            <th>Trigger</th>
            <th>Qty</th>
            <th>Exit Price</th>
            <th>Value</th>
            <th>Intent</th>
          </tr>
        </thead>
        <tbody>
    `;
    
    aiPlanData.exits.forEach((exit, index) => {
      planHTML += `
          <tr>
            <td>Exit-${exit.index}</td>
            <td>${aiPlanData.trigSign}${format(exit.percent,1)}%</td>
            <td>${exit.qty} (${exit.allocation}%)</td>
            <td>₹${format(exit.price)}</td>
            <td>₹${format(exit.price * exit.qty)}</td>
            <td><span class="pill ${index === 0 ? 'warn' : 'good'}">${index === 0 ? 'Recover Cost' : 'Lock Profit'}</span></td>
          </tr>
      `;
    });
    
    planHTML += `
          <tr>
            <td>Stop Loss</td>
            <td>${aiPlanData.slSign}${format(aiPlanData.slPercent,1)}%</td>
            <td>${aiPlanData.qty}</td>
            <td>₹${format(aiPlanData.slPrice)}</td>
            <td>₹${format(aiPlanData.slPrice * aiPlanData.qty)}</td>
            <td><span class="pill" style="background:rgba(255,59,48,.2);color:#ff3b30;border:1px solid rgba(255,59,48,.3)">Risk Management</span></td>
          </tr>
        </tbody>
      </table>
      <div class="actions" style="margin-top:8px;gap:8px;justify-content:flex-start">
        <button class="tiny-link" id="copyPlan">Copy Plan</button>
        <button class="tiny-link" id="copyLevels">Copy Levels Only</button>
      </div>
    `;
    
    $('plan').innerHTML = planHTML;
    attachCopyHandlers(aiPlanData);
    
    showToast('Saved plan loaded successfully!', 'success');
    log('Loaded saved AI plan from ' + new Date(latestPlan.created_at).toLocaleString());
    
  } catch (error) {
    showToast('Error loading saved plans: ' + error.message, 'error');
  }
});

$('btnReset')?.addEventListener('click', ()=>{
  $('ailog').innerHTML='';
  $('plan').innerHTML = '<p style="color:#aaa">Click <b>Generate AI Plan</b>. The exits will appear here based on quantity.</p>';
  aiPlanData = null;
});

/* ================== ADVANCED RISK CALCULATOR ================== */
// Risk calculator state
let riskCalcState = {
  capital: parseFloat("{{ trade.capital_used or 100000 }}"),
  riskPercent: 2,
  expectedReturn: 5,
  quantity: parseInt("{{ trade.quantity }}"),
  entryPrice: parseFloat("{{ '%.2f'|format(trade.avg_price) }}")
};

// Sync slider and input pairs
function syncSliderInput(sliderId, inputId) {
  const slider = document.getElementById(sliderId);
  const input = document.getElementById(inputId);
  
  slider.addEventListener('input', () => {
    input.value = slider.value;
    updateRiskCalculations();
  });
  
  input.addEventListener('input', () => {
    slider.value = input.value;
    updateRiskCalculations();
  });
}

// Update risk badge and heat meter
function updateRiskBadge(riskPercent) {
  const badge = document.getElementById('risk-badge');
  const heatBar = document.getElementById('heat-bar');
  
  let category, position;
  if (riskPercent <= 2) {
    category = 'conservative';
    badge.textContent = 'Conservative';
    position = (riskPercent / 2) * 33; // 0-33%
  } else if (riskPercent <= 5) {
    category = 'balanced';
    badge.textContent = 'Balanced';
    position = 33 + ((riskPercent - 2) / 3) * 34; // 33-67%
  } else {
    category = 'aggressive';
    badge.textContent = 'Aggressive';
    position = 67 + Math.min(((riskPercent - 5) / 5) * 33, 33); // 67-100%
  }
  
  badge.className = `risk-badge ${category}`;
  heatBar.style.setProperty('--heat-position', `${position}%`);
  
  // Update heat bar indicator
  const afterElement = heatBar.querySelector('::after') || heatBar;
  afterElement.style.left = `calc(${position}% - 2px)`;
}

// Live calculation updates
function updateRiskCalculations() {
  // Get current values
  const capital = parseFloat(document.getElementById('capital-input').value) || 0;
  const riskPercent = parseFloat(document.getElementById('risk-input').value) || 0;
  const expectedReturn = parseFloat(document.getElementById('return-input').value) || 0;
  const quantity = parseInt(document.getElementById('qty-input').value) || 0;
  const entryPrice = riskCalcState.entryPrice;
  
  // Update state
  riskCalcState = { capital, riskPercent, expectedReturn, quantity, entryPrice };
  
  // Update risk badge and heat meter
  updateRiskBadge(riskPercent);
  
  // Calculate position metrics with 5x leverage
  const leverageMultiplier = 5;
  const positionValue = entryPrice * quantity;
  const capitalUsed = positionValue / leverageMultiplier;
  const riskAmount = capital * (riskPercent / 100);
  const riskPerShare = riskAmount / quantity;
  
  // Calculate prices based on leveraged moves
  const leveragedRiskMove = (entryPrice / leverageMultiplier) * (riskPercent / 100);
  const leveragedReturnMove = (entryPrice / leverageMultiplier) * (expectedReturn / 100);
  
  const stopLossPrice = tradeData.tradeType === 'buy' 
    ? entryPrice - leveragedRiskMove 
    : entryPrice + leveragedRiskMove;
    
  const targetPrice = tradeData.tradeType === 'buy'
    ? entryPrice + leveragedReturnMove
    : entryPrice - leveragedReturnMove;
  
  const expectedProfit = capitalUsed * (expectedReturn / 100);
  const rrRatio = expectedReturn / riskPercent;
  
  // Update summary dashboard
  document.getElementById('position-value').textContent = `₹${positionValue.toLocaleString()}`;
  document.getElementById('capital-used').textContent = `₹${capitalUsed.toLocaleString()}`;
  document.getElementById('risk-amount').textContent = `₹${riskAmount.toLocaleString()}`;
  document.getElementById('expected-profit').textContent = `₹${expectedProfit.toLocaleString()}`;
  document.getElementById('rr-ratio').textContent = `1:${rrRatio.toFixed(2)}`;
  document.getElementById('target-price').textContent = `₹${targetPrice.toFixed(2)}`;
  document.getElementById('stop-loss-price').textContent = `₹${stopLossPrice.toFixed(2)}`;
  
  // Update color coding based on risk level
  const rrElement = document.getElementById('rr-ratio');
  if (rrRatio >= 3) {
    rrElement.style.color = '#4cd964';
  } else if (rrRatio >= 2) {
    rrElement.style.color = '#ffcc00';
  } else {
    rrElement.style.color = '#ff3b30';
  }
}

// Preset risk buttons
function setupPresetButtons() {
  document.querySelectorAll('.preset-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const riskValue = parseFloat(btn.dataset.risk);
      
      // Update sliders and inputs
      document.getElementById('risk-slider').value = riskValue;
      document.getElementById('risk-input').value = riskValue;
      
      // Set corresponding expected return
      const returnValue = riskValue * 2.5; // 2.5x risk as return
      document.getElementById('return-slider').value = returnValue;
      document.getElementById('return-input').value = returnValue;
      
      // Update active state
      document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      
      updateRiskCalculations();
    });
  });
}

// Initialize risk calculator
function initRiskCalculator() {
  // Setup slider-input synchronization
  syncSliderInput('capital-slider', 'capital-input');
  syncSliderInput('risk-slider', 'risk-input');
  syncSliderInput('return-slider', 'return-input');
  syncSliderInput('qty-slider', 'qty-input');
  
  // Setup preset buttons
  setupPresetButtons();
  
  // Add CSS for heat bar animation
  const style = document.createElement('style');
  style.textContent = `
    .heat-bar::after {
      content: '';
      position: absolute;
      top: -2px;
      bottom: -2px;
      width: 4px;
      background: #fff;
      border-radius: 2px;
      box-shadow: 0 0 8px rgba(255,255,255,0.8);
      transition: left 0.3s ease;
      left: calc(var(--heat-position, 20%) - 2px);
    }
  `;
  document.head.appendChild(style);
  
  // Initial calculation
  updateRiskCalculations();
  
  // Set default preset as active
  document.querySelector('[data-risk="2"]').classList.add('active');
}

// Tooltip functionality
function initTooltips() {
  document.querySelectorAll('.tooltip').forEach(tooltip => {
    tooltip.addEventListener('mouseenter', (e) => {
      const title = e.target.getAttribute('title');
      if (title) {
        const tooltipDiv = document.createElement('div');
        tooltipDiv.className = 'tooltip-popup';
        tooltipDiv.textContent = title;
        tooltipDiv.style.cssText = `
          position: absolute;
          background: rgba(0,0,0,0.9);
          color: white;
          padding: 8px 12px;
          border-radius: 6px;
          font-size: 12px;
          z-index: 1000;
          pointer-events: none;
          white-space: nowrap;
          box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        `;
        
        document.body.appendChild(tooltipDiv);
        
        const rect = e.target.getBoundingClientRect();
        tooltipDiv.style.left = `${rect.left + rect.width / 2 - tooltipDiv.offsetWidth / 2}px`;
        tooltipDiv.style.top = `${rect.top - tooltipDiv.offsetHeight - 8}px`;
        
        e.target._tooltip = tooltipDiv;
      }
    });
    
    tooltip.addEventListener('mouseleave', (e) => {
      if (e.target._tooltip) {
        document.body.removeChild(e.target._tooltip);
        delete e.target._tooltip;
      }
    });
  });
}

/* ================== PREDEFINED RISK MANAGEMENT TOOLS ================== */


function applyRiskTool(toolType) {
  const entryPrice = parseFloat(document.getElementById('inpAvgPrice').value) || tradeData.avgPrice;
  const quantity = parseInt(document.getElementById('inpQty').value) || tradeData.quantity;
  
  if (!entryPrice || !quantity) {
    alert('Please ensure Average Price and Quantity are set in Position Management.');
    return;
  }
  
  let toolConfig;
  switch(toolType) {
    case 'conservative':
      toolConfig = {
        name: 'Conservative (1% Risk)',
        riskPercent: 1.0,
        targetPercent: 2.5,
        color: '#4cd964'
      };
      break;
    case 'balanced':
      toolConfig = {
        name: 'Balanced (2% Risk)',
        riskPercent: 2.0,
        targetPercent: 5.0,
        color: '#ffcc00'
      };
      break;
    case 'aggressive':
      toolConfig = {
        name: 'Aggressive (5% Risk)',
        riskPercent: 5.0,
        targetPercent: 12.5,
        color: '#ff3b30'
      };
      break;
    default:
      return;
  }
  
  // Calculate prices with 5x leverage
  const leverageMultiplier = 5;
  const capitalPerShare = entryPrice / leverageMultiplier;
  
  const riskMove = capitalPerShare * (toolConfig.riskPercent / 100);
  const targetMove = capitalPerShare * (toolConfig.targetPercent / 100);
  
  const stopLossPrice = tradeData.tradeType === 'buy' 
    ? entryPrice - riskMove 
    : entryPrice + riskMove;
    
  const targetPrice = tradeData.tradeType === 'buy'
    ? entryPrice + targetMove
    : entryPrice - targetMove;
  
  currentTool = {
    ...toolConfig,
    entryPrice,
    stopLossPrice,
    targetPrice,
    quantity
  };
  
  // Add visual feedback
  document.querySelectorAll('.split-option').forEach(opt => opt.style.transform = 'scale(1)');
  event.target.closest('.split-option').style.transform = 'scale(1.02)';
  
  setTimeout(() => {
    event.target.closest('.split-option').style.transform = 'scale(1)';
  }, 200);
  
  // Apply directly to position
  document.getElementById('inpSL').value = stopLossPrice.toFixed(2);
  document.getElementById('inpTarget').value = targetPrice.toFixed(2);
  
  showToast(`${toolConfig.name} applied to position!`, 'success');
}



/* ================== SPLIT EDITOR ================== */
let splitCurrentEdit = null;
let splitStopMode = 'pct';
let splitTargetMode = 'pct';

// Toast notification function
function showToast(message, type = 'info') {
  const toast = document.createElement('div');
  toast.className = `toast toast-${type}`;
  toast.textContent = message;
  document.body.appendChild(toast);
  
  setTimeout(() => {
    if (toast.parentNode) {
      toast.parentNode.removeChild(toast);
    }
  }, 3000);
}

// Initialize split preview table
function initSplitPreview() {
  const appliedSplitTable = document.getElementById('appliedSplitTable');
  const splitTableBody = document.getElementById('splitTableBody');
  
  if (!appliedSplitTable || !splitTableBody) return;
  
  // Show the table when split preview is active
  if (splitParts && splitParts.length > 0) {
    appliedSplitTable.classList.remove('hidden');
    
    // Populate table with split parts
    splitTableBody.innerHTML = splitParts.map((part, index) => `
      <tr>
        <td>Part ${index + 1} (${part.qty} shares)</td>
        <td>₹761.05</td>
        <td>₹1635.70</td>
        <td>${part.qty}</td>
        <td><button class="split-action-btn" onclick="editSplitPart(${index + 1}, ${part.qty})">Edit</button></td>
      </tr>
    `).join('');
  }
}

// Edit split part function - make it global
window.editSplitPart = function(partNumber, qty) {
  const overlay = document.getElementById('splitEditorOverlay');
  splitCurrentEdit = { part: partNumber, qty: qty };
  
  document.getElementById('editPart').textContent = partNumber;
  document.getElementById('editQty').textContent = qty;
  document.getElementById('editAvgPrice').value = document.getElementById('inpAvgPrice').value;
  document.getElementById('editQuantity').value = qty;
  
  document.getElementById('stopInput').value = '';
  document.getElementById('targetInput').value = '';
  setSplitToggleMode('stop', 'pct');
  setSplitToggleMode('target', 'pct');
  
  overlay.style.display = 'block';
  updateSplitCalculations();
};

// Save preview template function - make it global
window.savePreviewTemplate = async function() {
  const splitTableBody = document.getElementById('splitTableBody');
  if (!splitTableBody || splitTableBody.children.length === 0) {
    showToast('No split preview data to save', 'error');
    return;
  }
  
  const instrument = tradeData.commentSymbol || tradeData.symbol || 'UNKNOWN';
  const strike = null; // For equity trades, no strike needed
  
  console.log('Saving template for instrument:', instrument, 'strike:', strike);
  
  const payload = {
    split_mode: currentSplitMode,
    split_parts: splitParts,
    table_data: Array.from(splitTableBody.children).map(row => {
      const cells = row.querySelectorAll('td');
      return {
        preview: cells[0]?.textContent || '',
        sl: cells[1]?.textContent || '',
        target: cells[2]?.textContent || '',
        qty: cells[3]?.textContent || ''
      };
    })
  };
  
  try {
    const requestData = { instrument, strike, payload };
    console.log('Sending save request:', requestData);
    
    const response = await fetch('/api/templates', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(requestData)
    });
    
    const result = await response.json();
    console.log('Save response:', response.status, result);
    
    if (response.ok && result.template_id) {
      window.currentTemplateId = result.template_id;
      showToast('Preview template saved successfully!', 'success');
      toggleButtons(true);
    } else {
      console.error('Save failed', response.status, result);
      showToast('Failed to save template: ' + (result.error || 'Unknown error'), 'error');
    }
  } catch (error) {
    console.error('Network error:', error);
    showToast('Network error: ' + error.message, 'error');
  }
};

// Delete preview template function - make it global
window.deletePreviewTemplate = async function() {
  const templateId = window.currentTemplateId;
  if (!templateId) {
    showToast('No template to delete', 'error');
    return;
  }
  
  try {
    const response = await fetch(`/api/templates/${templateId}`, {
      method: 'DELETE'
    });
    
    const result = await response.json();
    if (response.ok) {
      window.currentTemplateId = null;
      showToast('Template deleted successfully!', 'success');
      toggleButtons(false);
    } else {
      console.error('Delete failed', result);
      showToast('Failed to delete template: ' + (result.error || 'Unknown error'), 'error');
    }
  } catch (error) {
    console.error('Network error:', error);
    showToast('Network error: ' + error.message, 'error');
  }
};

// Reset split table function - make it global
window.resetSplitTable = function() {
  const splitTableBody = document.getElementById('splitTableBody');
  const appliedSplitTable = document.getElementById('appliedSplitTable');
  
  if (splitTableBody) {
    splitTableBody.innerHTML = '';
  }
  if (appliedSplitTable) {
    appliedSplitTable.classList.add('hidden');
  }
  
  // Reset split parts
  splitParts = [];
  currentSplitMode = 'full';
  document.getElementById('splitMode').value = 'full';
  
  showToast('Split table reset successfully!', 'info');
};

function calcStopPrice(avg, pct) { return avg * (1 - pct / 100); }
function calcTargetPrice(avg, pct) { return avg * (1 + pct / 100); }
function calcStopPct(avg, price) { return (1 - price / avg) * 100; }
function calcTargetPct(avg, price) { return (price / avg - 1) * 100; }
function isValidNumber(val) { return !isNaN(val) && isFinite(val) && val > 0; }

function updateSplitCalculations() {
  const avg = parseFloat(document.getElementById('inpAvgPrice').value);
  const applyBtn = document.getElementById('splitApplyBtn');
  const stopCalc = document.getElementById('stopCalc');
  const targetCalc = document.getElementById('targetCalc');
  const stopError = document.getElementById('stopError');
  const targetError = document.getElementById('targetError');
  const stopInput = document.getElementById('stopInput');
  const targetInput = document.getElementById('targetInput');
  
  if (!isValidNumber(avg)) {
    applyBtn.disabled = true;
    stopCalc.textContent = 'Average Price unavailable';
    targetCalc.textContent = 'Average Price unavailable';
    return;
  }
  applyBtn.disabled = false;
  
  const stopVal = parseFloat(stopInput.value);
  if (isValidNumber(stopVal)) {
    stopError.textContent = '';
    if (splitStopMode === 'pct') {
      const price = calcStopPrice(avg, stopVal);
      stopCalc.textContent = `Stop Price: ₹${price.toFixed(2)}`;
    } else {
      const pct = calcStopPct(avg, stopVal);
      stopCalc.textContent = `Stop %: ${pct.toFixed(2)}%`;
    }
  } else {
    stopCalc.textContent = '';
    if (stopInput.value) stopError.textContent = 'Invalid stop loss value';
  }
  
  const targetVal = parseFloat(targetInput.value);
  if (isValidNumber(targetVal)) {
    targetError.textContent = '';
    if (splitTargetMode === 'pct') {
      const price = calcTargetPrice(avg, targetVal);
      targetCalc.textContent = `Target Price: ₹${price.toFixed(2)}`;
    } else {
      const pct = calcTargetPct(avg, targetVal);
      targetCalc.textContent = `Target %: ${pct.toFixed(2)}%`;
    }
  } else {
    targetCalc.textContent = '';
    if (targetInput.value) targetError.textContent = 'Invalid target value';
  }
}

function setSplitToggleMode(type, mode) {
  const input = document.getElementById(type === 'stop' ? 'stopInput' : 'targetInput');
  if (type === 'stop') {
    splitStopMode = mode;
    document.getElementById('stopPctBtn').classList.toggle('active', mode === 'pct');
    document.getElementById('stopPriceBtn').classList.toggle('active', mode === 'price');
    input.placeholder = mode === 'pct' ? 'Enter stop loss %' : 'Enter stop loss price';
  } else {
    splitTargetMode = mode;
    document.getElementById('targetPctBtn').classList.toggle('active', mode === 'pct');
    document.getElementById('targetPriceBtn').classList.toggle('active', mode === 'price');
    input.placeholder = mode === 'pct' ? 'Enter target %' : 'Enter target price';
  }
  input.value = '';
  updateSplitCalculations();
}

function initSplitEditor() {
  const overlay = document.getElementById('splitEditorOverlay');
  const editAvgPrice = document.getElementById('editAvgPrice');
  
  document.getElementById('inpAvgPrice').addEventListener('input', () => {
    editAvgPrice.value = document.getElementById('inpAvgPrice').value;
    updateSplitCalculations();
  });
  
  document.getElementById('stopInput').addEventListener('input', updateSplitCalculations);
  document.getElementById('targetInput').addEventListener('input', updateSplitCalculations);
  
  document.getElementById('stopPctBtn').addEventListener('click', () => setSplitToggleMode('stop', 'pct'));
  document.getElementById('stopPriceBtn').addEventListener('click', () => setSplitToggleMode('stop', 'price'));
  document.getElementById('targetPctBtn').addEventListener('click', () => setSplitToggleMode('target', 'pct'));
  document.getElementById('targetPriceBtn').addEventListener('click', () => setSplitToggleMode('target', 'price'));
  
  document.getElementById('splitApplyBtn').addEventListener('click', () => {
    if (!splitCurrentEdit) return;
    const avg = parseFloat(document.getElementById('inpAvgPrice').value);
    const stopVal = parseFloat(document.getElementById('stopInput').value);
    const targetVal = parseFloat(document.getElementById('targetInput').value);
    
    let stopPrice = null, stopPct = null, targetPrice = null, targetPct = null;
    if (isValidNumber(stopVal)) {
      if (splitStopMode === 'pct') {
        stopPct = stopVal;
        stopPrice = calcStopPrice(avg, stopVal);
      } else {
        stopPrice = stopVal;
        stopPct = calcStopPct(avg, stopVal);
      }
    }
    if (isValidNumber(targetVal)) {
      if (splitTargetMode === 'pct') {
        targetPct = targetVal;
        targetPrice = calcTargetPrice(avg, targetVal);
      } else {
        targetPrice = targetVal;
        targetPct = calcTargetPct(avg, targetVal);
      }
    }
    
    // Update the table row with calculated values
    const tableBody = document.getElementById('splitTableBody');
    const rows = tableBody.querySelectorAll('tr');
    const rowIndex = splitCurrentEdit.part - 1;
    
    if (rows[rowIndex]) {
      const cells = rows[rowIndex].querySelectorAll('td');
      if (cells.length >= 4) {
        // Update SL column with calculated price
        cells[1].textContent = stopPrice ? `₹${stopPrice.toFixed(2)}` : '₹0.00';
        // Update TARGET column with calculated price  
        cells[2].textContent = targetPrice ? `₹${targetPrice.toFixed(2)}` : '₹0.00';
      }
    }
    
    // Also update the split preview items if they exist
    const previewItems = document.querySelectorAll('.split-preview-item');
    previewItems.forEach((item, index) => {
      if (parseInt(item.dataset.part) === splitCurrentEdit.part) {
        // Add calculated values to the preview item display
        const existingText = item.innerHTML;
        if (!existingText.includes('SL:')) {
          const slText = stopPrice ? ` | SL: ₹${stopPrice.toFixed(2)}` : '';
          const targetText = targetPrice ? ` | Target: ₹${targetPrice.toFixed(2)}` : '';
          item.innerHTML = existingText + slText + targetText;
        }
      }
    });
    
    const payload = {
      part: splitCurrentEdit.part,
      qty: splitCurrentEdit.qty,
      avg: avg,
      stopPrice: stopPrice ? parseFloat(stopPrice.toFixed(2)) : null,
      stopPct: stopPct ? parseFloat(stopPct.toFixed(2)) : null,
      targetPrice: targetPrice ? parseFloat(targetPrice.toFixed(2)) : null,
      targetPct: targetPct ? parseFloat(targetPct.toFixed(2)) : null
    };
    
    console.log('Split part updated:', payload);
    
    // Show success message
    showToast('Split values updated successfully!', 'success');
    
    overlay.style.display = 'none';
  });
  
  document.getElementById('splitCancelBtn').addEventListener('click', () => {
    overlay.style.display = 'none';
  });
  
  overlay.addEventListener('click', (e) => {
    if (e.target === overlay) overlay.style.display = 'none';
  });
  
  document.addEventListener('click', (e) => {
    if (e.target.classList.contains('split-preview-item')) {
      const part = parseInt(e.target.dataset.part);
      const qty = parseInt(e.target.dataset.qty);
      console.log({ part, qty });
      
      splitCurrentEdit = { part, qty };
      document.getElementById('editPart').textContent = part;
      document.getElementById('editQty').textContent = qty;
      document.getElementById('editAvgPrice').value = document.getElementById('inpAvgPrice').value;
      document.getElementById('editQuantity').value = qty;
      
      document.getElementById('stopInput').value = '';
      document.getElementById('targetInput').value = '';
      setSplitToggleMode('stop', 'pct');
      setSplitToggleMode('target', 'pct');
      
      overlay.style.display = 'block';
      updateSplitCalculations();
    }
  });
}



// Toggle button visibility
function toggleButtons(saved) {
  document.getElementById('resetSplitBtn').style.display = saved ? 'none' : 'inline-block';
  document.getElementById('deleteTemplateBtn').style.display = saved ? 'inline-block' : 'none';
}

// Load templates on page load
async function loadTemplates() {
  const instrument = tradeData.commentSymbol || tradeData.symbol || 'UNKNOWN';
  const strike = null;
  
  console.log('Loading templates for instrument:', instrument, 'strike:', strike);
  
  try {
    const url = `/api/templates?instrument=${encodeURIComponent(instrument)}&t=${Date.now()}`;
    console.log('Loading from URL:', url);
    
    const response = await fetch(url);
    if (!response.ok) {
      console.error('Load failed', response.status);
      toggleButtons(false);
      return;
    }
    
    const templates = await response.json();
    console.log('Loaded templates:', templates);
    
    if (templates.length > 0) {
      const template = templates[0]; // Get latest
      window.currentTemplateId = template.id;
      
      // Restore the template data
      const payload = template.payload;
      if (payload.split_mode) {
        currentSplitMode = payload.split_mode;
        document.getElementById('splitMode').value = payload.split_mode;
      }
      if (payload.split_parts) {
        splitParts = payload.split_parts;
      }
      
      // Update the split preview
      updateSplitPreview();
      
      // Restore table data if available
      if (payload.table_data && payload.table_data.length > 0) {
        const splitTableBody = document.getElementById('splitTableBody');
        if (splitTableBody) {
          splitTableBody.innerHTML = payload.table_data.map(row => `
            <tr>
              <td>${row.preview}</td>
              <td>${row.sl}</td>
              <td>${row.target}</td>
              <td>${row.qty}</td>
              <td><button class="split-action-btn" onclick="editSplitPart(${row.qty}, ${row.qty})">Edit</button></td>
            </tr>
          `).join('');
          
          document.getElementById('appliedSplitTable').classList.remove('hidden');
        }
      }
      
      toggleButtons(true);
      console.log('Template loaded:', template.id);
    } else {
      toggleButtons(false);
    }
  } catch (error) {
    console.error('Error loading templates:', error);
    toggleButtons(false);
  }
}

/* ---------- Init ---------- */
(async function init(){
  // Start in AI mode by default
  modeSelect.value = 'ai';
  modeSelect.dispatchEvent(new Event('change'));
  
  await loadPivotsForComment();
  
  // Initialize advanced risk calculator
  initRiskCalculator();
  initTooltips();
  
  // Setup live sync between AI and unified cards
  setupLiveSync();
  
  // Initialize split editor
  initSplitEditor();
  
  // Initialize split preview functionality
  if (typeof initSplitPreview === 'function') {
    initSplitPreview();
  }
  
  // Initialize split preview
  updateSplitPreview();
  
  // Load existing templates
  await loadTemplates();
  
  // Check if position is closed and disable inputs
  if (tradeData.status === 'closed') {
    const inputs = document.querySelectorAll('input, button, select');
    inputs.forEach(input => {
      if (input.id !== 'backToManual' && input.id !== 'closeBtn') {
        input.disabled = true;
        input.style.opacity = '0.5';
      }
    });
    
    // Update close button for reopening
    const closeBtn = document.getElementById('closeBtn');
    closeBtn.textContent = 'Reopen Position';
    closeBtn.className = 'btn-ai';
  }
})();
</script>

<!-- Include Journal Integration Component -->
{% include 'calculator_journal_integration.html' %}

<script>
// Export current trade to journal function
function exportCurrentTradeToJournal() {
  const tradeData = {
    symbol: tradeData.symbol,
    avg_price: parseFloat(document.getElementById('inpAvgPrice').value),
    target_price: parseFloat(document.getElementById('inpTarget').value),
    stop_loss_price: parseFloat(document.getElementById('inpSL').value),
    quantity: parseInt(document.getElementById('inpQty').value),
    trade_type: tradeData.tradeType,
    calculator_type: 'intraday',
    total_risk: tradeData.total_risk,
    total_reward: tradeData.total_reward,
    capital_used: tradeData.capital_used,
    rr_ratio: tradeData.rr_ratio,
    expected_return: tradeData.expected_return,
    risk_percent: tradeData.risk_percent
  };
  
  showJournalIntegration(tradeData);
}
</script>

</body>
</html>