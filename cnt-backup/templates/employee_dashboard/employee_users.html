{% extends "employee_dashboard/employee_base.html" %}

{% block title %}Manage Users | CalculatenTrade{% endblock %}

{% block content %}
<div class="">
    <div class="page-title">
        <div class="title_left">
            <h3>Manage Users</h3>
        </div>
    </div>

    <div class="clearfix"></div>

    <div class="row">
        <div class="col-md-12">
            <div class="x_panel">
                <div class="x_title">
                    <h2>Search Users</h2>
                    <div class="clearfix"></div>
                </div>
                <div class="x_content">
                    <form method="GET" class="form-horizontal form-label-left">
                        <div class="form-group row">
                            <div class="col-md-9 col-sm-9">
                                <div class="input-group">
                                    <input type="text" name="q" value="{{ search }}" class="form-control" placeholder="Search users by email...">
                                    <span class="input-group-btn">
                                        <button type="submit" class="btn btn-primary">Search</button>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-12">
            <div class="x_panel">
                <div class="x_title">
                    <h2>Users <small>({{ users.total if users else 0 }})</small></h2>
                    <div class="clearfix"></div>
                </div>
                <div class="x_content">
                    {% if users and users.items %}
                    <div class="table-responsive">
                        <table class="table table-striped jambo_table bulk_action">
                            <thead>
                                <tr class="headings">
                                    <th class="column-title">Email</th>
                                    <th class="column-title">Status</th>
                                    <th class="column-title">Registered On</th>
                                    <th class="column-title">Coupon</th>
                                    <th class="column-title no-link last"><span class="nobr">Actions</span></th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for user in users.items %}
                                <tr class="even pointer" id="user-{{ user.id }}">
                                    <td>{{ user.email }}</td>
                                    <td>
                                        <span class="badge {% if user.verified %}badge-success{% else %}badge-danger{% endif %}">
                                            {{ 'Active' if user.verified else 'Inactive' }}
                                        </span>
                                    </td>
                                    <td>{{ user.registered_on.strftime('%Y-%m-%d') if user.registered_on else 'N/A' }}</td>
                                    <td>{{ user.coupon_code if user.coupon_code else 'N/A' }}</td>
                                    <td>
                                        <a href="{{ url_for('employee_dashboard.user_detail', user_id=user.id) }}" 
                                           class="btn btn-info btn-xs">View</a>
                                        <button onclick="toggleUser({{ user.id }}, {{ user.verified|lower }})" 
                                                class="btn {% if user.verified %}btn-danger{% else %}btn-success{% endif %} btn-xs"
                                                id="toggle-btn-{{ user.id }}">
                                            {{ 'Deactivate' if user.verified else 'Activate' }}
                                        </button>
                                        <button onclick="disableLogin({{ user.id }})" 
                                                class="btn btn-warning btn-xs">
                                            Disable Login
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% endif %}

                    <!-- Pagination -->
                    {% if users.pages > 1 %}
                    <div class="row">
                        <div class="col-md-12">
                            <div class="text-center">
                                <ul class="pagination">
                                    {% if users.has_prev %}
                                    <li><a href="{{ url_for('employee_dashboard.users_list', page=users.prev_num, q=search) }}">«</a></li>
                                    {% else %}
                                    <li class="disabled"><a href="#">«</a></li>
                                    {% endif %}
                                    
                                    {% for page_num in users.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
                                        {% if page_num %}
                                            {% if page_num == users.page %}
                                            <li class="active"><a href="#">{{ page_num }}</a></li>
                                            {% else %}
                                            <li><a href="{{ url_for('employee_dashboard.users_list', page=page_num, q=search) }}">{{ page_num }}</a></li>
                                            {% endif %}
                                        {% else %}
                                            <li class="disabled"><a href="#">...</a></li>
                                        {% endif %}
                                    {% endfor %}
                                    
                                    {% if users.has_next %}
                                    <li><a href="{{ url_for('employee_dashboard.users_list', page=users.next_num, q=search) }}">»</a></li>
                                    {% else %}
                                    <li class="disabled"><a href="#">»</a></li>
                                    {% endif %}
                                </ul>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript for user actions -->
<script>
function toggleUser(userId, isVerified) {
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    const action = isVerified ? 'deactivate' : 'activate';
    
    fetch(`/employee/user/${userId}/${action}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update button text and class
            const btn = document.getElementById(`toggle-btn-${userId}`);
            if (isVerified) {
                btn.textContent = 'Activate';
                btn.classList.remove('btn-danger');
                btn.classList.add('btn-success');
            } else {
                btn.textContent = 'Deactivate';
                btn.classList.remove('btn-success');
                btn.classList.add('btn-danger');
            }
            
            // Update status badge
            const statusBadge = document.querySelector(`#user-${userId} td:nth-child(2) .badge`);
            if (isVerified) {
                statusBadge.textContent = 'Inactive';
                statusBadge.classList.remove('badge-success');
                statusBadge.classList.add('badge-danger');
            } else {
                statusBadge.textContent = 'Active';
                statusBadge.classList.remove('badge-danger');
                statusBadge.classList.add('badge-success');
            }
            
            // Update onclick handler
            btn.setAttribute('onclick', `toggleUser(${userId}, ${!isVerified})`);
            
            // Show notification
            new PNotify({
                title: 'Success',
                text: data.message,
                type: 'success',
                styling: 'bootstrap3'
            });
        } else {
            new PNotify({
                title: 'Error',
                text: data.message || 'An error occurred',
                type: 'error',
                styling: 'bootstrap3'
            });
        }
    })
    .catch(error => {
        console.error('Error:', error);
        new PNotify({
            title: 'Error',
            text: 'An unexpected error occurred',
            type: 'error',
            styling: 'bootstrap3'
        });
    });
}

function disableLogin(userId) {
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    
    fetch(`/employee/user/${userId}/disable_login`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            new PNotify({
                title: 'Success',
                text: data.message,
                type: 'success',
                styling: 'bootstrap3'
            });
        } else {
            new PNotify({
                title: 'Error',
                text: data.message || 'An error occurred',
                type: 'error',
                styling: 'bootstrap3'
            });
        }
    })
    .catch(error => {
        console.error('Error:', error);
        new PNotify({
            title: 'Error',
            text: 'An unexpected error occurred',
            type: 'error',
            styling: 'bootstrap3'
        });
    });
}
</script>
{% endblock %}
                
                if (data.success) {
                    // Update UI optimistically
                    const userRow = document.getElementById(`user-${userId}`);
                    const statusBadge = userRow.querySelector('.inline-flex.items-center.px-2\\.5');
                    const toggleBtn = document.getElementById(`toggle-btn-${userId}`);
                    
                    if (data.is_active) {
                        statusBadge.className = 'ml-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800';
                        statusBadge.textContent = 'Active';
                        toggleBtn.textContent = 'Deactivate';
                        toggleBtn.className = 'inline-flex items-center px-3 py-1 border border-transparent text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700';
                    } else {
                        statusBadge.className = 'ml-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800';
                        statusBadge.textContent = 'Inactive';
                        toggleBtn.textContent = 'Activate';
                        toggleBtn.className = 'inline-flex items-center px-3 py-1 border border-transparent text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700';
                    }
                    
                    showNotification(data.message, 'success');
                } else {
                    showNotification(data.error || 'Failed to update user', 'error');
                }
            } catch (error) {
                showNotification('Network error occurred', 'error');
            }
        }

        async function disableLogin(userId) {
            if (!confirm('Are you sure you want to disable login for this user?')) {
                return;
            }
            
            try {
                const response = await fetch(`/employee/api/user/${userId}/disable-login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('meta[name=csrf-token]').getAttribute('content')
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification(data.message, 'success');
                    // Optionally refresh the page or update UI
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showNotification(data.error || 'Failed to disable login', 'error');
                }
            } catch (error) {
                showNotification('Network error occurred', 'error');
            }
        }
    </script>
</body>
</html>