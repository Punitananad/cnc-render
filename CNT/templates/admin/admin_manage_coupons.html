{% extends "admin/admin_base.html" %}

{% block title %}Manage Coupons | CalculatenTrade{% endblock %}

{% block content %}
<div class="">
  <div class="page-title">
    <div class="title_left">
      <h3>ðŸŽ« Manage Coupons</h3>
    </div>
    <div class="title_right">
      <div class="pull-right">
        <a href="{{ url_for('admin.admin_create_coupon') }}" class="btn btn-success">
          <i class="fa fa-plus"></i> Create New Coupon
        </a>
      </div>
    </div>
  </div>

  <div class="clearfix"></div>

  {% with messages = get_flashed_messages() %}
    {% if messages %}
      {% for message in messages %}
        <div class="alert alert-success alert-dismissible" role="alert">
          <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">Ã—</span></button>
          {{ message }}
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <div class="row">
    <div class="col-md-12">
      <div class="x_panel">
        <div class="x_title">
          <h2>All Coupons</h2>
          <div class="clearfix"></div>
        </div>
        <div class="x_content">
          <div class="row">
            <div class="col-sm-6">
              <div class="form-group">
                <input type="text" id="searchInput" class="form-control" placeholder="Search coupons by code..." onkeyup="searchCoupons()">
              </div>
            </div>
          </div>
          <div class="table-responsive">
            <table class="table table-striped jambo_table bulk_action" id="couponsTable">
              <thead>
                <tr class="headings">
                  <th class="column-title">Coupon Code</th>
                  <th class="column-title">Discount %</th>
                  <th class="column-title">Status</th>
                  <th class="column-title">Created By</th>
                  <th class="column-title">Created Date</th>
                  <th class="column-title no-link last">Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for coupon in coupons %}
                <tr class="even pointer">
                  <td><strong>{{ coupon.code }}</strong></td>
                  <td>{{ coupon.discount_percent }}%</td>
                  <td>
                    <span class="badge {{ 'bg-success' if coupon.active else 'bg-danger' }}">
                      {{ 'ACTIVE' if coupon.active else 'INACTIVE' }}
                    </span>
                  </td>
                  <td>{{ coupon.created_by }}</td>
                  <td>{{ coupon.created_at.strftime('%Y-%m-%d %H:%M') if coupon.created_at else 'N/A' }}</td>
                  <td>
                    <form method="POST" action="{{ url_for('admin.admin_toggle_coupon', coupon_id=coupon.id) }}" style="display: inline;">
                      <button type="submit" class="btn btn-sm {{ 'btn-danger' if coupon.active else 'btn-success' }}">
                        <i class="fa {{ 'fa-toggle-off' if coupon.active else 'fa-toggle-on' }}"></i>
                        {{ 'Deactivate' if coupon.active else 'Activate' }}
                      </button>
                    </form>
                  </td>
                </tr>
                {% else %}
                <tr>
                  <td colspan="6" class="text-center text-muted py-4">
                    No coupons created yet. <a href="{{ url_for('admin.admin_create_coupon') }}">Create your first coupon</a>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  function searchCoupons() {
    const input = document.getElementById('searchInput');
    const filter = input.value.toLowerCase();
    const table = document.getElementById('couponsTable');
    const rows = table.getElementsByTagName('tr');

    for (let i = 1; i < rows.length; i++) {
      const cells = rows[i].getElementsByTagName('td');
      let found = false;
      
      for (let j = 0; j < cells.length - 1; j++) {
        if (cells[j].textContent.toLowerCase().includes(filter)) {
          found = true;
          break;
        }
      }
      
      rows[i].style.display = found ? '' : 'none';
    }
  }
</script>
{% endblock %}