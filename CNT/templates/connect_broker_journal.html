<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Multi-Broker Connect — Connect Broker</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root {
      --bg: #f7fafc; --card: #fff; --muted: #6b7280; --accent: #0ea5a4; --danger: #dc2626;
      --code-bg: #0f172a; --code-color: #e6eef8;
    }
    body { font-family: Inter, Arial, sans-serif; margin: 18px; background: var(--bg); color: #111827; }
    .card { background: var(--card); border-radius: 10px; padding: 16px; box-shadow: 0 2px 6px rgba(15,23,42,0.06); margin-bottom: 16px; }
    .btn-primary { background: var(--accent); border-color: var(--accent); }
    .btn-primary:hover { background: #0d9488; border-color: #0d9488; }
    pre { background: var(--code-bg); color: var(--code-color); padding: 12px; border-radius: 8px; overflow: auto; max-height: 360px; white-space: pre-wrap; }
    .status-badge { display: inline-block; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 500; }
    .status-connected { background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
    .status-disconnected { background: #f3f4f6; color: #374151; border: 1px solid #d1d5db; }
    .alert { padding: 12px; border-radius: 8px; margin: 10px 0; }
    .alert-success { background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
    .alert-danger { background: #fef2f2; color: #dc2626; border: 1px solid #fecaca; }
    .alert-warning { background: #fef3c7; color: #d97706; border: 1px solid #fde68a; }
    .alert-info { background: #dbeafe; color: #2563eb; border: 1px solid #bfdbfe; }
  </style>
</head>
<body>
  <div class="container-fluid">
    <h1 class="mb-4">Multi-Broker Connect</h1>

    <!-- Broker Selection -->
    <div class="card">
      <div class="row align-items-center">
        <div class="col-md-3">
          <label for="broker" class="form-label"><strong>Select Broker</strong></label>
          <select id="broker" class="form-select">
            <option value="kite">Kite (Zerodha)</option>
            <option value="dhan">Dhan</option>
            <option value="angel">Angel One (SmartAPI)</option>
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label">Remembered Accounts</label>
          <select id="remembered_accounts" class="form-select">
            <option value="">— select saved account —</option>
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label">&nbsp;</label>
          <button class="btn btn-outline-secondary d-block" onclick="clearRemembered()">Clear All</button>
        </div>
        <div class="col-md-3">
          <div id="connection_status" class="mt-2">
            <span class="status-badge status-disconnected">Not Connected</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Credentials Registration -->
    <div class="card">
      <h3>Register / Save Credentials</h3>
      <div id="kite_fields" class="row g-3">
        <div class="col-md-4">
          <input id="kite_api_key" class="form-control" placeholder="API Key" value="your_kite_api_key" />
        </div>
        <div class="col-md-4">
          <input id="kite_api_secret" class="form-control" placeholder="API Secret" value="your_kite_api_secret" />
        </div>
      </div>
      <div id="dhan_fields" class="row g-3" style="display:none;">
        <div class="col-md-4">
          <input id="dhan_client_id" class="form-control" placeholder="Client ID" />
        </div>
        <div class="col-md-4">
          <input id="dhan_access_token" class="form-control" placeholder="Access Token" />
        </div>
      </div>
      <div id="angel_fields" class="row g-3" style="display:none;">
        <div class="col-md-4">
          <input id="angel_api_key" class="form-control" placeholder="API Key" />
        </div>
        <div class="col-md-4">
          <input id="angel_api_secret" class="form-control" placeholder="API Secret" />
        </div>
      </div>
      <div class="mt-3">
        <button class="btn btn-primary" onclick="register()">Register Credentials</button>
        <span id="register_msg" class="ms-3 text-muted"></span>
      </div>
    </div>

    <!-- Login/Connect -->
    <div class="card">
      <h3>Login / Connect</h3>
      <div class="row align-items-end g-3">
        <div class="col-md-3">
          <label for="login_user_id" class="form-label">User ID</label>
          <input id="login_user_id" class="form-control" placeholder="User ID" value="NES881" />
        </div>
        <div class="col-md-9">
          <button class="btn btn-success me-2" onclick="login()">
            <i class="bi bi-box-arrow-in-right"></i> Connect to Broker
          </button>
          <button class="btn btn-info me-2" onclick="checkStatus()">
            <i class="bi bi-arrow-clockwise"></i> Check Status
          </button>
          <button class="btn btn-warning" onclick="disconnect()">
            <i class="bi bi-box-arrow-right"></i> Disconnect
          </button>
        </div>
      </div>
    </div>

    <!-- Data Controls (Hidden by default) -->
    <div class="card" id="data_controls" style="display:none">
      <h3>Broker Data</h3>
      <div class="row g-2">
        <div class="col-auto">
          <button class="btn btn-primary" onclick="fetchBrokerData('orders')">
            <i class="bi bi-list-ul"></i> Fetch Orders
          </button>
        </div>
        <div class="col-auto">
          <button class="btn btn-primary" onclick="fetchBrokerData('trades')">
            <i class="bi bi-graph-up"></i> Fetch Trades
          </button>
        </div>
        <div class="col-auto">
          <button class="btn btn-primary" onclick="fetchBrokerData('positions')">
            <i class="bi bi-pie-chart"></i> Fetch Positions
          </button>
        </div>
        <div class="col-auto">
          <button class="btn btn-secondary" onclick="fetchPortfolio()">
            <i class="bi bi-briefcase"></i> Portfolio
          </button>
        </div>
      </div>
    </div>

    <!-- Output -->
    <div class="card">
      <h3>Output</h3>
      <div id="message_area"></div>
      <pre id="out" class="mt-2">Ready. Select broker and enter credentials to begin.</pre>
    </div>
  </div>

  <script>
    // URL Configuration
    const URLS = {
      register_base: "{{ url_for('calculatentrade.register_app_broker', broker='__BR__') }}",
      broker_status: "{{ url_for('calculatentrade.broker_status') }}",
      disconnect: "{{ url_for('calculatentrade.disconnect_broker') }}",
      portfolio: "{{ url_for('calculatentrade.get_portfolio') }}",
      api_orders: "{{ url_for('calculatentrade.api_broker_orders') }}",
      api_trades: "{{ url_for('calculatentrade.api_broker_trades') }}",
      api_positions: "{{ url_for('calculatentrade.api_broker_positions') }}",
      trades_page: "{{ url_for('calculatentrade.get_trades') }}"
    };

    // Global Variables
    let broker = 'kite';
    const out = document.getElementById('out');
    const messageArea = document.getElementById('message_area');

    // UI Helper Functions
    function showMessage(msg, type = 'info') {
      const alertClass = type === 'error' ? 'alert-danger' : 
                        type === 'success' ? 'alert-success' : 
                        type === 'warning' ? 'alert-warning' : 'alert-info';
      
      messageArea.innerHTML = `<div class="alert ${alertClass}">${msg}</div>`;
      out.textContent = msg;
    }

    function markConnected(brokerName, userId) {
      const statusEl = document.getElementById('connection_status');
      statusEl.innerHTML = `<span class="status-badge status-connected">Connected: ${brokerName.toUpperCase()} (${userId})</span>`;
    }

    function markDisconnected() {
      const statusEl = document.getElementById('connection_status');
      statusEl.innerHTML = `<span class="status-badge status-disconnected">Not Connected</span>`;
      hideDataControls();
    }

    function showDataControls() {
      document.getElementById('data_controls').style.display = 'block';
    }

    function hideDataControls() {
      document.getElementById('data_controls').style.display = 'none';
    }

    // Broker Management Functions
    function onBrokerChange() {
      broker = document.getElementById('broker').value;
      
      // Toggle credential fields
      document.getElementById('kite_fields').style.display = broker === 'kite' ? 'block' : 'none';
      document.getElementById('dhan_fields').style.display = broker === 'dhan' ? 'block' : 'none';
      document.getElementById('angel_fields').style.display = broker === 'angel' ? 'block' : 'none';
      
      showMessage(`Selected ${broker.toUpperCase()} broker`, 'info');
    }

    // Load saved connections
    async function loadSaved() {
      try {
        const res = await fetch('/calculatentrade_journal/api/broker/remembered_accounts', {
          credentials: 'include'
        });
        const data = await res.json();
        
        if (data.ok && data.accounts) {
          const select = document.getElementById('remembered_accounts');
          select.innerHTML = '<option value="">— select saved account —</option>';
          
          data.accounts.forEach(acc => {
            const option = document.createElement('option');
            option.value = `${acc.broker}||${acc.user_id}`;
            option.textContent = `${acc.broker.toUpperCase()} — ${acc.user_id}`;
            select.appendChild(option);
          });
          
          if (data.accounts.length > 0) {
            showMessage(`Found ${data.accounts.length} saved account(s)`, 'success');
          }
        }
        
        // Check localStorage for current broker
        const uid = document.getElementById('login_user_id').value || 'user1';
        const storageKey = `broker_${broker}_${uid}`;
        const stored = localStorage.getItem(storageKey);
        
        if (stored) {
          try {
            const data = JSON.parse(stored);
            if (data.connected) {
              await checkStatus();
            }
          } catch (e) {
            localStorage.removeItem(storageKey);
          }
        }
      } catch (e) {
        console.error('Load saved error:', e);
        showMessage('Could not load saved accounts', 'warning');
      }
    }

    // Register credentials
    async function register() {
      const payload = { user_id: document.getElementById('login_user_id').value || 'NES881' };
      
      if (broker === 'kite') {
        const apiKey = document.getElementById('kite_api_key').value.trim();
        const apiSecret = document.getElementById('kite_api_secret').value.trim();
        
        if (!apiKey || !apiSecret || apiKey === 'your_kite_api_key' || apiSecret === 'your_kite_api_secret') {
          showMessage('Please enter valid Kite API key and secret', 'error');
          return false;
        }
        
        payload.api_key = apiKey;
        payload.api_secret = apiSecret;
      } else if (broker === 'dhan') {
        payload.client_id = document.getElementById('dhan_client_id').value.trim() || 'demo_client';
        payload.access_token = document.getElementById('dhan_access_token').value.trim() || 'demo_token';
      } else {
        payload.api_key = document.getElementById('angel_api_key').value.trim() || 'demo_key';
        payload.api_secret = document.getElementById('angel_api_secret').value.trim() || 'demo_secret';
      }

      try {
        const url = URLS.register_base.replace('__BR__', broker);
        const res = await fetch(url, { 
          method: 'POST', 
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(payload) 
        });
        
        const result = await res.json();
        
        if (res.ok && result.ok) {
          document.getElementById('register_msg').textContent = 'Registered successfully!';
          showMessage('Credentials registered and saved successfully', 'success');
          return true;
        } else {
          throw new Error(result.message || `Registration failed: ${res.status}`);
        }
      } catch (e) {
        showMessage('Registration error: ' + e.message, 'error');
        document.getElementById('register_msg').textContent = 'Registration failed!';
        return false;
      }
    }

    // Login/Connect
    async function login() {
      const uid = document.getElementById('login_user_id').value.trim() || 'NES881';
      document.getElementById('login_user_id').value = uid;
      
      showMessage('Preparing to connect to broker...', 'info');
      
      try {
        // Check if credentials are already registered
        const statusRes = await fetch(`/calculatentrade_journal/api/broker/status?broker=${broker}&user_id=${uid}`, {
          credentials: 'include'
        });
        const statusData = await statusRes.json();
        
        if (statusData.connected) {
          showMessage(`${broker.toUpperCase()} is already connected for user ${uid}`, 'success');
          markConnected(broker, uid);
          showDataControls();
          return;
        }
        
        // Register credentials first
        const registered = await register();
        if (!registered) {
          showMessage('Please register valid credentials first', 'error');
          return;
        }
        
        if (broker === 'kite') {
          // For Kite, redirect to actual login URL
          showMessage('Redirecting to Kite login... Please complete the authentication process.', 'info');
          window.location.href = `/calculatentrade_journal/kite/login?user_id=${encodeURIComponent(uid)}`;
          return;
        }
        
        if (broker === 'dhan') {
          // For Dhan, redirect to login URL
          showMessage('Redirecting to Dhan login...', 'info');
          window.location.href = `/calculatentrade_journal/dhan/login?user_id=${encodeURIComponent(uid)}`;
          return;
        }
        
        if (broker === 'angel') {
          // For Angel, redirect to login URL
          showMessage('Redirecting to Angel login...', 'info');
          window.location.href = `/calculatentrade_journal/angel/login?user_id=${encodeURIComponent(uid)}`;
          return;
        }
        
      } catch (e) {
        showMessage('Connection error: ' + e.message, 'error');
      }
    }

    // Check connection status
    async function checkStatus() {
      const uid = document.getElementById('login_user_id').value.trim() || 'NES881';
      
      try {
        const res = await fetch(`/calculatentrade_journal/api/broker/status?broker=${broker}&user_id=${uid}`, {
          credentials: 'include'
        });
        const data = await res.json();
        
        if (data.connected) {
          markConnected(broker, uid);
          showDataControls();
          
          // Update localStorage
          const storageKey = `broker_${broker}_${uid}`;
          localStorage.setItem(storageKey, JSON.stringify({
            connected: true,
            broker: broker,
            user_id: uid,
            connected_at: new Date().toISOString()
          }));
          
          const statusMsg = data.message || 'Connected';
          showMessage(`${broker.toUpperCase()} is connected for user ${uid} (${statusMsg})`, 'success');
        } else {
          markDisconnected();
          localStorage.removeItem(`broker_${broker}_${uid}`);
          const statusMsg = data.message || 'Not connected';
          showMessage(`${broker.toUpperCase()}: ${statusMsg}`, 'warning');
          
          // If expired, suggest reconnection
          if (data.expired) {
            showMessage(`${broker.toUpperCase()} connection expired. Please reconnect.`, 'warning');
          }
        }
      } catch (e) {
        showMessage('Status check error: ' + e.message, 'error');
        markDisconnected();
      }
    }

    // Disconnect
    async function disconnect() {
      if (!confirm('Are you sure you want to disconnect from the broker?')) return;
      
      const uid = document.getElementById('login_user_id').value.trim() || 'NES881';
      
      try {
        const res = await fetch('/calculatentrade_journal/api/broker/disconnect', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ broker, user_id: uid })
        });
        
        const result = await res.json();
        
        if (result.ok) {
          markDisconnected();
          localStorage.removeItem(`broker_${broker}_${uid}`);
          showMessage('Disconnected successfully (credentials preserved for reconnection)', 'success');
          await loadSaved(); // Refresh remembered accounts
        } else {
          showMessage('Disconnect failed: ' + (result.message || 'Unknown error'), 'error');
        }
      } catch (e) {
        showMessage('Disconnect error: ' + e.message, 'error');
      }
    }

    // Data fetching functions
    async function fetchBrokerData(kind) {
      const uid = document.getElementById('login_user_id').value.trim() || 'NES881';
      showMessage(`Fetching ${kind}...`, 'info');
      
      try {
        const urlMap = {
          'orders': URLS.api_orders,
          'trades': URLS.api_trades,
          'positions': URLS.api_positions
        };
        
        const url = urlMap[kind] + `?broker=${broker}&user_id=${uid}`;
        const res = await fetch(url, { credentials: 'include' });
        const data = await res.json();
        
        if (data.ok && data.data) {
          out.textContent = JSON.stringify(data.data, null, 2);
          showMessage(`${kind} data loaded successfully (${data.data.length || 0} items)`, 'success');
        } else {
          out.textContent = JSON.stringify(data, null, 2);
          
          // Handle authentication errors
          if (data.auth_error) {
            markDisconnected();
            showMessage(`Authentication failed. ${data.message}`, 'error');
          } else {
            showMessage(data.message || `${kind} response received`, 'info');
          }
        }
      } catch (e) {
        showMessage(`Error fetching ${kind}: ` + e.message, 'error');
      }
    }
    
    async function fetchPortfolio() {
      const uid = document.getElementById('login_user_id').value.trim() || 'NES881';
      showMessage('Fetching portfolio...', 'info');
      
      try {
        const url = URLS.portfolio + `?broker=${broker}&user_id=${uid}`;
        const res = await fetch(url, { credentials: 'include' });
        const data = await res.json();
        
        if (data.ok && data.data) {
          out.textContent = JSON.stringify(data.data, null, 2);
          showMessage('Portfolio data loaded successfully', 'success');
        } else {
          out.textContent = JSON.stringify(data, null, 2);
          
          // Handle authentication errors
          if (data.auth_error) {
            markDisconnected();
            showMessage(`Authentication failed. ${data.message}`, 'error');
          } else {
            showMessage(data.message || 'Portfolio response received', 'info');
          }
        }
      } catch (e) {
        showMessage('Portfolio error: ' + e.message, 'error');
      }
    }
    
    // Remembered accounts management
    function onRememberedSelect() {
      const select = document.getElementById('remembered_accounts');
      if (!select.value) return;
      
      const [selectedBroker, selectedUserId] = select.value.split('||');
      document.getElementById('broker').value = selectedBroker;
      broker = selectedBroker;
      onBrokerChange();
      document.getElementById('login_user_id').value = selectedUserId;
      
      showMessage(`Selected saved account: ${selectedBroker.toUpperCase()} (${selectedUserId})`, 'info');
      checkStatus();
    }
    
    function clearRemembered() {
      if (!confirm('Clear all remembered accounts? This cannot be undone.')) return;
      
      // Clear localStorage
      const keys = Object.keys(localStorage);
      keys.forEach(key => {
        if (key.startsWith('broker_')) {
          localStorage.removeItem(key);
        }
      });
      
      // Clear server-side
      fetch('/calculatentrade_journal/api/broker/disconnect', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ clear_all: true })
      });
      
      document.getElementById('remembered_accounts').innerHTML = '<option value="">— select saved account —</option>';
      showMessage('All remembered accounts cleared', 'success');
    }

    // Initialize broker system
    async function initBrokerSystem() {
      try {
        const res = await fetch('/calculatentrade_journal/api/broker/init', {
          method: 'POST',
          credentials: 'include'
        });
        const data = await res.json();
        
        if (data.ok) {
          console.log('Broker system initialized:', data);
          showMessage(`Broker system ready. Loaded ${data.accounts_loaded} accounts, ${data.active_sessions} active sessions.`, 'success');
        } else {
          console.warn('Broker init failed:', data);
          showMessage('Broker system initialization failed', 'warning');
        }
      } catch (e) {
        console.error('Broker init error:', e);
        showMessage('Could not initialize broker system', 'warning');
      }
    }

    // Initialize page
    async function init() {
      // Set up event listeners
      document.getElementById('broker').addEventListener('change', onBrokerChange);
      document.getElementById('remembered_accounts').addEventListener('change', onRememberedSelect);
      
      // Initialize broker system first
      await initBrokerSystem();
      
      // Handle URL parameters
      const params = new URLSearchParams(location.search);
      const brokerParam = params.get('broker');
      const userIdParam = params.get('user_id');
      
      if (brokerParam) {
        document.getElementById('broker').value = brokerParam;
        broker = brokerParam;
      }
      
      if (userIdParam) {
        document.getElementById('login_user_id').value = userIdParam;
      }
      
      // Initialize UI
      onBrokerChange();
      await loadSaved();
      
      // Auto-check status for current broker/user
      const uid = document.getElementById('login_user_id').value.trim();
      if (uid) {
        await checkStatus();
      }
      
      showMessage('Multi-Broker Connect ready. Select broker and enter credentials.', 'info');
    }

    // Start when DOM is ready
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>